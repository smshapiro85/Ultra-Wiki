---
phase: 05-article-editing
plan: 08
type: execute
wave: 2
depends_on: ["05-06"]
files_modified:
  - src/lib/db/schema.ts
  - src/app/layout.tsx
  - src/components/common/theme-provider.tsx
  - src/app/(wiki)/profile/page.tsx
  - src/app/(wiki)/profile/actions.ts
  - src/app/(wiki)/profile/profile-form.tsx
  - src/components/editor/article-editor.tsx
  - src/app/(wiki)/layout.tsx
  - src/components/wiki/app-sidebar.tsx
  - src/components/common/user-menu.tsx
  - src/app/(admin)/layout.tsx
  - src/components/admin/admin-nav.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can toggle between auto (system), light, and dark mode from their profile page"
    - "Theme preference persists in the users table (survives logout/login)"
    - "Theme applies app-wide via next-themes ThemeProvider in root layout"
    - "BlockNote editor respects the current theme (light/dark)"
    - "The html element has class='dark' when dark mode is active"
    - "User avatar icon appears in the top-right header bar next to the search input"
    - "Clicking the avatar shows a dropdown with user name, Account Settings link, and Log Out"
    - "A settings cog icon appears next to the avatar only for admin users and links to /admin/settings"
    - "The sidebar footer no longer contains the user menu"
    - "Admin layout uses the same SidebarProvider + AppSidebar + SidebarInset pattern as the wiki layout"
    - "Admin layout sidebar defaults to collapsed (icon mode) via defaultOpen={false}"
    - "Admin layout header inside SidebarInset matches the wiki header: SidebarTrigger, Admin badge, spacer, settings cog, user avatar"
    - "Admin layout header no longer has 'Back to Wiki' or 'Sign Out' text links"
    - "Admin layout header no longer has inline Settings/Sync/Users/Review Queue nav links"
    - "Admin pages have a tab group (matching article-tabs style) below the header for section navigation: Settings, Sync, Users, Review Queue"
  artifacts:
    - path: "src/components/common/theme-provider.tsx"
      provides: "Client-side ThemeProvider wrapper using next-themes"
    - path: "src/app/layout.tsx"
      provides: "Root layout with ThemeProvider wrapping children"
    - path: "src/lib/db/schema.ts"
      provides: "themePreference column on users table"
    - path: "src/app/(wiki)/profile/profile-form.tsx"
      provides: "Theme toggle control in profile form"
    - path: "src/app/(wiki)/layout.tsx"
      provides: "Updated wiki header with user avatar and admin settings cog"
    - path: "src/components/wiki/app-sidebar.tsx"
      provides: "Sidebar with UserMenu removed from footer"
    - path: "src/components/common/user-menu.tsx"
      provides: "Updated UserMenu: avatar-only trigger, Account Settings link, no inline admin link"
    - path: "src/app/(admin)/layout.tsx"
      provides: "Admin layout using SidebarProvider + AppSidebar + SidebarInset (sidebar collapsed by default), unified header, no Back/Sign Out links"
    - path: "src/components/admin/admin-nav.tsx"
      provides: "Client component with route-based tab navigation for admin sections (Settings, Sync, Users, Review Queue)"
  key_links:
    - from: "src/app/layout.tsx"
      to: "src/components/common/theme-provider.tsx"
      via: "ThemeProvider wrapping children"
      pattern: "ThemeProvider"
    - from: "src/app/(wiki)/profile/profile-form.tsx"
      to: "next-themes"
      via: "useTheme hook for theme switching"
      pattern: "useTheme"
    - from: "src/components/editor/article-editor.tsx"
      to: "next-themes"
      via: "useTheme to pass current theme to BlockNoteView"
      pattern: "useTheme"
---

<objective>
Add light/dark mode support using next-themes (already installed). ThemeProvider in root layout, theme toggle in user profile, preference persisted in users table, and BlockNote editor respects current theme. Unify the app header across wiki and admin layouts: user avatar dropdown and admin settings cog in top-right, admin section navigation moved from header to page-level tab group.

Purpose: Users can choose their preferred color scheme. App chrome is consistent across wiki and admin areas with a uniform header pattern and clear navigation.
Output: ThemeProvider setup, users.themePreference column, profile form theme control, editor theme integration, unified headers, admin tab navigation.
</objective>

<execution_context>
@/Users/michael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/app/layout.tsx
@src/lib/db/schema.ts
@src/app/(wiki)/profile/page.tsx
@src/app/(wiki)/profile/profile-form.tsx
@src/app/(wiki)/profile/actions.ts
@src/components/editor/article-editor.tsx
@src/app/(admin)/layout.tsx
@src/components/wiki/article-tabs.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add themePreference column, create ThemeProvider, and wire into root layout</name>
  <files>src/lib/db/schema.ts, src/components/common/theme-provider.tsx, src/app/layout.tsx</files>
  <action>
**1. Add themePreference column to users table in src/lib/db/schema.ts:**

Add a `themePreference` text column to the users table (after `notifyOnActivity`):
```ts
themePreference: text("theme_preference").default("system").notNull(),
```

Use a text column with default "system" (not an enum -- three values "system"|"light"|"dark" don't need a Postgres enum). This avoids migration complexity.

After editing, run:
```bash
npx drizzle-kit generate
npx drizzle-kit push
```

**2. Create src/components/common/theme-provider.tsx:**

A client component wrapper for next-themes:
```tsx
"use client";

import { ThemeProvider as NextThemesProvider } from "next-themes";

export function ThemeProvider({ children, ...props }: React.ComponentProps<typeof NextThemesProvider>) {
  return <NextThemesProvider {...props}>{children}</NextThemesProvider>;
}
```

**3. Update src/app/layout.tsx:**

Wrap children with ThemeProvider. The key configurations:
- `attribute="class"` — applies dark class to html element (required for Tailwind dark mode)
- `defaultTheme="system"` — respects OS preference by default
- `enableSystem` — enables system theme detection
- `disableTransitionOnChange` — prevents flash during theme switch

Update the `<html>` tag to include `suppressHydrationWarning` (required by next-themes to prevent hydration mismatch):

```tsx
import { ThemeProvider } from "@/components/common/theme-provider";

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en" suppressHydrationWarning>
      <body className={`${geistSans.variable} ${geistMono.variable} antialiased`}>
        <AuthSessionProvider>
          <ThemeProvider
            attribute="class"
            defaultTheme="system"
            enableSystem
            disableTransitionOnChange
          >
            {children}
            <Toaster />
          </ThemeProvider>
        </AuthSessionProvider>
      </body>
    </html>
  );
}
```

Note: Toaster (sonner) should be inside ThemeProvider so it respects the theme.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors. Run `npm run build` to verify compilation. Read layout.tsx to confirm ThemeProvider wraps children with correct props. Read schema.ts to confirm themePreference column exists.
  </verify>
  <done>
ThemeProvider configured in root layout with class-based dark mode. Users table has themePreference column with "system" default. html element gets suppressHydrationWarning for next-themes compatibility.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add theme toggle to profile page and make editor theme-aware</name>
  <files>src/app/(wiki)/profile/profile-form.tsx, src/app/(wiki)/profile/actions.ts, src/app/(wiki)/profile/page.tsx, src/components/editor/article-editor.tsx</files>
  <action>
**1. Update src/app/(wiki)/profile/actions.ts:**

Add themePreference to the `getUserProfile` function's select fields (add `themePreference: users.themePreference`).

Add a new server action `updateThemePreference`:
```ts
export async function updateThemePreference(theme: string) {
  const session = await auth();
  if (!session?.user?.id) throw new Error("Not authenticated");

  if (!["system", "light", "dark"].includes(theme)) {
    throw new Error("Invalid theme");
  }

  const db = getDb();
  await db.update(users).set({ themePreference: theme }).where(eq(users.id, session.user.id));
}
```

**2. Update src/app/(wiki)/profile/page.tsx:**

Pass `themePreference: user.themePreference` to the ProfileForm component props.

**3. Update src/app/(wiki)/profile/profile-form.tsx:**

Add a theme preference section to the profile form. This should use `next-themes`'s `useTheme` hook for immediate client-side switching AND persist to DB:

a) Add `useTheme` import from `next-themes`
b) Add a new section below the existing profile fields (or in a separate Card passed from page.tsx — match the existing Card pattern):

```tsx
// Theme selection
const { setTheme, theme } = useTheme();
```

Render three toggle buttons (or a radio group) for System / Light / Dark:
```tsx
<div className="space-y-2">
  <Label>Theme</Label>
  <div className="flex gap-2">
    {(["system", "light", "dark"] as const).map((t) => (
      <Button
        key={t}
        variant={theme === t ? "default" : "outline"}
        size="sm"
        onClick={async () => {
          setTheme(t); // Immediate client-side switch
          await updateThemePreference(t); // Persist to DB
        }}
      >
        {t === "system" ? "Auto" : t.charAt(0).toUpperCase() + t.slice(1)}
      </Button>
    ))}
  </div>
  <p className="text-xs text-muted-foreground">
    Auto follows your operating system preference.
  </p>
</div>
```

Import `updateThemePreference` from `./actions`.

c) To load the persisted preference on mount (so it survives login), pass the server-loaded `themePreference` as a prop and call `setTheme(themePreference)` in a useEffect on mount. This syncs the next-themes state with the DB-persisted preference:
```tsx
useEffect(() => {
  if (themePreference) {
    setTheme(themePreference);
  }
}, []); // Only on mount
```

**4. Update src/components/editor/article-editor.tsx:**

Make BlockNote respect the current theme:

a) Import `useTheme` from `next-themes`
b) Get the resolved theme:
```tsx
const { resolvedTheme } = useTheme();
```
c) Replace the hardcoded `theme="light"` on BlockNoteView:
```tsx
<BlockNoteView
  editor={editor}
  onChange={handleChange}
  theme={resolvedTheme === "dark" ? "dark" : "light"}
/>
```

`resolvedTheme` accounts for "system" by resolving to the actual system preference ("light" or "dark").
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors. Run `npm run build` to verify compilation. Read profile-form.tsx to confirm theme toggle exists. Read article-editor.tsx to confirm BlockNoteView uses resolvedTheme. Read actions.ts to confirm updateThemePreference server action exists.
  </verify>
  <done>
Profile page has System/Light/Dark toggle buttons. Clicking immediately switches theme client-side and persists to users.themePreference in DB. On login, persisted theme is loaded. BlockNote editor switches between light/dark theme based on current resolved theme.
  </done>
</task>

<task type="auto">
  <name>Task 3: Move user menu from sidebar footer to top-right header with admin settings cog</name>
  <files>src/app/(wiki)/layout.tsx, src/components/wiki/app-sidebar.tsx, src/components/common/user-menu.tsx</files>
  <action>
**1. Update src/components/common/user-menu.tsx:**

Simplify the trigger to show only the avatar icon (no name text next to it). The name appears inside the dropdown instead.

a) Remove the `<span>` showing user.name from the trigger button. The trigger should be just the Avatar:
```tsx
<DropdownMenuTrigger asChild>
  <button className="flex items-center rounded-full outline-none hover:opacity-80 focus-visible:ring-2 focus-visible:ring-ring">
    <Avatar className="h-8 w-8">
      <AvatarImage src={avatarSrc} alt={user.name ?? "User"} referrerPolicy="no-referrer" />
      <AvatarFallback className="text-xs">{initials}</AvatarFallback>
    </Avatar>
  </button>
</DropdownMenuTrigger>
```

b) Update dropdown content:
- Keep the name/email header section at top
- Rename "Profile" link to "Account Settings" (still links to /profile)
- Remove the admin "Admin" link (this is replaced by the separate cog icon)
- Keep "Sign Out" at the bottom

```tsx
<DropdownMenuContent align="end" className="w-48">
  <div className="px-2 py-1.5">
    <p className="text-sm font-medium">{user.name}</p>
    <p className="text-xs text-zinc-500 dark:text-zinc-400">{user.email}</p>
  </div>
  <DropdownMenuSeparator />
  <DropdownMenuItem asChild>
    <Link href="/profile">Account Settings</Link>
  </DropdownMenuItem>
  <DropdownMenuSeparator />
  <DropdownMenuItem onClick={() => signOut({ callbackUrl: "/login" })}>
    Log Out
  </DropdownMenuItem>
</DropdownMenuContent>
```

c) Remove the `user.role` prop requirement from UserMenuProps since the admin link is gone from this component. Keep the prop in the interface for now (it's still passed from the layout) but it's no longer used inside UserMenu.

**2. Update src/components/wiki/app-sidebar.tsx:**

Remove the UserMenu from the sidebar footer:
- Remove the `SidebarFooter` import and `UserMenu` import
- Remove the entire `<SidebarFooter>...</SidebarFooter>` block
- Remove `user` from `AppSidebarProps` interface and destructured props
- The sidebar now only contains the header (logo) and content (categories + TOC)

Updated component:
```tsx
interface AppSidebarProps {
  categories: CategoryWithArticles[];
}

export function AppSidebar({ categories }: AppSidebarProps) {
  return (
    <Sidebar collapsible="icon">
      <SidebarHeader>...</SidebarHeader>
      <SidebarContent>...</SidebarContent>
    </Sidebar>
  );
}
```

**3. Update src/app/(wiki)/layout.tsx:**

Move the user controls into the header bar, to the right of the search input:

a) Import `UserMenu` from `@/components/common/user-menu` and `Settings` icon from `lucide-react`. Also import `Link` from `next/link`.

b) Update the `<AppSidebar>` call to remove the `user` prop:
```tsx
<AppSidebar categories={categoryTree} />
```

c) Update the header to place user avatar and admin cog to the right of the search bar:
```tsx
<header className="flex h-14 items-center gap-2 border-b px-4">
  <SidebarTrigger />
  <Separator orientation="vertical" className="h-4" />
  <div className="flex flex-1 items-center gap-2">
    <div className="ml-auto flex items-center gap-2">
      <div className="w-64">
        <Suspense fallback={<Skeleton className="h-9 w-full" />}>
          <SearchInput />
        </Suspense>
      </div>
      {user.role === "admin" && (
        <Link
          href="/admin/settings"
          className="flex items-center justify-center rounded-md p-2 text-muted-foreground hover:bg-accent hover:text-foreground transition-colors"
          title="Admin Settings"
        >
          <Settings className="size-5" />
        </Link>
      )}
      <UserMenu user={user} />
    </div>
  </div>
</header>
```

The order from left to right in the header: sidebar trigger | separator | ... (flex spacer) | search bar | settings cog (admin only) | user avatar
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors. Run `npm run build` to verify compilation. Read app-sidebar.tsx to confirm UserMenu and SidebarFooter are removed. Read layout.tsx to confirm UserMenu and Settings icon are in the header. Read user-menu.tsx to confirm avatar-only trigger and "Account Settings" label.
  </verify>
  <done>
User avatar appears in the top-right header next to the search bar. Clicking it shows a dropdown with name, "Account Settings" link, and "Log Out". Admin users see a settings cog icon linking to /admin/settings. Sidebar footer is clean (no user menu).
  </done>
</task>

<task type="auto">
  <name>Task 4: Unify admin layout with sidebar and tab-based section navigation</name>
  <files>src/app/(admin)/layout.tsx, src/components/admin/admin-nav.tsx</files>
  <action>
**Goal:** Make the admin layout use the same sidebar + header shell as the wiki layout so navigating to admin pages feels like staying in the same app, not switching to a different site. The sidebar collapses (icon mode) by default on admin pages but remains accessible via the trigger.

**1. Rewrite src/app/(admin)/layout.tsx to use SidebarProvider + AppSidebar + SidebarInset:**

The admin layout should mirror the wiki layout structure. Key imports:
```tsx
import { SidebarProvider, SidebarInset, SidebarTrigger } from "@/components/ui/sidebar";
import { Separator } from "@/components/ui/separator";
import { AppSidebar } from "@/components/wiki/app-sidebar";
import { UserMenu } from "@/components/common/user-menu";
import { AdminNav } from "@/components/admin/admin-nav";
import { TocProvider } from "@/components/wiki/toc-context";
import { Settings } from "lucide-react";
import { getCategoryTreeWithArticles } from "@/lib/wiki/queries";
import { getDb } from "@/lib/db";
import { users } from "@/lib/db/schema";
import { eq } from "drizzle-orm";
```

Remove old imports: `signOut` from auth, `Avatar`/`AvatarFallback`/`AvatarImage`, `Button`.

a) Fetch user record and category tree (same as wiki layout):
```tsx
const db = getDb();
const [user] = await db
  .select({
    name: users.name,
    email: users.email,
    image: users.image,
    avatarUrl: users.avatarUrl,
    role: users.role,
  })
  .from(users)
  .where(eq(users.id, session.user.id))
  .limit(1);

if (!user) redirect("/login");

const categoryTree = await getCategoryTreeWithArticles();
```

b) Replace the entire layout JSX with the sidebar pattern. Key difference from wiki layout: `defaultOpen={false}` to start collapsed:
```tsx
return (
  <TocProvider>
    <SidebarProvider defaultOpen={false}>
      <AppSidebar categories={categoryTree} />
      <SidebarInset>
        <header className="flex h-14 items-center gap-2 border-b px-4">
          <SidebarTrigger />
          <Separator orientation="vertical" className="h-4" />
          <div className="flex items-center gap-1 rounded-md bg-amber-100 px-2 py-1 text-xs font-medium text-amber-800 dark:bg-amber-900 dark:text-amber-200">
            Admin
          </div>
          <div className="ml-auto flex items-center gap-2">
            <Link
              href="/admin/settings"
              className="flex items-center justify-center rounded-md p-2 text-muted-foreground hover:bg-accent hover:text-foreground transition-colors"
              title="Admin Settings"
            >
              <Settings className="size-5" />
            </Link>
            <UserMenu user={user} />
          </div>
        </header>
        <AdminNav />
        <main className="flex-1 p-6">{children}</main>
      </SidebarInset>
    </SidebarProvider>
  </TocProvider>
);
```

The header matches the wiki header pattern: SidebarTrigger on the left (so users can expand the sidebar to browse wiki categories even while in admin), then Admin badge, then spacer, then settings cog + user avatar on the right.

Remove: the old `<nav>` header, all inline Settings/Sync/Users/Review Queue links, "Back to Wiki" button, "Sign Out" form, avatar+name display, and `initials` computation.

**2. Create src/components/admin/admin-nav.tsx:**

A client component that renders route-based tab navigation for admin sections. Uses `usePathname` for active state highlighting. Styled to match the article-tabs visual pattern (bottom border highlight, icon + label):

```tsx
"use client";

import Link from "next/link";
import { usePathname } from "next/navigation";
import { Settings, RefreshCw, Users, ClipboardList } from "lucide-react";
import { cn } from "@/lib/utils";

const adminTabs = [
  { href: "/admin/settings", label: "Settings", icon: Settings },
  { href: "/admin/sync", label: "Sync", icon: RefreshCw },
  { href: "/admin/users", label: "Users", icon: Users },
  { href: "/admin/review-queue", label: "Review Queue", icon: ClipboardList },
];

export function AdminNav() {
  const pathname = usePathname();
  return (
    <div className="border-b">
      <nav className="flex gap-1 px-6">
        {adminTabs.map((tab) => {
          const isActive = pathname === tab.href || pathname.startsWith(tab.href + "/");
          return (
            <Link
              key={tab.href}
              href={tab.href}
              className={cn(
                "flex items-center gap-2 px-4 py-2.5 text-sm font-medium border-b-2 -mb-px transition-colors",
                isActive
                  ? "border-primary text-foreground"
                  : "border-transparent text-muted-foreground hover:text-foreground hover:border-muted-foreground/30"
              )}
            >
              <tab.icon className="size-4" />
              {tab.label}
            </Link>
          );
        })}
      </nav>
    </div>
  );
}
```

Note: `px-6` on the nav matches the `p-6` on main content area for alignment. No max-w-7xl wrapper needed since we're inside `SidebarInset` which already constrains the width.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors. Run `npm run build` to verify compilation. Read admin layout to confirm: uses SidebarProvider with defaultOpen={false}, includes AppSidebar, header has SidebarTrigger + Admin badge + settings cog + UserMenu, AdminNav rendered below header. Confirm no "Back to Wiki", no "Sign Out" form, no inline nav links in header. Read admin-nav.tsx to confirm route-based tabs with active state.
  </verify>
  <done>
Admin layout uses same SidebarProvider + AppSidebar + SidebarInset shell as wiki. Sidebar defaults to collapsed (icon mode) but can be expanded via SidebarTrigger. Header matches wiki pattern: trigger, Admin badge, spacer, cog + avatar. Admin section navigation lives as a tab bar below the header. No "Back to Wiki" or "Sign Out" links. Navigating between wiki and admin feels like staying in the same app.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. ThemeProvider with attribute="class" in root layout
4. html element has suppressHydrationWarning
5. Profile page shows System/Light/Dark buttons
6. users table has themePreference column
7. BlockNoteView theme prop uses resolvedTheme
8. updateThemePreference server action validates input
9. User avatar appears in wiki header bar (top-right) next to search input
10. Clicking avatar shows dropdown: user name, "Account Settings", "Log Out"
11. Admin users see Settings cog icon next to avatar linking to /admin/settings
12. AppSidebar no longer contains UserMenu or SidebarFooter
13. Admin layout uses SidebarProvider with defaultOpen={false} + AppSidebar + SidebarInset
14. Admin header has SidebarTrigger + Admin badge (left), settings cog + user avatar (right)
15. Admin layout has no "Back to Wiki" button or "Sign Out" form in header
16. Admin layout has no inline nav links (Settings/Sync/Users/Review Queue) in header
17. AdminNav tab bar appears below admin header with 4 tabs and active-state bottom border
18. Admin header UserMenu uses same component as wiki header (shared user-menu.tsx)
19. Sidebar can be expanded from admin pages to browse wiki categories
</verification>

<success_criteria>
User can toggle between auto (system default), light, and dark mode from their profile page. Preference persists in the database across sessions. Theme applies app-wide including BlockNote editor. Dark mode uses Tailwind's class strategy via next-themes. User menu relocated from sidebar footer to top-right header as avatar icon with dropdown (name, Account Settings, Log Out). Admin settings cog icon visible only to admins, next to avatar. Admin layout uses the same SidebarProvider + AppSidebar shell as the wiki layout (sidebar collapsed by default, expandable). Admin section navigation uses page-level tab bar instead of header links. The entire app feels like one unified experience.
</success_criteria>

<output>
After completion, create `.planning/phases/05-article-editing/05-08-SUMMARY.md`
</output>
