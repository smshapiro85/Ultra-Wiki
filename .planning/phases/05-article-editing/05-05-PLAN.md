---
phase: 05-article-editing
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(admin)/admin/review-queue/page.tsx
  - src/lib/wiki/queries.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Admin can navigate to /admin/review-queue and see a list of articles needing attention"
    - "Each item shows article title, category, reason (merge conflict or AI annotation count), and last updated date"
    - "Admin can filter the queue by category using a dropdown"
    - "Admin can search the queue by article title"
    - "Admin can sort the queue by date (newest/oldest first)"
    - "Clicking an item navigates to the article page for resolution"
  artifacts:
    - path: "src/app/(admin)/admin/review-queue/page.tsx"
      provides: "Admin Review Queue server component page"
    - path: "src/lib/wiki/queries.ts"
      provides: "getReviewQueueItems query function"
  key_links:
    - from: "src/app/(admin)/admin/review-queue/page.tsx"
      to: "src/lib/wiki/queries.ts"
      via: "getReviewQueueItems server call"
      pattern: "getReviewQueueItems"
    - from: "review-queue/page.tsx"
      to: "/wiki/[articleSlug]"
      via: "Link href to article page"
      pattern: "href.*wiki/"
---

<objective>
Create an Admin Review Queue page at /admin/review-queue that lists all articles needing attention -- either merge conflicts (needsReview=true) or active AI review annotations.

Purpose: Gives admins a centralized dashboard to find and address all review items instead of discovering them article-by-article.
Output: Server component page at /admin/review-queue with query function in queries.ts.
</objective>

<execution_context>
@/Users/michael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/wiki/queries.ts
@src/lib/db/schema.ts
@src/app/(admin)/admin/settings/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getReviewQueueItems query and build Admin Review Queue page</name>
  <files>src/lib/wiki/queries.ts, src/app/(admin)/admin/review-queue/page.tsx</files>
  <action>
**1. Add getReviewQueueItems query to src/lib/wiki/queries.ts:**

Create a new exported async function `getReviewQueueItems` that returns articles needing review. Use a single SQL query that:
- Selects articles where `needsReview = true` OR that have active (non-dismissed) AI review annotations
- Joins categories for category name/slug
- Left-joins ai_review_annotations (grouped) to get active annotation count per article
- Returns: id, title, slug, needsReview, categoryName, categorySlug, updatedAt, annotationCount
- Orders by updatedAt DESC

The query should use raw SQL via `db.execute(sql`...`)` for the annotation count subquery/join, similar to the existing `searchArticles` pattern. Something like:

```sql
SELECT DISTINCT
  a.id, a.title, a.slug, a.needs_review AS "needsReview",
  c.name AS "categoryName", c.slug AS "categorySlug",
  a.updated_at AS "updatedAt",
  COALESCE(ann.count, 0)::int AS "annotationCount"
FROM articles a
LEFT JOIN categories c ON a.category_id = c.id
LEFT JOIN (
  SELECT article_id, COUNT(*) AS count
  FROM ai_review_annotations
  WHERE is_dismissed = false
  GROUP BY article_id
) ann ON a.id = ann.article_id
WHERE a.needs_review = true OR ann.count > 0
ORDER BY a.updated_at DESC
```

Type the return as `Array<{ id: string; title: string; slug: string; needsReview: boolean; categoryName: string | null; categorySlug: string | null; updatedAt: string; annotationCount: number }>`.

**2. Create src/app/(admin)/admin/review-queue/page.tsx:**

Server component page that:
- Calls `getReviewQueueItems()` to get all review queue data server-side
- Renders a heading "Review Queue" with item count badge
- Renders a client component `ReviewQueueList` (defined in the same file with "use client" -- or use a separate file if preferred, but co-locating is fine for a single interactive list)

For the client-side interactive part (filtering, searching, sorting), create a `"use client"` component in a separate file `src/app/(admin)/admin/review-queue/review-queue-list.tsx` that receives the items as props and provides:

- **Search**: Input field at top that filters items client-side by title (case-insensitive includes). Use a controlled input with useState.
- **Category filter**: A `<select>` dropdown showing "All Categories" + unique category names from the data. Filters items client-side.
- **Sort**: A `<select>` dropdown with "Newest First" (default) and "Oldest First". Sorts by updatedAt.
- **Item list**: Cards/rows for each item showing:
  - Article title as a Link to `/wiki/${item.slug}`
  - Category badge (if present)
  - Reason indicators: orange "Needs Review" badge if `needsReview`, blue "N Annotations" badge if `annotationCount > 0`
  - Relative time since last update (use Intl.RelativeTimeFormat or simple "X days ago" logic)
- Empty state: "No articles need review" message when filtered list is empty

Use existing shadcn components: Card, Badge, Input, Button. Follow the same patterns as existing admin pages (server component page importing from queries.ts).
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors. Run `npm run build` and verify the /admin/review-queue route is registered in the build output. Visually confirm the page structure by reading the created files.
  </verify>
  <done>
Admin can visit /admin/review-queue and see a list of articles with merge conflicts or active AI annotations. Items show title, category, reason badges, and last updated. Client-side search, category filter, and sort controls work. Each item links to the article page.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds with /admin/review-queue route registered
3. getReviewQueueItems returns articles with needsReview=true OR annotationCount > 0
4. Page renders search input, category filter dropdown, sort dropdown
5. Each item links to /wiki/[slug]
</verification>

<success_criteria>
Admin Review Queue page exists at /admin/review-queue with working search, category filter, sort, and article links. Query correctly identifies articles needing review via needsReview flag or active annotation count.
</success_criteria>

<output>
After completion, create `.planning/phases/05-article-editing/05-05-SUMMARY.md`
</output>
