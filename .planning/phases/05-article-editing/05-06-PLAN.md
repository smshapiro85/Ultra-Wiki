---
phase: 05-article-editing
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/db/schema.ts
  - src/lib/content/version.ts
  - src/components/editor/article-editor.tsx
  - src/app/api/articles/[id]/draft/route.ts
  - src/components/wiki/version-history.tsx
  - src/lib/wiki/queries.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "changeSourceEnum includes 'draft' as a valid value"
    - "Editor auto-saves draft content as a version record with changeSource 'draft' (one per user per article, upsert pattern)"
    - "Draft version records appear in version history with distinct visual styling (dashed border, draft badge)"
    - "User can filter version history to show draft versions"
    - "localStorage auto-save is replaced by server-side draft version records"
    - "Draft recovery banner on editor load checks for existing draft version record instead of localStorage"
  artifacts:
    - path: "src/lib/db/schema.ts"
      provides: "Updated changeSourceEnum with 'draft' value"
      contains: "draft"
    - path: "src/app/api/articles/[id]/draft/route.ts"
      provides: "PUT endpoint for upsert draft version, GET for fetching latest draft"
    - path: "src/components/editor/article-editor.tsx"
      provides: "Updated editor with server-side draft auto-save replacing localStorage"
    - path: "src/components/wiki/version-history.tsx"
      provides: "Draft badge and styling in version list"
  key_links:
    - from: "src/components/editor/article-editor.tsx"
      to: "/api/articles/[id]/draft"
      via: "debounced fetch PUT for draft auto-save"
      pattern: "fetch.*draft"
    - from: "src/components/wiki/version-history.tsx"
      to: "draft"
      via: "ChangeSourceBadge case for draft"
      pattern: 'case "draft"'
---

<objective>
Replace localStorage draft auto-save with server-side `changeSource: "draft"` version records. One draft per user per article using upsert. Drafts appear in version history with distinct styling.

Purpose: Drafts become first-class version records that survive browser clears, are previewable, and follow the same patterns as other version types. No more localStorage blind-restore.
Output: Updated schema enum, draft API route, modified editor and version history components.
</objective>

<execution_context>
@/Users/michael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/db/schema.ts
@src/lib/content/version.ts
@src/components/editor/article-editor.tsx
@src/components/wiki/version-history.tsx
@src/app/api/articles/[id]/save/route.ts
@src/lib/wiki/queries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add 'draft' to changeSourceEnum and create draft API route</name>
  <files>src/lib/db/schema.ts, src/lib/content/version.ts, src/app/api/articles/[id]/draft/route.ts, src/lib/wiki/queries.ts</files>
  <action>
**1. Update changeSourceEnum in src/lib/db/schema.ts:**

Add "draft" to the changeSourceEnum array:
```ts
export const changeSourceEnum = pgEnum("change_source", [
  "ai_generated",
  "ai_updated",
  "human_edited",
  "ai_merged",
  "draft",
]);
```

**IMPORTANT:** This requires a database migration. After editing the enum, run:
```bash
npx drizzle-kit generate
npx drizzle-kit push
```
If `drizzle-kit push` fails on enum alteration (Postgres enums are tricky), use raw SQL instead:
```bash
# Via the Neon console or psql
ALTER TYPE change_source ADD VALUE IF NOT EXISTS 'draft';
```
Or add a migration SQL file. The `drizzle-kit push` approach is preferred if it works.

**2. Update createArticleVersion in src/lib/content/version.ts:**

Add "draft" to the changeSource union type in the params:
```ts
changeSource: "ai_generated" | "ai_updated" | "human_edited" | "ai_merged" | "draft";
```

**3. Update getArticleVersions in src/lib/wiki/queries.ts:**

Update the validSources type cast to include "draft":
```ts
const validSources = sourceFilter as Array<
  "ai_generated" | "ai_updated" | "human_edited" | "ai_merged" | "draft"
>;
```

**4. Create src/app/api/articles/[id]/draft/route.ts:**

Two endpoints:

**PUT /api/articles/[id]/draft** — Upsert a draft version record:
- Auth required (session.user.id)
- Body: `{ contentJson: unknown, contentMarkdown: string }`
- Check if a draft version already exists for this user + article:
  ```ts
  const existing = await db.select({ id: articleVersions.id })
    .from(articleVersions)
    .where(and(
      eq(articleVersions.articleId, articleId),
      eq(articleVersions.changeSource, "draft"),
      eq(articleVersions.createdBy, userId)
    ))
    .limit(1);
  ```
- If exists: UPDATE the existing record's contentMarkdown, contentJson, and createdAt (reset timestamp to now)
- If not exists: INSERT new version record with changeSource "draft"
- Return `{ success: true, draftId: string }`

**GET /api/articles/[id]/draft** — Get the current user's draft:
- Auth required
- Query for the latest draft version for this user + article
- Return the draft object `{ id, contentJson, contentMarkdown, createdAt }` or `{ draft: null }` if no draft exists

**DELETE /api/articles/[id]/draft** — Delete the current user's draft:
- Auth required
- Delete the draft version record for this user + article
- Return `{ success: true }`
  </action>
  <verify>
Run `npx tsc --noEmit` to verify type correctness. Check that the draft route file exports GET, PUT, and DELETE. Verify changeSourceEnum includes "draft" in schema.ts.
  </verify>
  <done>
changeSourceEnum includes "draft". Draft API route supports GET (fetch), PUT (upsert), and DELETE (discard). createArticleVersion accepts "draft" as changeSource. Version query type includes "draft".
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace localStorage drafts with server-side drafts in editor and add draft styling to version history</name>
  <files>src/components/editor/article-editor.tsx, src/components/wiki/version-history.tsx</files>
  <action>
**1. Update src/components/editor/article-editor.tsx:**

Replace the localStorage-based draft system with server-side draft auto-save:

a) **Remove localStorage draft code:**
- Remove the `draftKey` variable
- Remove the `useEffect` that checks `localStorage.getItem(draftKey)` on mount
- Remove `handleChange` that saves to localStorage
- Remove `restoreDraft` that reads from localStorage
- Remove `discardDraft` that calls `localStorage.removeItem`
- Remove `localStorage.removeItem(draftKey)` from handleSave

b) **Add server-side draft auto-save:**
- Add a `draftTimeoutRef = useRef<NodeJS.Timeout | null>(null)` for debouncing
- Add `savingDraft` state (boolean, for optional UI indicator)
- Create a `saveDraft` async function that:
  - Converts editor.document to markdown via `editor.blocksToMarkdownLossy`
  - PUTs to `/api/articles/${articleId}/draft` with `{ contentJson: editor.document, contentMarkdown }`
  - Silently catches errors (draft save failures are not critical)
- Update the `onChange` handler on BlockNoteView to debounce draft saves:
  ```ts
  const handleChange = useCallback(() => {
    if (!isReady) return;
    if (draftTimeoutRef.current) clearTimeout(draftTimeoutRef.current);
    draftTimeoutRef.current = setTimeout(() => saveDraft(), 3000); // 3-second debounce
  }, [isReady, saveDraft]);
  ```
- Cleanup timeout on unmount via useEffect return

c) **Add server-side draft recovery on mount:**
- On mount (alongside content loading), fetch GET `/api/articles/${articleId}/draft`
- If a draft exists (draft is not null), set `hasDraft = true` and store the draft data in state
- The restore/discard banner stays the same visually but:
  - Restore: loads draft contentJson into editor via `editor.replaceBlocks`
  - Discard: calls DELETE `/api/articles/${articleId}/draft` and sets hasDraft = false

d) **On successful save (handleSave):**
- After successful save, also DELETE `/api/articles/${articleId}/draft` to clean up the draft record (since the content is now saved as a proper "human_edited" version)

e) **Update BlockNoteView theme prop:**
- Keep `theme="light"` for now (05-08 will make this dynamic)

**2. Update src/components/wiki/version-history.tsx:**

a) **Add "Draft" to SOURCE_FILTERS:**
```ts
const SOURCE_FILTERS = [
  { label: "All", value: "" },
  { label: "AI Generated", value: "ai_generated" },
  { label: "Human Edited", value: "human_edited" },
  { label: "AI Merged", value: "ai_merged" },
  { label: "AI Updated", value: "ai_updated" },
  { label: "Draft", value: "draft" },
] as const;
```

b) **Add draft case to ChangeSourceBadge:**
```tsx
case "draft":
  return (
    <Badge variant="outline" className="gap-1 text-xs border-dashed text-muted-foreground">
      <FileEdit className="size-3" />
      Draft
    </Badge>
  );
```
Import `FileEdit` (or `PenLine`) from lucide-react.

c) **Add distinct styling to draft version cards:**
In the version list item rendering, add conditional styling when `version.changeSource === "draft"`:
```tsx
className={`... ${version.changeSource === "draft" ? "border-dashed opacity-75" : ""}`}
```
This gives draft versions a dashed border and slightly faded appearance to visually distinguish them from committed versions.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors. Run `npm run build` to verify all routes compile. Read both modified files to confirm localStorage references are removed from article-editor.tsx and draft badge/styling exists in version-history.tsx.
  </verify>
  <done>
Editor auto-saves drafts to server via debounced PUT to /api/articles/[id]/draft. Draft recovery on editor mount checks server instead of localStorage. Discard deletes draft record. Save cleans up draft. Version history shows drafts with dashed border and "Draft" badge. Draft filter available in history.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. changeSourceEnum in schema.ts includes "draft"
4. No references to localStorage for drafts remain in article-editor.tsx
5. Draft API route at /api/articles/[id]/draft exports GET, PUT, DELETE
6. Version history shows "Draft" in filter options and ChangeSourceBadge
7. Draft version cards have dashed border styling
</verification>

<success_criteria>
Editor drafts are server-side version records. One draft per user per article (upsert). Drafts appear in version history with distinct styling. localStorage draft code is fully removed.
</success_criteria>

<output>
After completion, create `.planning/phases/05-article-editing/05-06-SUMMARY.md`
</output>
