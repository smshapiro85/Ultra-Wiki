---
phase: 05-article-editing
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/lib/wiki/queries.ts
  - src/components/wiki/version-history.tsx
  - src/components/wiki/diff-viewer.tsx
  - src/app/api/articles/[id]/versions/route.ts
  - src/app/api/articles/[id]/restore/route.ts
  - src/components/wiki/article-tabs.tsx
  - src/app/(wiki)/wiki/[articleSlug]/page.tsx
autonomous: true
must_haves:
  truths:
    - "User can click History tab on any article and see a list of all versions"
    - "User can filter version history by change source (AI, human, merged)"
    - "User can select two versions and see a side-by-side or inline diff"
    - "User can restore (rollback) any article to a previous version"
    - "Rollback creates a new version record (preserving full history)"
  artifacts:
    - path: "src/components/wiki/version-history.tsx"
      provides: "Version list with filtering and comparison selection"
      min_lines: 80
    - path: "src/components/wiki/diff-viewer.tsx"
      provides: "Custom diff viewer with side-by-side and inline modes"
      min_lines: 60
    - path: "src/app/api/articles/[id]/versions/route.ts"
      provides: "GET endpoint for listing versions with filtering"
      exports: ["GET"]
    - path: "src/app/api/articles/[id]/restore/route.ts"
      provides: "POST endpoint for restoring to a previous version"
      exports: ["POST"]
  key_links:
    - from: "src/components/wiki/version-history.tsx"
      to: "/api/articles/[id]/versions"
      via: "fetch GET for version list"
      pattern: "fetch.*versions"
    - from: "src/components/wiki/version-history.tsx"
      to: "src/components/wiki/diff-viewer.tsx"
      via: "renders DiffViewer with two version contents"
      pattern: "DiffViewer"
    - from: "src/components/wiki/version-history.tsx"
      to: "/api/articles/[id]/restore"
      via: "fetch POST for rollback"
      pattern: "fetch.*restore"
---

<objective>
Build version history UI with filtering, diff comparison, and rollback capability for the History tab.

Purpose: Users need to track all changes to articles (AI and human), compare versions to see what changed, and restore previous versions if needed.

Output: Version history component with filter/compare/rollback, diff viewer, API endpoints for versions listing and restore, activated History tab.
</objective>

<execution_context>
@/Users/michael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-article-editing/05-RESEARCH.md
@.planning/phases/05-article-editing/05-01-SUMMARY.md
@src/lib/db/schema.ts
@src/lib/content/version.ts
@src/lib/merge/diff.ts
@src/lib/wiki/queries.ts
@src/components/wiki/article-tabs.tsx
@src/app/(wiki)/wiki/[articleSlug]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create version listing and restore API endpoints</name>
  <files>
    src/app/api/articles/[id]/versions/route.ts
    src/app/api/articles/[id]/restore/route.ts
    src/lib/wiki/queries.ts
  </files>
  <action>
    **A. Create GET /api/articles/[id]/versions/route.ts**:

    - Auth guard: require authenticated session, return 401 if not
    - Extract articleId from params
    - Read optional query param: ?source=ai_generated,human_edited,ai_merged,ai_updated (comma-separated filter)
    - Query article_versions table:
      * SELECT id, changeSource, changeSummary, createdBy, createdAt, contentMarkdown (needed for diff computation)
      * WHERE articleId = id
      * If source filter provided: WHERE changeSource IN (...filter values)
      * ORDER BY createdAt DESC
    - For each version, join with users table to get createdBy name (LEFT JOIN users ON createdBy = users.id, select users.name as creatorName)
    - Return 200 with array of version objects: { id, changeSource, changeSummary, creatorName, createdAt, contentMarkdown }
    - NOTE: contentMarkdown is included so diffs can be computed client-side. Articles are small (tens of KB) so this is fine.

    **B. Create POST /api/articles/[id]/restore/route.ts**:

    - Auth guard: require authenticated session, return 401 if not
    - Parse body: { versionId }
    - Fetch the target version from article_versions WHERE id = versionId AND articleId = id
    - If not found, return 404
    - Update articles table: set contentMarkdown = version.contentMarkdown, contentJson = version.contentJson (may be null), hasHumanEdits = true, lastHumanEditedAt = new Date(), lastHumanEditorId = session.user.id, updatedAt = new Date(), needsReview = false
    - Create a NEW version record via createArticleVersion: { articleId, contentMarkdown: version.contentMarkdown, contentJson: version.contentJson, changeSource: "human_edited", changeSummary: `Restored to version from ${version.createdAt.toISOString()}`, createdBy: session.user.id }
    - Revalidate the article page path
    - Return 200 { success: true }

    **C. Add getArticleVersions query to src/lib/wiki/queries.ts** (optional -- can also be done inline in the API route, but a shared query function is cleaner):

    Add function getArticleVersions(articleId: string, sourceFilter?: string[]) that queries article_versions with optional changeSource filter, joins users for creator name, orders by createdAt DESC.
  </action>
  <verify>
    Run `npx tsc --noEmit` -- no type errors.
    Routes exist at /api/articles/[id]/versions and /api/articles/[id]/restore.
  </verify>
  <done>API endpoints for listing versions (with source filtering) and restoring to a previous version are functional.</done>
</task>

<task type="auto">
  <name>Task 2: Create version history UI, diff viewer, and activate History tab</name>
  <files>
    src/components/wiki/version-history.tsx
    src/components/wiki/diff-viewer.tsx
    src/components/wiki/article-tabs.tsx
    src/app/(wiki)/wiki/[articleSlug]/page.tsx
  </files>
  <action>
    **A. Create src/components/wiki/diff-viewer.tsx** (client component):

    A custom diff viewer using the `diff` library (already installed, v8.0.3):
    - Import { diffLines, type Change } from "diff"
    - Props: oldContent (string), newContent (string), mode ("inline" | "side-by-side"), oldLabel (string), newLabel (string)
    - Compute diff: const changes = diffLines(oldContent, newContent)
    - For INLINE mode: render each change as a div with Tailwind classes:
      * Added: bg-green-50 dark:bg-green-950 text-green-800 dark:text-green-200, prefix "+"
      * Removed: bg-red-50 dark:bg-red-950 text-red-800 dark:text-red-200, prefix "-"
      * Unchanged: text-muted-foreground, prefix " "
      * All: font-mono text-sm whitespace-pre-wrap px-4 py-0.5
      * Show line numbers in a left gutter (computed from change counts)
    - For SIDE-BY-SIDE mode: two columns (flex, each flex-1, overflow-x-auto), left shows old (removed + unchanged), right shows new (added + unchanged). Blank lines fill gaps for alignment.
    - Include a toggle button group at the top: "Inline" | "Side by Side" (default inline)
    - If oldContent === newContent, show "No changes between these versions" message

    **B. Create src/components/wiki/version-history.tsx** (client component):

    Full version history panel with:
    - Props: articleId (string), articleSlug (string)
    - On mount, fetch versions from /api/articles/${articleId}/versions
    - Filter bar: dropdown/buttons for change source filter (All, AI Generated, Human Edited, AI Merged, AI Updated). On filter change, re-fetch with ?source= param.
    - Version list: scrollable list of version cards showing:
      * Date/time (formatted with Intl.DateTimeFormat)
      * Change source badge (reuse the badge pattern from home-dashboard -- color-coded Badge with lucide icon per source type)
      * Creator name (or "AI" if createdBy is null)
      * Change summary (truncated to 2 lines)
      * Radio/checkbox to select for comparison (select up to 2 versions)
    - When 2 versions selected, show "Compare" button. On click, display the DiffViewer below the list with the two versions' contentMarkdown.
    - When 1 version selected, show "Restore" button. On click, confirm dialog ("Restore article to this version? This creates a new version record."), then POST to /api/articles/${articleId}/restore with { versionId }. On success, toast + reload.
    - Handle empty state: "No version history available"
    - Handle loading state: skeleton placeholders

    **C. Update src/components/wiki/article-tabs.tsx**:

    - Remove `disabled` from the History tab trigger
    - Add `historyContent: React.ReactNode` prop to ArticleTabsProps
    - Render historyContent inside TabsContent value="history" (replace the placeholder text)

    **D. Update src/app/(wiki)/wiki/[articleSlug]/page.tsx**:

    - Import VersionHistory component
    - Pass historyContent prop to ArticleTabs: `historyContent={<VersionHistory articleId={article.id} articleSlug={article.slug} />}`
  </action>
  <verify>
    Run `npm run build` -- should compile without errors.
    The History tab should no longer be disabled.
    Version history component should render on the History tab.
  </verify>
  <done>
    History tab is active and shows version history with source filtering, date/creator/summary for each version.
    Users can select two versions and see inline or side-by-side diff.
    Users can restore any version (creates new version record preserving history).
    Diff viewer renders additions in green, removals in red, unchanged in neutral.
  </done>
</task>

</tasks>

<verification>
1. Navigate to an article with versions -- History tab shows version list
2. Filter by "Human Edited" -- list updates to show only human versions
3. Select two versions -- Compare button appears
4. Click Compare -- diff viewer shows with colored additions/removals
5. Toggle between inline and side-by-side -- both modes render correctly
6. Select one version and click Restore -- confirm dialog appears
7. Confirm restore -- article content reverts, new version created, toast shown
8. Check article_versions -- restore created a new version record
</verification>

<success_criteria>
- History tab active (no longer disabled placeholder)
- Version list loads from API with change source, summary, creator, date
- Source filter works (All, AI Generated, Human Edited, AI Merged, AI Updated)
- Diff viewer shows inline and side-by-side modes with proper coloring
- Restore creates a new version record (history is never destructive)
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-article-editing/05-03-SUMMARY.md`
</output>
