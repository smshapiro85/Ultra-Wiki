---
phase: 05-article-editing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/globals.css
  - src/components/editor/article-editor.tsx
  - src/components/editor/editor-save-dialog.tsx
  - src/app/(wiki)/wiki/[articleSlug]/edit/page.tsx
  - src/app/api/articles/[id]/save/route.ts
  - src/app/(wiki)/wiki/[articleSlug]/page.tsx
  - src/lib/wiki/queries.ts
autonomous: true
must_haves:
  truths:
    - "User can click Edit on any article page and reach a WYSIWYG editor"
    - "Editor loads existing content (contentJson if available, otherwise converts contentMarkdown client-side)"
    - "Editor toolbar supports headings, bold, italic, code, links, tables, lists"
    - "Drafts auto-save to localStorage on every change"
    - "Clicking Save opens a dialog prompting for optional change summary, then saves"
    - "Save creates an article_versions record with change_source human_edited and sets hasHumanEdits flag"
    - "Optimistic locking prevents save if article was modified externally since editor loaded"
  artifacts:
    - path: "src/components/editor/article-editor.tsx"
      provides: "BlockNote WYSIWYG editor client component"
      min_lines: 80
    - path: "src/components/editor/editor-save-dialog.tsx"
      provides: "Save dialog with change summary prompt"
      min_lines: 30
    - path: "src/app/(wiki)/wiki/[articleSlug]/edit/page.tsx"
      provides: "Server component edit page loading article data"
      min_lines: 30
    - path: "src/app/api/articles/[id]/save/route.ts"
      provides: "POST endpoint for saving editor content"
      exports: ["POST"]
    - path: "src/app/globals.css"
      provides: "BlockNote @source directive for Tailwind v4"
      contains: "@source"
  key_links:
    - from: "src/app/(wiki)/wiki/[articleSlug]/edit/page.tsx"
      to: "src/components/editor/article-editor.tsx"
      via: "dynamic import with ssr: false"
      pattern: "dynamic.*ssr.*false"
    - from: "src/components/editor/article-editor.tsx"
      to: "/api/articles/[id]/save"
      via: "fetch POST on save"
      pattern: "fetch.*api/articles"
    - from: "src/app/api/articles/[id]/save/route.ts"
      to: "src/lib/content/version.ts"
      via: "createArticleVersion call"
      pattern: "createArticleVersion"
---

<objective>
Integrate BlockNote WYSIWYG editor with native JSON storage, localStorage auto-save drafts, and explicit save with version tracking.

Purpose: This is the core editing capability -- users need to edit articles in a rich editor that stores BlockNote JSON natively, with auto-save for draft safety and explicit save creating version history records.

Output: Edit page at /wiki/[articleSlug]/edit, BlockNote editor component, save API endpoint, Edit button on article page.
</objective>

<execution_context>
@/Users/michael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-article-editing/05-RESEARCH.md
@src/lib/db/schema.ts
@src/lib/content/version.ts
@src/lib/content/markdown.ts
@src/lib/wiki/queries.ts
@src/app/(wiki)/wiki/[articleSlug]/page.tsx
@src/components/wiki/article-tabs.tsx
@src/app/globals.css
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install BlockNote packages and configure Tailwind</name>
  <files>
    package.json
    src/app/globals.css
  </files>
  <action>
    1. Install BlockNote packages (version-locked to match existing @blocknote/server-util@0.46.2):
       `npm install @blocknote/core@0.46.2 @blocknote/react@0.46.2 @blocknote/shadcn@0.46.2`

    2. Add @source directive to globals.css for Tailwind v4 to scan BlockNote shadcn classes.
       Add this line AFTER the existing @import lines and BEFORE the @plugin line:
       `@source "../node_modules/@blocknote/shadcn";`

    3. Also add BlockNote CSS imports note -- the actual CSS imports happen in the client component file (article-editor.tsx), not in globals.css.
  </action>
  <verify>
    Run `npm ls @blocknote/core @blocknote/react @blocknote/shadcn` -- all should show 0.46.2.
    Verify globals.css contains the @source directive.
  </verify>
  <done>BlockNote packages installed at 0.46.2, Tailwind configured to scan BlockNote shadcn classes.</done>
</task>

<task type="auto">
  <name>Task 2: Create BlockNote editor component, edit page, save API, and Edit button</name>
  <files>
    src/components/editor/article-editor.tsx
    src/components/editor/editor-save-dialog.tsx
    src/app/(wiki)/wiki/[articleSlug]/edit/page.tsx
    src/app/api/articles/[id]/save/route.ts
    src/app/(wiki)/wiki/[articleSlug]/page.tsx
    src/lib/wiki/queries.ts
  </files>
  <action>
    **A. Create src/components/editor/article-editor.tsx** (client component, "use client"):

    This is the main editor wrapper. It must:
    - Import useCreateBlockNote from @blocknote/react
    - Import BlockNoteView from @blocknote/shadcn
    - Import CSS: @blocknote/core/fonts/inter.css and @blocknote/shadcn/style.css
    - Accept props: articleId (string), initialContentJson (unknown | null), initialContentMarkdown (string), articleUpdatedAt (string -- ISO date for optimistic locking), onSaveSuccess (optional callback)
    - Accept optional uploadFile prop: (file: File) => Promise&lt;string&gt; (will be wired up in Plan 02 for images; for now pass undefined)
    - Content loading strategy:
      * State: `isReady` boolean, initially false
      * Create editor with useCreateBlockNote({ uploadFile }) -- no initialContent yet
      * useEffect: if initialContentJson exists and is a non-empty array, call editor.replaceBlocks(editor.document, initialContentJson as any[]) then set isReady=true
      * useEffect: if initialContentJson is null/empty, call editor.tryParseMarkdownToBlocks(initialContentMarkdown).then(blocks => { editor.replaceBlocks(editor.document, blocks); setIsReady(true); })
      * Show a Skeleton placeholder until isReady
    - onChange handler on BlockNoteView: auto-save to localStorage with key `draft-${articleId}`. Store JSON.stringify(editor.document).
    - Draft recovery: on mount, check localStorage for `draft-${articleId}`. If found AND initialContentJson is null (no saved JSON in DB), show a "Restore draft?" banner with Restore and Discard buttons. Restore applies the draft blocks; Discard clears localStorage.
    - Save handler (called from save dialog):
      * Get blocks: editor.document (this IS the BlockNote JSON array)
      * Convert to markdown: await editor.blocksToMarkdownLossy(editor.document)
      * POST to /api/articles/${articleId}/save with body { contentJson: editor.document, contentMarkdown, changeSummary, loadedUpdatedAt: articleUpdatedAt }
      * On 409 response: show toast error "Article was modified externally. Please reload."
      * On success: clear localStorage draft, call onSaveSuccess if provided, show toast "Saved"
    - Render: BlockNoteView with editor prop. Place a sticky toolbar area at the top with a Save button (lucide Save icon) that opens the EditorSaveDialog.
    - Back button: Link back to /wiki/[slug] using the article slug (pass as prop or derive from articleId -- simpler to pass articleSlug as a prop)

    **B. Create src/components/editor/editor-save-dialog.tsx** (client component):

    A shadcn Dialog that:
    - Opens when user clicks Save
    - Contains a Textarea for optional change summary (placeholder: "Describe your changes (optional)")
    - Has Cancel and Save buttons
    - Save button calls the parent's onSave(changeSummary) callback
    - Shows loading state while saving (disabled button, spinner)

    **C. Create src/app/(wiki)/wiki/[articleSlug]/edit/page.tsx** (server component):

    - Auth guard: require authenticated session (redirect to /login if not)
    - Load article using a modified getArticleBySlug that also returns contentJson. Update getArticleBySlug in queries.ts to ALSO select articles.contentJson.
    - If article not found, return notFound()
    - Render the editor using next/dynamic with ssr: false:
      ```
      const DynamicEditor = dynamic(
        () => import("@/components/editor/article-editor").then(m => ({ default: m.ArticleEditor })),
        { ssr: false, loading: () => <EditorSkeleton /> }
      );
      ```
    - Pass: articleId, articleSlug, initialContentJson (article.contentJson), initialContentMarkdown (article.contentMarkdown), articleUpdatedAt (article.updatedAt.toISOString())
    - Simple layout: breadcrumb at top (reuse ArticleBreadcrumb), then "Editing: {title}" header, then the dynamic editor

    **D. Create src/app/api/articles/[id]/save/route.ts** (API route):

    POST handler that:
    - Auth guard: require authenticated session (return 401 if not)
    - Parse body: { contentJson, contentMarkdown, changeSummary, loadedUpdatedAt }
    - Optimistic locking: fetch article.updatedAt, compare with loadedUpdatedAt. If different, return 409 { error: "Article was modified. Please reload." }
    - Update articles table: set contentMarkdown, contentJson, hasHumanEdits=true, lastHumanEditedAt=new Date(), lastHumanEditorId=session.user.id, updatedAt=new Date()
    - Create version record via createArticleVersion({ articleId, contentMarkdown, contentJson, changeSource: "human_edited", changeSummary: changeSummary || null, createdBy: session.user.id })
    - Return 200 { success: true }

    **E. Update src/lib/wiki/queries.ts getArticleBySlug**:

    Add `contentJson: articles.contentJson` to the select fields, and include it in the returned article object.

    **F. Update src/app/(wiki)/wiki/[articleSlug]/page.tsx**:

    Add an "Edit" button (lucide Pencil icon) next to the Bookmark and Regenerate buttons. It should link to `/wiki/${article.slug}/edit`. Visible to all authenticated users (not just admin).
    Use a Next.js Link component with Button styling (variant="outline", size="sm").

    IMPORTANT: Do NOT pass shadCNComponents prop to BlockNoteView -- use the built-in components from @blocknote/shadcn to avoid Portal positioning issues.
  </action>
  <verify>
    Run `npm run build` -- should compile without errors.
    The edit page route at /wiki/[articleSlug]/edit should be accessible.
    The save API at /api/articles/[id]/save should exist.
    The article page should show an Edit button.
  </verify>
  <done>
    Users can click Edit on any article, see a BlockNote WYSIWYG editor with content loaded (from JSON or converted from markdown).
    Drafts auto-save to localStorage on every change.
    Clicking Save opens a dialog for optional change summary, saves content (JSON + markdown) to the database via API, creates a version record, sets hasHumanEdits flag.
    Optimistic locking prevents stale saves with 409 response.
  </done>
</task>

</tasks>

<verification>
1. Navigate to any article page -- Edit button visible next to Bookmark/Regenerate
2. Click Edit -- editor loads with article content in BlockNote WYSIWYG
3. Make changes -- localStorage draft updates automatically
4. Click Save -- dialog prompts for change summary
5. Submit save -- version record created, article updated, redirects back to article
6. Check article_versions table -- new record with change_source human_edited
7. Check articles table -- hasHumanEdits=true, contentJson populated, contentMarkdown regenerated
8. Open editor again after external modification -- save returns 409
</verification>

<success_criteria>
- BlockNote editor renders at /wiki/[articleSlug]/edit with full toolbar (headings, bold, italic, code, links, tables, lists)
- Editor loads contentJson directly when available, converts contentMarkdown client-side when contentJson is null
- localStorage draft persists across page refreshes
- Save creates article_versions record and updates article with both contentJson and contentMarkdown
- Optimistic locking returns 409 on stale save attempts
- Build passes without BlockNote SSR errors (ssr: false dynamic import)
</success_criteria>

<output>
After completion, create `.planning/phases/05-article-editing/05-01-SUMMARY.md`
</output>
