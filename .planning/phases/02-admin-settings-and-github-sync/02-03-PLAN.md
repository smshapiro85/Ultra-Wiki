---
phase: 02-admin-settings-and-github-sync
plan: 03
type: execute
wave: 3
depends_on: ["02-01", "02-02"]
files_modified:
  - src/app/api/admin/sync/cron/route.ts
  - src/lib/github/schedule.ts
  - src/app/(admin)/admin/sync/sync-history.tsx
  - src/app/(admin)/admin/sync/page.tsx
  - .env.example
  - docker-compose.yml
autonomous: true
user_setup:
  - service: cron
    why: "Scheduled sync requires external cron trigger"
    env_vars:
      - name: CRON_SECRET
        source: "Generate with: openssl rand -base64 32"
    dashboard_config:
      - task: "Set up host cron or Docker cron sidecar"
        location: "Host crontab or docker-compose.yml cron service"

must_haves:
  truths:
    - "A cron-triggered API route exists at /api/admin/sync/cron that accepts POST with Bearer CRON_SECRET auth"
    - "The cron route checks the admin-configured sync schedule before running -- it only syncs when the schedule says it is due"
    - "Scheduled syncs use the same sync engine as manual syncs (same lock, same change detection)"
    - "Admin can view a detailed sync history table showing all past syncs with status, trigger type, duration, file counts, and errors"
    - "Admin can see current sync status (running/idle) in the sync dashboard"
    - "CRON_SECRET environment variable is documented in .env.example"
  artifacts:
    - path: "src/app/api/admin/sync/cron/route.ts"
      provides: "Cron-triggered sync endpoint with Bearer auth"
      exports: ["POST"]
    - path: "src/lib/github/schedule.ts"
      provides: "Schedule checking logic using cron-parser"
      exports: ["isSyncDue"]
    - path: "src/app/(admin)/admin/sync/sync-history.tsx"
      provides: "Sync history table component"
      min_lines: 30
  key_links:
    - from: "src/app/api/admin/sync/cron/route.ts"
      to: "src/lib/github/sync.ts"
      via: "runSync('scheduled') call"
      pattern: "runSync.*scheduled"
    - from: "src/app/api/admin/sync/cron/route.ts"
      to: "src/lib/github/schedule.ts"
      via: "isSyncDue check before running"
      pattern: "isSyncDue"
    - from: "src/lib/github/schedule.ts"
      to: "src/lib/settings/index.ts"
      via: "getSetting for sync_cron_schedule"
      pattern: "getSetting.*sync_cron_schedule"
---

<objective>
Build the cron-triggered sync endpoint, schedule-checking logic, and sync history dashboard to complete the automated sync lifecycle.

Purpose: Manual sync (Plan 02-02) handles on-demand syncs. This plan adds the scheduled automation: an external cron hits the API route at a fixed interval (e.g., every 5 minutes), the route checks if the admin-configured schedule says a sync is due, and runs it if so. The sync history dashboard gives admins full visibility into past and current sync operations.
Output: Cron API route at `/api/admin/sync/cron`, schedule checker, enhanced sync dashboard with detailed history table.
</objective>

<execution_context>
@/Users/michael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-admin-settings-and-github-sync/02-RESEARCH.md
@.planning/phases/02-admin-settings-and-github-sync/02-01-SUMMARY.md
@.planning/phases/02-admin-settings-and-github-sync/02-02-SUMMARY.md

Key existing files:
@src/lib/github/sync.ts (runSync, acquireSyncLock -- created by Plan 02-02)
@src/lib/settings/index.ts (getSetting -- created by Plan 02-01)
@src/lib/settings/constants.ts (SETTING_KEYS -- created by Plan 02-01)
@src/app/(admin)/admin/sync/page.tsx (sync dashboard -- created by Plan 02-02)
@src/app/(admin)/admin/sync/actions.ts (getRecentSyncLogs -- created by Plan 02-02)
@src/lib/db/schema.ts (syncLogs table definition)
@.env.example
@docker-compose.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Cron API route and schedule checking logic</name>
  <files>
    src/app/api/admin/sync/cron/route.ts
    src/lib/github/schedule.ts
    .env.example
    docker-compose.yml
  </files>
  <action>
**`src/lib/github/schedule.ts`** -- Schedule checking:
- `isSyncDue(): Promise<boolean>` -- reads `sync_cron_schedule` setting from DB. If not set or empty, return false (no schedule configured). Parse the cron expression with `cron-parser` (use `parseExpression` or the v5 API -- check the installed version). Get the last completed sync from sync_logs (most recent with status "completed", ordered by completedAt DESC). If no completed syncs exist, the sync is due. Otherwise, compute `prev()` occurrence from the cron parser based on current time. If `prev()` is after the last completed sync's completedAt, sync is due. Return boolean.
- Import `CronExpressionParser` from `cron-parser` (v5 uses this class-based API: `CronExpressionParser.parse(expression)` returns an iterator with `.prev()` and `.next()` methods).

**`src/app/api/admin/sync/cron/route.ts`** -- Cron endpoint:
- POST handler.
- Auth check: read `CRON_SECRET` from `process.env`. If not set, log warning and return 500 `{ error: "CRON_SECRET not configured" }`. If set, compare against Authorization header (`Bearer ${CRON_SECRET}`). Reject with 401 if mismatch.
- Call `isSyncDue()`. If not due, return 200 `{ skipped: true, reason: "Not scheduled yet" }`.
- If due, call `runSync("scheduled")` from `@/lib/github/sync`.
- Return result: success with stats, or error.
- No session auth check (this is machine-to-machine, not user-triggered).

**`.env.example`** -- Add:
```
# Cron Sync
CRON_SECRET=generate-with-openssl-rand-base64-32
```

**`docker-compose.yml`** -- Add a comment block showing how to set up cron (do NOT add a cron service by default -- keep it as documentation):
```yaml
# Scheduled sync: set up a host cron job to trigger syncs:
# */5 * * * * curl -s -X POST -H "Authorization: Bearer $CRON_SECRET" http://localhost:3000/api/admin/sync/cron
# The route checks the admin-configured schedule internally, so the cron can run frequently (e.g., every 5 min).
```
  </action>
  <verify>
- `npx tsc --noEmit` passes
- `npm run build` succeeds with `/api/admin/sync/cron` route in output
- Grep confirms `CRON_SECRET` check in route.ts
- Grep confirms `isSyncDue` calls cron-parser
  </verify>
  <done>
Cron endpoint at /api/admin/sync/cron authenticates via CRON_SECRET Bearer token, checks if a sync is due based on admin-configured schedule using cron-parser, and triggers runSync("scheduled") only when due. .env.example documents CRON_SECRET. docker-compose.yml documents cron setup.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhanced sync history dashboard</name>
  <files>
    src/app/(admin)/admin/sync/sync-history.tsx
    src/app/(admin)/admin/sync/page.tsx
    src/app/(admin)/admin/sync/actions.ts
  </files>
  <action>
**`src/app/(admin)/admin/sync/actions.ts`** -- Add/update server actions:
- `getActiveSyncStatus(): Promise<{ isRunning: boolean; syncLogId?: string; startedAt?: Date } | null>` -- queries sync_logs for any row with status "running". Returns running status info or null.
- Update `getRecentSyncLogs()` to return richer data: id, status, triggerType, startedAt, completedAt, filesProcessed, articlesCreated, articlesUpdated, errorMessage, createdAt. Increase limit to 20. Compute duration (completedAt - startedAt) as a derived field in the return.

**`src/app/(admin)/admin/sync/sync-history.tsx`** -- "use client" component:
- Renders a shadcn Table showing sync history.
- Columns: Status (badge: green for completed, red for failed, yellow/spinning for running), Trigger (manual/scheduled badge), Started, Duration (human-readable, e.g., "2m 34s"), Files Processed, Error (truncated with tooltip or expandable).
- Status badges use shadcn Badge component with appropriate variant colors.
- If a sync is currently running, show it at the top with a pulsing indicator.
- Empty state: "No syncs have been run yet. Use the button above to trigger your first sync."

**`src/app/(admin)/admin/sync/page.tsx`** -- Update:
- Add a status banner at the top: if a sync is running, show "Sync in progress..." with the start time and a pulsing dot.
- Layout: full-width page with sections stacked vertically:
  1. Status banner (conditional)
  2. Two-column grid (lg breakpoint): File Tree (left, wider) | Sync Controls (right, narrower)
  3. Sync History table (full width below)
- Pass active sync status and recent logs as props from server-side data loading.
- The SyncTrigger component should be disabled if a sync is already running.

Ensure the sync dashboard provides at-a-glance visibility: is a sync running? When was the last sync? Did it succeed? How many files were processed?
  </action>
  <verify>
- `npm run build` succeeds
- `npx tsc --noEmit` passes
- Grep confirms sync-history.tsx renders Table with status badges
- Build output shows /admin/sync route
  </verify>
  <done>
Sync dashboard shows current sync status (running/idle), file tree with inclusion checkboxes, manual sync trigger (disabled during active sync), and a detailed sync history table with status badges, duration, file counts, and error messages. The last 20 sync operations are visible.
  </done>
</task>

</tasks>

<verification>
1. Cron endpoint rejects requests without valid CRON_SECRET Bearer token (returns 401)
2. Cron endpoint skips sync when schedule says it's not due (returns 200 with skipped=true)
3. Cron endpoint triggers sync when schedule says it's due (same as manual sync)
4. Schedule checking correctly uses cron-parser to determine if sync is due based on last completed sync time
5. Sync history table displays all past syncs with accurate status, duration, and file counts
6. Running sync shows as active in both the status banner and history table
7. CRON_SECRET documented in .env.example
8. Docker cron setup documented in docker-compose.yml comments
</verification>

<success_criteria>
- External cron can trigger scheduled syncs via POST to /api/admin/sync/cron with Bearer auth
- Scheduled syncs only run when the admin-configured cron schedule says they're due
- Sync history provides full visibility into all past sync operations
- Dashboard shows at-a-glance sync health: current status, last sync result, recent history
- All Phase 2 success criteria met: settings configurable, file tree browsable, sync works manually and on schedule, history visible
</success_criteria>

<output>
After completion, create `.planning/phases/02-admin-settings-and-github-sync/02-03-SUMMARY.md`
</output>
