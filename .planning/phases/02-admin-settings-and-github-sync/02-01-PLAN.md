---
phase: 02-admin-settings-and-github-sync
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/settings/index.ts
  - src/lib/settings/constants.ts
  - src/app/(admin)/admin/settings/page.tsx
  - src/app/(admin)/admin/settings/actions.ts
  - src/app/(admin)/admin/settings/general-settings.tsx
  - src/app/(admin)/admin/settings/api-keys-settings.tsx
  - src/app/(admin)/admin/settings/ai-prompts-settings.tsx
  - src/app/api/admin/settings/test-connection/route.ts
  - src/app/(admin)/layout.tsx
  - src/components/ui/tabs.tsx
  - src/components/ui/textarea.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Admin can view and edit GitHub repo URL and branch from settings dashboard"
    - "Admin can enter API keys (GitHub, OpenRouter, SendGrid, Slack) via masked inputs -- saved values are never sent back to frontend"
    - "Admin can edit all four AI prompts (analysis, article style, global Ask AI, page-level Ask AI)"
    - "Admin can configure sync schedule as a cron expression with human-readable preview"
    - "Admin can test OpenRouter and GitHub connections from the settings page"
    - "Secret values display as '********' in the UI -- submitting unchanged masks does not overwrite real values"
  artifacts:
    - path: "src/lib/settings/index.ts"
      provides: "getSetting, setSetting, getSettingsForUI helper functions"
      exports: ["getSetting", "setSetting", "getSettingsForUI"]
    - path: "src/lib/settings/constants.ts"
      provides: "SETTING_KEYS enum, SECRET_KEYS set, MASK_VALUE constant"
      exports: ["SETTING_KEYS", "SECRET_KEYS", "MASK_VALUE"]
    - path: "src/app/(admin)/admin/settings/page.tsx"
      provides: "Settings dashboard with tabbed layout"
      min_lines: 30
    - path: "src/app/(admin)/admin/settings/actions.ts"
      provides: "Server actions for loading and saving settings"
      exports: ["saveGeneralSettings", "saveApiKeys", "saveAiPrompts", "loadSettings"]
    - path: "src/app/api/admin/settings/test-connection/route.ts"
      provides: "POST endpoint for testing API key connections"
      exports: ["POST"]
  key_links:
    - from: "src/app/(admin)/admin/settings/actions.ts"
      to: "src/lib/settings/index.ts"
      via: "getSettingsForUI and setSetting calls"
      pattern: "(getSettingsForUI|setSetting)"
    - from: "src/app/(admin)/admin/settings/api-keys-settings.tsx"
      to: "/api/admin/settings/test-connection"
      via: "fetch POST for test button"
      pattern: "fetch.*test-connection"
    - from: "src/lib/settings/index.ts"
      to: "src/lib/db/schema.ts"
      via: "Drizzle queries on siteSettings table"
      pattern: "siteSettings"
---

<objective>
Build the admin settings dashboard with a key-value settings library and tabbed UI for configuring GitHub repo, API keys, AI prompts, and sync schedule.

Purpose: Admins need a central place to configure all external integrations (GitHub, OpenRouter, SendGrid, Slack) and AI behavior before any sync or AI features can work. This plan creates the settings infrastructure that Plans 02-02 and 02-03 depend on.
Output: Settings library (`src/lib/settings/`), settings dashboard at `/admin/settings` with three tabs, test-connection API route, updated admin navigation.
</objective>

<execution_context>
@/Users/michael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-admin-settings-and-github-sync/02-RESEARCH.md

Key existing files to reference:
@src/lib/db/schema.ts (siteSettings table definition)
@src/lib/db/index.ts (getDb pattern)
@src/lib/db/seed.ts (existing setting keys and descriptions)
@src/app/(admin)/admin/users/actions.ts (requireAdmin pattern)
@src/app/(admin)/layout.tsx (admin nav to update)
@src/app/(wiki)/profile/actions.ts (server action + Zod validation pattern)
@src/app/(wiki)/profile/profile-form.tsx (useActionState form pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Settings library and server actions</name>
  <files>
    src/lib/settings/index.ts
    src/lib/settings/constants.ts
    src/app/(admin)/admin/settings/actions.ts
    src/app/api/admin/settings/test-connection/route.ts
  </files>
  <action>
Create the settings infrastructure:

**`src/lib/settings/constants.ts`** -- Define SETTING_KEYS object with all 12 keys from seed.ts (match the exact key names: `github_repo_url`, `github_api_key`, `openrouter_api_key`, `openrouter_model`, `sync_cron_schedule`, `sendgrid_api_key`, `sendgrid_from_email`, `slack_bot_token`, `analysis_prompt`, `article_style_prompt`, `ask_ai_global_prompt`, `ask_ai_page_prompt`). Also add `github_branch` key (default "main"). Define SECRET_KEYS as a Set containing the 4 secret keys. Define MASK_VALUE = "********". Export all.

**`src/lib/settings/index.ts`** -- Three functions:
- `getSetting(key: string): Promise<string | null>` -- queries siteSettings by key, returns value or null
- `setSetting(key: string, value: string, isSecret?: boolean): Promise<void>` -- upsert using onConflictDoUpdate on siteSettings.key
- `getSettingsForUI(keys: string[]): Promise<Record<string, { value: string; isSecret: boolean }>>` -- fetches multiple settings, replaces secret values with MASK_VALUE for display (empty string if no value set yet)

Follow the exact patterns from research (Pattern 1). Use `getDb()` from `@/lib/db`, `eq`/`inArray` from drizzle-orm, `siteSettings` from schema.

**`src/app/(admin)/admin/settings/actions.ts`** -- Server actions with "use server" directive:
- `requireAdmin()` helper (same pattern as users/actions.ts)
- `loadSettings()` -- calls getSettingsForUI with all SETTING_KEYS, returns the record
- `saveGeneralSettings(prevState, formData)` -- saves github_repo_url, github_branch, sync_cron_schedule. Validate cron expression with cron-parser before saving (return error if invalid). Use Zod v4 (`import { z } from "zod/v4"`) for validation.
- `saveApiKeys(prevState, formData)` -- saves github_api_key, openrouter_api_key, openrouter_model, sendgrid_api_key, sendgrid_from_email, slack_bot_token. CRITICAL: skip saving any key whose value equals MASK_VALUE (admin didn't change it).
- `saveAiPrompts(prevState, formData)` -- saves analysis_prompt, article_style_prompt, ask_ai_global_prompt, ask_ai_page_prompt.
- All save actions return `{ success: boolean; error?: string }` and call `revalidatePath("/admin/settings")`.

**`src/app/api/admin/settings/test-connection/route.ts`** -- POST route:
- Check admin auth via `auth()` from `@/lib/auth`
- Accept JSON body `{ type: "github" | "openrouter", apiKey: string }`
- For "github": create Octokit with the provided apiKey, call `octokit.rest.users.getAuthenticated()`, return success/failure
- For "openrouter": fetch `https://openrouter.ai/api/v1/models` with Bearer auth header, return success/failure
- Return JSON `{ success: boolean; error?: string }`

Install dependencies: `npm install @octokit/rest cronstrue cron-parser`
  </action>
  <verify>
- `npx tsc --noEmit` passes
- `npm run build` succeeds
- Grep for MASK_VALUE in actions.ts confirms skip logic exists
  </verify>
  <done>
Settings library functions work with siteSettings table. Server actions load/save all 13 setting keys with secret masking. Test connection route validates GitHub and OpenRouter API keys. cron-parser validates cron expressions before saving.
  </done>
</task>

<task type="auto">
  <name>Task 2: Settings dashboard UI with tabs and admin nav update</name>
  <files>
    src/app/(admin)/admin/settings/page.tsx
    src/app/(admin)/admin/settings/general-settings.tsx
    src/app/(admin)/admin/settings/api-keys-settings.tsx
    src/app/(admin)/admin/settings/ai-prompts-settings.tsx
    src/app/(admin)/layout.tsx
    src/components/ui/tabs.tsx
    src/components/ui/textarea.tsx
  </files>
  <action>
Add shadcn/ui components: `npx shadcn@latest add tabs textarea` (non-interactive: use --yes flag or equivalent).

**`src/app/(admin)/admin/settings/page.tsx`** -- Server component:
- Call `loadSettings()` to get all settings
- Render page title "Settings"
- Use shadcn Tabs with three tabs: "General", "API Keys", "AI Prompts"
- Pass relevant settings to each tab's client component

**`src/app/(admin)/admin/settings/general-settings.tsx`** -- "use client" component:
- Form with useActionState bound to saveGeneralSettings
- Fields: GitHub Repository URL (Input, placeholder "https://github.com/owner/repo"), Branch (Input, default "main"), Sync Schedule (Input for cron expression)
- Below the cron input, show human-readable preview using cronstrue.toString() in a try/catch (show error text if invalid). This is client-side only for immediate feedback.
- Submit button. Show toast on success/error using sonner.
- Use the established pattern: useActionState + useEffect for toast (see profile-form.tsx pattern)

**`src/app/(admin)/admin/settings/api-keys-settings.tsx`** -- "use client" component:
- Form with useActionState bound to saveApiKeys
- Fields grouped in Cards:
  - GitHub: API Key (Input type="password", placeholder shows "********" if has value)
  - OpenRouter: API Key (Input type="password"), Model Name (Input, shows current value)
  - SendGrid: API Key (Input type="password"), From Email (Input type="email")
  - Slack: Bot Token (Input type="password")
- Each secret input: if the setting has a value (isSecret && value === MASK_VALUE), show placeholder "Enter new value to update". If empty, show "Not configured".
- "Test Connection" buttons next to GitHub API Key and OpenRouter API Key fields. On click, fetch POST to `/api/admin/settings/test-connection` with the current input value (NOT the masked value -- use the actual input field value). Show success/error inline via local state.
- Submit button. Toast feedback.

**`src/app/(admin)/admin/settings/ai-prompts-settings.tsx`** -- "use client" component:
- Form with useActionState bound to saveAiPrompts
- Four Textarea fields (rows=6): Code Analysis Prompt, Article Style Prompt, Global Ask AI Prompt, Page-level Ask AI Prompt
- Show description text below each textarea explaining its purpose
- Submit button. Toast feedback.

**`src/app/(admin)/layout.tsx`** -- Update admin nav:
- Add "Settings" link pointing to `/admin/settings`
- Add "Sync" link pointing to `/admin/sync` (page doesn't exist yet -- it will be created in Plan 02-02/02-03, but the nav link should be present now)
- Keep existing "Users" link
  </action>
  <verify>
- `npm run build` succeeds with no errors
- The build output shows `/admin/settings` route exists
- `npx tsc --noEmit` passes
  </verify>
  <done>
Admin can navigate to /admin/settings and see three tabs. General tab shows repo URL, branch, and cron schedule with human-readable preview. API Keys tab shows masked inputs with test connection buttons for GitHub and OpenRouter. AI Prompts tab shows four textareas. Admin nav includes Settings, Sync, and Users links.
  </done>
</task>

</tasks>

<verification>
1. Settings library correctly masks secrets: getSettingsForUI returns "********" for secret keys with values, empty string for unset secrets
2. Saving settings with masked values ("********") does NOT overwrite real secrets in database
3. Cron expression validation rejects invalid expressions and accepts valid ones (e.g., "0 9 * * 6")
4. Test connection buttons work for GitHub (validates token) and OpenRouter (validates key)
5. All 13 setting keys are accessible and editable through the dashboard
6. Admin nav shows links to Settings, Sync, and Users pages
</verification>

<success_criteria>
- Admin can save and load all settings (GitHub config, API keys, AI prompts, cron schedule)
- Secret values are never exposed to the frontend -- always masked with "********"
- Saving unchanged masked values preserves original secrets
- Cron schedule shows human-readable preview
- Test connection validates GitHub and OpenRouter API keys
- Settings library is importable by Plans 02-02 and 02-03
</success_criteria>

<output>
After completion, create `.planning/phases/02-admin-settings-and-github-sync/02-01-SUMMARY.md`
</output>
