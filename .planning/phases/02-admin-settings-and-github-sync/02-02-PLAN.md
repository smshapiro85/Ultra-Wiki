---
phase: 02-admin-settings-and-github-sync
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/lib/github/client.ts
  - src/lib/github/tree.ts
  - src/lib/github/sync.ts
  - src/app/(admin)/admin/sync/page.tsx
  - src/app/(admin)/admin/sync/actions.ts
  - src/app/(admin)/admin/sync/file-tree.tsx
  - src/app/(admin)/admin/sync/sync-trigger.tsx
  - src/app/api/admin/sync/route.ts
  - src/components/ui/checkbox.tsx
  - src/components/ui/scroll-area.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "System fetches the full repo file tree from GitHub via Octokit and stores file paths/SHAs in github_files table"
    - "Admin can browse a visual file tree with checkboxes showing the repo structure"
    - "All files are excluded by default -- admin checks boxes to include files/folders for sync"
    - "Inclusion rules persist in excluded_paths table (repurposed as included_paths) and survive across syncs"
    - "Including a folder includes all its children; new files in included directories are auto-included on next sync"
    - "System detects changed/added/removed files by comparing remote SHAs against stored github_files SHAs"
    - "Admin can trigger a manual sync that fetches the tree, detects changes, updates github_files, and shows progress"
    - "Only one sync can run at a time -- concurrent sync attempts are rejected with a clear message"
  artifacts:
    - path: "src/lib/github/client.ts"
      provides: "Octokit client factory reading API key from settings"
      exports: ["getOctokit", "parseRepoUrl"]
    - path: "src/lib/github/tree.ts"
      provides: "Tree fetching and path inclusion/exclusion logic"
      exports: ["fetchRepoTree", "isPathIncluded"]
    - path: "src/lib/github/sync.ts"
      provides: "Sync orchestration: lock acquisition, change detection, github_files upsert"
      exports: ["runSync", "acquireSyncLock", "releaseSyncLock", "detectChanges"]
    - path: "src/app/(admin)/admin/sync/page.tsx"
      provides: "Sync dashboard page with file tree and manual trigger"
      min_lines: 20
    - path: "src/app/(admin)/admin/sync/file-tree.tsx"
      provides: "Interactive file tree with checkboxes for inclusion"
      min_lines: 50
    - path: "src/app/api/admin/sync/route.ts"
      provides: "POST endpoint to trigger manual sync"
      exports: ["POST"]
  key_links:
    - from: "src/lib/github/client.ts"
      to: "src/lib/settings/index.ts"
      via: "getSetting for github_api_key"
      pattern: "getSetting.*github_api_key"
    - from: "src/lib/github/sync.ts"
      to: "src/lib/db/schema.ts"
      via: "Drizzle queries on githubFiles and syncLogs tables"
      pattern: "(githubFiles|syncLogs)"
    - from: "src/app/(admin)/admin/sync/actions.ts"
      to: "src/lib/github/tree.ts"
      via: "fetchRepoTree for file tree display"
      pattern: "fetchRepoTree"
    - from: "src/app/api/admin/sync/route.ts"
      to: "src/lib/github/sync.ts"
      via: "runSync call for manual trigger"
      pattern: "runSync"
---

<objective>
Build the GitHub integration layer: Octokit client, file tree fetching with SHA tracking, interactive file tree UI with inclusion checkboxes, incremental change detection, and manual sync with concurrency locking.

Purpose: This is the core data pipeline -- connecting the wiki to the GitHub repo. Without this, Phase 3 (AI processing) has no source files to analyze. The inclusion model ensures admins control exactly what gets synced.
Output: GitHub library (`src/lib/github/`), sync dashboard at `/admin/sync` with file tree and manual sync trigger.
</objective>

<execution_context>
@/Users/michael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-admin-settings-and-github-sync/02-RESEARCH.md
@.planning/phases/02-admin-settings-and-github-sync/02-01-SUMMARY.md

Key existing files:
@src/lib/db/schema.ts (githubFiles, excludedPaths, syncLogs tables)
@src/lib/db/index.ts (getDb pattern)
@src/lib/settings/index.ts (getSetting -- created by Plan 02-01)
@src/lib/settings/constants.ts (SETTING_KEYS -- created by Plan 02-01)
@src/app/(admin)/admin/users/actions.ts (requireAdmin pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: GitHub client, tree fetching, sync engine with concurrency lock</name>
  <files>
    src/lib/github/client.ts
    src/lib/github/tree.ts
    src/lib/github/sync.ts
  </files>
  <action>
**`src/lib/github/client.ts`** -- Octokit factory:
- `getOctokit(): Promise<Octokit>` -- reads `github_api_key` from settings via getSetting, creates and returns Octokit instance. Throws descriptive error if key not configured.
- `parseRepoUrl(url: string): { owner: string; repo: string } | null` -- parses GitHub URLs in multiple formats: `https://github.com/owner/repo`, `github.com/owner/repo`, `owner/repo`. Strip trailing `.git`. Return null if unparseable.
- `getRepoConfig(): Promise<{ owner: string; repo: string; branch: string }>` -- reads github_repo_url and github_branch from settings, parses URL, returns config. Throws if not configured or unparseable.

**`src/lib/github/tree.ts`** -- Tree operations:
- Interface `TreeFile { path: string; sha: string; size: number; type: "blob" | "tree" }`.
- `fetchRepoTree(octokit, owner, repo, branch): Promise<TreeFile[]>` -- uses `octokit.git.getRef` to get HEAD SHA, then `octokit.git.getTree` with `recursive: "true"`. Filter to blobs and trees (both needed for the file tree UI -- blobs are files, trees are directories). Warn if truncated. Return array of TreeFile.
- `isPathIncluded(filePath: string, includedPatterns: string[]): boolean` -- checks if a file path matches any included pattern. Logic: returns true if (a) filePath exactly matches a pattern, (b) filePath starts with `pattern + "/"` (file inside included directory), or (c) a pattern starts with `filePath + "/"` (parent of an included path -- needed so parent directories show in tree). If includedPatterns is empty, return false (nothing included by default).
- `buildTreeStructure(files: TreeFile[]): TreeNode[]` -- converts flat file list into a nested tree structure for the UI. Each TreeNode has: `{ name: string; path: string; type: "file" | "directory"; children?: TreeNode[] }`. Sort directories first, then files, alphabetically.

**`src/lib/github/sync.ts`** -- Sync orchestration:
- `acquireSyncLock(triggerType: "manual" | "scheduled"): Promise<string | null>` -- atomic INSERT into sync_logs with status "running" using NOT EXISTS subquery (see research Pattern 2). Returns sync log ID if acquired, null if another sync is running.
- `releaseSyncLock(syncLogId, status, stats)` -- updates the sync_logs row with final status, completedAt, file counts, error message.
- Interface `ChangeSet { added: TreeFile[]; modified: TreeFile[]; removed: string[] }`.
- `detectChanges(remoteTree: TreeFile[], includedPatterns: string[]): Promise<ChangeSet>` -- loads all github_files from DB, builds a map by filePath. For each remote file that `isPathIncluded`, compare SHA. New = not in DB, modified = SHA differs, removed = in DB but not in filtered remote tree (only among included paths).
- `applyChanges(changeSet: ChangeSet): Promise<{ filesProcessed: number }>` -- For added files: INSERT into github_files with filePath, fileSha, lastSyncedAt=now(). For modified: UPDATE fileSha and lastSyncedAt. For removed: DELETE from github_files. Return count of files processed. Note: do NOT fetch file content -- only metadata (path, SHA). Content fetching is deferred to Phase 3.
- `runSync(triggerType: "manual" | "scheduled"): Promise<{ success: boolean; syncLogId?: string; error?: string; stats?: { filesProcessed: number; added: number; modified: number; removed: number } }>` -- orchestrates: (1) acquire lock, (2) read included patterns from excludedPaths table (repurposed), (3) get Octokit + repo config, (4) fetch tree, (5) detect changes, (6) apply changes, (7) release lock with stats. Wrap in try/catch -- on error, release lock with "failed" status and error message. Implement retry logic for transient errors: 3 retries with delays [1000, 4000, 16000]ms for network/rate-limit errors only. Auth errors (401) and not-found (404) fail immediately.

Important: The `excludedPaths` table is repurposed as "included paths" storage. The column `pattern` stores the path patterns that are INCLUDED (not excluded). Everything not matching an included pattern is excluded. This follows the roadmap success criteria: "all files/folders excluded by default, selectively include what to sync."
  </action>
  <verify>
- `npx tsc --noEmit` passes
- `npm run build` succeeds
- Grep confirms `acquireSyncLock` uses `NOT EXISTS` pattern
- Grep confirms `isPathIncluded` function exists with correct logic
  </verify>
  <done>
GitHub client creates Octokit from stored API key. Tree fetching retrieves full repo structure. Sync engine detects changes via SHA comparison against github_files table, applies changes (insert/update/delete metadata only), with atomic concurrency lock on sync_logs. Retry logic handles transient errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Sync dashboard with file tree UI and manual sync trigger</name>
  <files>
    src/app/(admin)/admin/sync/page.tsx
    src/app/(admin)/admin/sync/actions.ts
    src/app/(admin)/admin/sync/file-tree.tsx
    src/app/(admin)/admin/sync/sync-trigger.tsx
    src/app/api/admin/sync/route.ts
    src/components/ui/checkbox.tsx
    src/components/ui/scroll-area.tsx
  </files>
  <action>
Add shadcn/ui components: `npx shadcn@latest add checkbox scroll-area` (use --yes or non-interactive flags).

**`src/app/(admin)/admin/sync/actions.ts`** -- Server actions:
- `requireAdmin()` helper (same pattern)
- `loadFileTree(): Promise<{ tree: TreeNode[]; includedPaths: string[]; error?: string }>` -- reads github_repo_url and github_api_key from settings. If not configured, return error message. Otherwise, get Octokit, fetch repo tree, build tree structure, load included patterns from excludedPaths table. Return tree and included paths.
- `saveIncludedPaths(paths: string[]): Promise<{ success: boolean; error?: string }>` -- deletes all rows from excludedPaths table, then inserts new rows for each path in the array. Uses the admin's user ID as createdBy. Revalidates `/admin/sync`.
- `triggerManualSync(): Promise<{ success: boolean; syncLogId?: string; error?: string }>` -- calls runSync("manual") and returns result.
- `getSyncStatus(syncLogId: string): Promise<{ status: string; filesProcessed: number; error?: string } | null>` -- queries sync_logs by ID, returns current status and stats.
- `getRecentSyncLogs(): Promise<SyncLog[]>` -- queries sync_logs ordered by createdAt DESC, limit 10, for the sync history display.

**`src/app/(admin)/admin/sync/file-tree.tsx`** -- "use client" component:
- Recursive tree component. Each node shows: folder icon (lucide `Folder`/`FolderOpen`) or file icon (lucide `File`), the name, and a Checkbox.
- Directories are collapsible (click folder name toggles children visibility). Default collapsed except top-level.
- Checkbox behavior: checking a directory checks all children. Unchecking a directory unchecks all children. A directory shows indeterminate state if some but not all children are checked.
- The "included" state is derived from the includedPaths prop. A path is included if it's in the set or any ancestor directory is in the set.
- On change, collect all included file/directory paths and call saveIncludedPaths server action.
- Use a debounced save (500ms) so rapid clicking doesn't spam the server. Or use a "Save Inclusions" button at the top.
- Wrap the tree in a ScrollArea (shadcn) with max-height for scrollable long trees.
- Use Tailwind for indentation: each level indented by `pl-4` or `pl-6`.
- Show a message if no GitHub repo is configured: "Configure your GitHub repository URL in Settings to browse the file tree."
- Show loading state while tree is being fetched.

**`src/app/(admin)/admin/sync/sync-trigger.tsx`** -- "use client" component:
- "Run Manual Sync" button (shadcn Button).
- On click: calls triggerManualSync server action.
- Shows loading spinner while sync is running.
- After sync starts, poll getSyncStatus every 2 seconds until status is "completed" or "failed".
- Show result: success with stats (files processed, added, modified, removed) or error message.
- If sync is already running (lock not acquired), show "A sync is already in progress" message.

**`src/app/(admin)/admin/sync/page.tsx`** -- Server component:
- Page title: "Sync Dashboard"
- Two sections side by side (or stacked on mobile):
  - Left/top: File Tree section with Card wrapper, title "Repository Files", description "Select files and folders to include in sync. All files are excluded by default."
  - Right/bottom: Sync section with Card wrapper containing SyncTrigger component and recent sync logs table (last 10 entries showing status, trigger type, files processed, started/completed time, error if any).
- Load initial data server-side: call loadFileTree() and getRecentSyncLogs().

**`src/app/api/admin/sync/route.ts`** -- POST route for manual sync:
- Check admin auth via `auth()`
- Call `runSync("manual")`
- Return JSON result with sync stats or error
- This route is an alternative to the server action for programmatic access / testing. The UI uses the server action directly.
  </action>
  <verify>
- `npm run build` succeeds with `/admin/sync` route in output
- `npx tsc --noEmit` passes
- Grep confirms file-tree.tsx renders Checkbox components
- Grep confirms sync-trigger.tsx calls triggerManualSync
  </verify>
  <done>
Admin can navigate to /admin/sync, see the repo file tree with checkboxes (all unchecked by default), include files/folders, and save inclusion rules. Admin can trigger a manual sync that shows progress and results. Recent sync logs display below the trigger button. If no GitHub repo is configured, a helpful message directs admin to Settings.
  </done>
</task>

</tasks>

<verification>
1. Octokit client reads API key from site_settings and creates authenticated client
2. Tree fetching retrieves full repo structure including directories and files
3. File tree UI renders nested structure with collapsible directories and checkboxes
4. Inclusion model: all files excluded by default, checking includes, persists to excludedPaths table
5. Directory inclusion includes all children; new files in included directories auto-included next sync
6. SHA comparison correctly identifies added, modified, and removed files
7. Sync lock prevents concurrent syncs via atomic INSERT with NOT EXISTS
8. Manual sync trigger shows progress and results (files processed, changes)
9. Sync history shows last 10 sync operations with status and stats
</verification>

<success_criteria>
- Admin can browse GitHub repo file tree in the sync dashboard
- Checking a folder includes all its contents for sync
- Manual sync detects changes via SHA comparison and updates github_files metadata
- Only one sync runs at a time (concurrency lock works)
- Sync results display with counts of added/modified/removed files
- Recent sync history visible in the dashboard
</success_criteria>

<output>
After completion, create `.planning/phases/02-admin-settings-and-github-sync/02-02-SUMMARY.md`
</output>
