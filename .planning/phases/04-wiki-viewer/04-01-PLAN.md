---
phase: 04-wiki-viewer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(wiki)/layout.tsx
  - src/components/wiki/app-sidebar.tsx
  - src/components/wiki/category-tree.tsx
  - src/components/wiki/article-breadcrumb.tsx
  - src/lib/wiki/queries.ts
  - src/app/globals.css
  - src/components/ui/sidebar.tsx
  - src/components/ui/breadcrumb.tsx
  - src/components/ui/collapsible.tsx
  - src/components/ui/tooltip.tsx
  - src/components/ui/sheet.tsx
  - src/components/ui/skeleton.tsx
autonomous: true

must_haves:
  truths:
    - "Left sidebar displays a collapsible category/article tree with folder icons for categories and file icons for articles"
    - "Clicking a category expands/collapses its children; clicking an article navigates to /wiki/[articleSlug]"
    - "Sidebar collapses to icons on desktop via trigger button and becomes a sheet overlay on mobile"
    - "Breadcrumb shows Home > Category > Article path in the top header bar"
    - "UserMenu and site logo appear in the sidebar footer/header, not a separate top nav"
  artifacts:
    - path: "src/app/(wiki)/layout.tsx"
      provides: "SidebarProvider-wrapped layout with AppSidebar + SidebarInset"
      contains: "SidebarProvider"
    - path: "src/components/wiki/app-sidebar.tsx"
      provides: "Sidebar with category tree, logo, user menu"
      contains: "SidebarMenu"
    - path: "src/components/wiki/category-tree.tsx"
      provides: "Recursive collapsible category/article tree"
      contains: "CategoryNode"
    - path: "src/components/wiki/article-breadcrumb.tsx"
      provides: "Breadcrumb from category hierarchy"
      contains: "ArticleBreadcrumb"
    - path: "src/lib/wiki/queries.ts"
      provides: "Data access for categories, articles, search"
      exports: ["getCategoryTreeWithArticles", "getArticleBySlug", "getCategoryChain"]
  key_links:
    - from: "src/app/(wiki)/layout.tsx"
      to: "src/lib/wiki/queries.ts"
      via: "getCategoryTreeWithArticles() call in server component"
      pattern: "getCategoryTreeWithArticles"
    - from: "src/components/wiki/app-sidebar.tsx"
      to: "src/components/wiki/category-tree.tsx"
      via: "CategoryTree component receives categories prop"
      pattern: "CategoryTree"
    - from: "src/components/wiki/category-tree.tsx"
      to: "/wiki/[articleSlug]"
      via: "Next.js Link in SidebarMenuSubButton"
      pattern: "href=.*wiki/"
---

<objective>
Build the wiki app shell: SidebarProvider-based layout with collapsible category/article tree navigation, breadcrumb header, and the data access layer all wiki pages depend on.

Purpose: This is the foundation for all wiki viewer pages. The sidebar layout replaces the current simple nav+main layout, and the data queries serve Plans 02 and 03.
Output: Working sidebar navigation with category tree, breadcrumbs, responsive collapse, and query functions for articles/categories/search.
</objective>

<execution_context>
@/Users/michael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-wiki-viewer/04-RESEARCH.md
@src/app/(wiki)/layout.tsx
@src/app/(wiki)/page.tsx
@src/components/common/user-menu.tsx
@src/lib/db/schema.ts
@src/lib/db/index.ts
@src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies, add shadcn components, and create data access layer</name>
  <files>
    src/lib/wiki/queries.ts
    src/components/ui/sidebar.tsx
    src/components/ui/breadcrumb.tsx
    src/components/ui/collapsible.tsx
    src/components/ui/tooltip.tsx
    src/components/ui/sheet.tsx
    src/components/ui/skeleton.tsx
    src/app/globals.css
  </files>
  <action>
    1. Install npm dependencies:
       ```
       npm install react-markdown remark-gfm shiki @shikijs/rehype use-debounce @tailwindcss/typography
       ```
       Note: react-markdown, shiki, etc. are needed by Plan 02 but install now to avoid context waste later.
       Check if @tailwindcss/typography is already bundled with Tailwind v4 -- if `@import "@tailwindcss/typography"` works without install, skip the npm install for it. If Tailwind v4 does NOT bundle it, install it and add the import to globals.css.

    2. Add shadcn UI components:
       ```
       npx shadcn@latest add sidebar breadcrumb collapsible tooltip skeleton sheet
       ```
       The sidebar component also pulls in its peer dependencies. If any of these already exist (tabs, separator), shadcn will skip them.

    3. Create `src/lib/wiki/queries.ts` with these functions:

       a. `getCategoryTreeWithArticles()`: Fetches all categories + articles in two parallel queries, builds a hierarchical tree (CategoryWithArticles[]). Categories have { id, name, slug, icon, sortOrder, parentCategoryId, articles[], children[] }. Articles have { id, title, slug, sortOrder }. Uses the pattern from research: flat fetch, Map-based tree building, parent-child assembly.

       b. `getArticleBySlug(slug: string)`: Fetches a single article by slug with its category (joined). Returns { article, category } or null. Selects: id, title, slug, contentMarkdown, technicalViewMarkdown, categoryId, hasHumanEdits, needsReview, lastAiGeneratedAt, lastHumanEditedAt, lastHumanEditorId, updatedAt, createdAt. Also fetches category name and slug.

       c. `getCategoryChain(categoryId: string)`: Walks up the parent chain to build breadcrumb segments. Returns BreadcrumbSegment[] where each segment has { label: string, href: string }. The href for categories is just "#" (categories don't have their own page -- navigation is via sidebar). This is a recursive query: load category, if parentCategoryId exists, load parent, prepend to array.

       d. `searchArticles(query: string, limit?: number)`: Full-text search using websearch_to_tsquery against the existing search_vector GIN index. Returns { id, title, slug, categoryId, categoryName, categorySlug, updatedAt, rank, headline }. Uses ts_rank for ordering and ts_headline with 'StartSel=<mark>, StopSel=</mark>' for snippet highlighting. Joins categories for category name. Default limit 20.

       e. `getRecentArticles(limit?: number)`: Simple query ordering by updatedAt DESC, limit default 10. Returns { id, title, slug, categoryName, categorySlug, updatedAt, changeSource (from latest version) }.

       All functions use `getDb()` from `@/lib/db` and import tables from `@/lib/db/schema`.

    4. Add Tailwind Typography plugin to globals.css: Add `@import "@tailwindcss/typography";` after the existing imports (Tailwind v4 uses CSS imports for plugins). If the import causes build errors, try `@plugin "@tailwindcss/typography"` syntax instead (Tailwind v4 CSS-first config).

    5. Add Shiki dual theme CSS to globals.css (append after existing content):
       ```css
       /* Shiki dual theme support */
       .shiki,
       .shiki span {
         color: var(--shiki-light) !important;
         background-color: var(--shiki-light-bg) !important;
       }
       .dark .shiki,
       .dark .shiki span {
         color: var(--shiki-dark) !important;
         background-color: var(--shiki-dark-bg) !important;
       }
       /* Code block styling */
       article pre {
         @apply overflow-x-auto rounded-lg border border-border p-4 text-sm;
       }
       article pre code {
         @apply bg-transparent;
       }
       article :not(pre) > code {
         @apply rounded bg-muted px-1.5 py-0.5 text-sm;
       }
       ```
  </action>
  <verify>
    - `npm ls react-markdown shiki @shikijs/rehype use-debounce remark-gfm` shows all installed
    - `ls src/components/ui/sidebar.tsx src/components/ui/breadcrumb.tsx src/components/ui/collapsible.tsx` confirms shadcn components exist
    - `ls src/lib/wiki/queries.ts` confirms queries file exists
    - `npx tsc --noEmit` passes (or at least queries.ts has no type errors)
  </verify>
  <done>
    All npm dependencies installed, shadcn sidebar/breadcrumb/collapsible/tooltip/skeleton/sheet components added, wiki/queries.ts has 5 exported query functions (getCategoryTreeWithArticles, getArticleBySlug, getCategoryChain, searchArticles, getRecentArticles), globals.css has typography plugin import and shiki theme CSS.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build sidebar, category tree, breadcrumb, and rework wiki layout</name>
  <files>
    src/components/wiki/category-tree.tsx
    src/components/wiki/app-sidebar.tsx
    src/components/wiki/article-breadcrumb.tsx
    src/app/(wiki)/layout.tsx
    src/app/(wiki)/page.tsx
  </files>
  <action>
    1. Create `src/components/wiki/category-tree.tsx`:
       - Client component ("use client") -- needed for Collapsible interactive state.
       - `CategoryTree` component: receives `categories: CategoryWithArticles[]` prop, renders a `SidebarMenu` with one `CategoryNode` per root category.
       - `CategoryNode` component: renders a `Collapsible` (defaultOpen) wrapping a `SidebarMenuItem`. The `CollapsibleTrigger` shows folder icon (FolderOpen from lucide-react) + category name + chevron that rotates 90deg when open (use `group-data-[state=open]/collapsible:rotate-90` class). The `CollapsibleContent` contains a `SidebarMenuSub` with:
         - Each article as a `SidebarMenuSubItem` > `SidebarMenuSubButton asChild` > `Link href={/wiki/${article.slug}}` with FileText icon + title.
         - Each child category recursively rendered as another `CategoryNode`.
       - Import Link from next/link for article navigation.
       - Use `usePathname()` from next/navigation to highlight the active article (compare pathname to `/wiki/${article.slug}`, set `isActive` prop on SidebarMenuSubButton).
       - Export the `CategoryWithArticles` type from this file (or define it in queries.ts and re-export).

    2. Create `src/components/wiki/app-sidebar.tsx`:
       - Client component ("use client") -- because CategoryTree is client and sidebar needs interactive state.
       - Receives `categories: CategoryWithArticles[]` and `user: { name, email, image, avatarUrl, role }` props.
       - Structure:
         - `Sidebar` (from shadcn) with `collapsible="icon"` variant.
         - `SidebarHeader`: UltraWiki logo text + link to "/" (home).
         - `SidebarContent` with `SidebarGroup` > `SidebarGroupLabel("Navigation")` > `CategoryTree categories={categories}`.
         - `SidebarFooter`: `UserMenu user={user}` -- reuse existing UserMenu component. Wrap in a div so it fits sidebar width.
       - The sidebar automatically becomes a Sheet on mobile (shadcn sidebar handles this via `SIDEBAR_WIDTH_MOBILE` and `isMobile` hook).

    3. Create `src/components/wiki/article-breadcrumb.tsx`:
       - Server component (no "use client").
       - `ArticleBreadcrumb` component: receives `segments: { label: string, href: string }[]` and `currentTitle: string`.
       - Renders shadcn `Breadcrumb` > `BreadcrumbList` with:
         - Home link (always first): `BreadcrumbItem` > `BreadcrumbLink asChild` > `Link href="/"` with text "Home".
         - Each segment: `BreadcrumbSeparator` + `BreadcrumbItem` > `BreadcrumbLink` with segment.label (href="#" for categories since they don't have pages).
         - Current page: `BreadcrumbSeparator` + `BreadcrumbItem` > `BreadcrumbPage` with currentTitle.

    4. Rework `src/app/(wiki)/layout.tsx`:
       - Remove the existing nav + main structure entirely.
       - Keep the auth check and user query at the top (same pattern).
       - Add: `const categoryTree = await getCategoryTreeWithArticles();` (from `@/lib/wiki/queries`).
       - Return:
         ```
         <SidebarProvider>
           <AppSidebar categories={categoryTree} user={user} />
           <SidebarInset>
             <header className="flex h-14 items-center gap-2 border-b px-4">
               <SidebarTrigger />
               {/* Breadcrumb is rendered per-page, not in layout */}
             </header>
             <main className="flex-1 p-6">{children}</main>
           </SidebarInset>
         </SidebarProvider>
         ```
       - Import SidebarProvider, SidebarInset, SidebarTrigger from "@/components/ui/sidebar".
       - Import AppSidebar from "@/components/wiki/app-sidebar".
       - Import getCategoryTreeWithArticles from "@/lib/wiki/queries".

    5. Update `src/app/(wiki)/page.tsx`:
       - This is a temporary update. Replace the placeholder text to say "Welcome to UltraWiki" and show a simple message. Remove the redundant auth/user query (layout already handles auth). Keep it simple -- the real home dashboard is Plan 03.
       - Just render a heading and brief message. The session is already checked by the layout.
  </action>
  <verify>
    - `npx tsc --noEmit` passes without errors
    - `npm run build` completes successfully (or at least `npm run dev` starts without crash)
    - Visit http://localhost:3000 -- should see sidebar with UltraWiki logo, category tree (may be empty if no articles exist yet), user menu in footer, and a hamburger/trigger button
    - On mobile viewport (< 768px), sidebar should be hidden and openable via trigger button as a sheet overlay
  </verify>
  <done>
    Wiki layout fully reworked with SidebarProvider. Collapsible sidebar shows category tree with expandable categories and clickable article links. Breadcrumb component ready for use on article pages. Layout is responsive -- sidebar collapses on desktop trigger and becomes sheet on mobile. UserMenu moved to sidebar footer.
  </done>
</task>

</tasks>

<verification>
- `npm run build` passes
- Sidebar renders with category tree (empty state if no articles yet)
- SidebarTrigger toggles sidebar collapse
- Mobile viewport shows sidebar as sheet overlay
- All query functions in queries.ts compile without errors
- Breadcrumb component accepts segments and renders correctly
</verification>

<success_criteria>
1. Wiki layout uses SidebarProvider with collapsible sidebar (VIEW-01, VIEW-10)
2. Category tree shows hierarchical categories with articles as leaf nodes
3. Breadcrumb component ready for article pages (VIEW-02)
4. Data access layer (queries.ts) provides all query functions for Plans 02 and 03
5. Shiki dual-theme CSS and typography plugin configured for Markdown rendering
6. All shadcn components installed (sidebar, breadcrumb, collapsible, tooltip, skeleton, sheet)
</success_criteria>

<output>
After completion, create `.planning/phases/04-wiki-viewer/04-01-SUMMARY.md`
</output>
