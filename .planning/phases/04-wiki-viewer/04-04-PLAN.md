---
phase: 04-wiki-viewer
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(wiki)/wiki/category/[categorySlug]/page.tsx
  - src/lib/wiki/queries.ts
  - src/components/wiki/article-breadcrumb.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Each breadcrumb category segment links to /wiki/category/{slug} and navigates to a real page"
    - "Category page displays the category name and lists its articles and subcategories"
  artifacts:
    - path: "src/app/(wiki)/wiki/category/[categorySlug]/page.tsx"
      provides: "Category listing page"
      contains: "getCategoryBySlug"
    - path: "src/lib/wiki/queries.ts"
      provides: "getCategoryBySlug query function"
      exports: ["getCategoryBySlug"]
    - path: "src/components/wiki/article-breadcrumb.tsx"
      provides: "Breadcrumb with real category links"
  key_links:
    - from: "src/components/wiki/article-breadcrumb.tsx"
      to: "/wiki/category/[slug]"
      via: "Next.js Link with segment.href"
      pattern: "Link href=.*segment\\.href"
    - from: "src/app/(wiki)/wiki/category/[categorySlug]/page.tsx"
      to: "src/lib/wiki/queries.ts"
      via: "getCategoryBySlug import"
      pattern: "getCategoryBySlug"
    - from: "src/lib/wiki/queries.ts"
      to: "categories table"
      via: "drizzle query by slug"
      pattern: "eq\\(categories\\.slug"
---

<objective>
Fix dead breadcrumb links by creating a category listing page and updating getCategoryChain() to link to real URLs.

Purpose: UAT Test 2 failed -- category breadcrumb segments use href="#" because no category page exists. Users cannot navigate to a category to see its articles.
Output: Working /wiki/category/[categorySlug] page, updated breadcrumb links, getCategoryBySlug query.
</objective>

<execution_context>
@/Users/michael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/wiki/queries.ts
@src/components/wiki/article-breadcrumb.tsx
@src/app/(wiki)/wiki/[articleSlug]/page.tsx
@src/app/(wiki)/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getCategoryBySlug query and update getCategoryChain hrefs</name>
  <files>src/lib/wiki/queries.ts</files>
  <action>
Add a new exported async function `getCategoryBySlug(slug: string)` that queries the categories table by slug and returns the category with its direct child categories and articles. Specifically:

1. Query `categories` table where `eq(categories.slug, slug)` to get the category row (id, name, slug, icon, parentCategoryId). Return null if not found.

2. Query `articles` table where `eq(articles.categoryId, category.id)` ordered by sortOrder then title. Return array of {id, title, slug}.

3. Query `categories` table where `eq(categories.parentCategoryId, category.id)` ordered by sortOrder then name. Return array of {id, name, slug, icon}.

4. Return object: `{ category, articles, subcategories }`.

Then update `getCategoryChain()` on line 203: change `href: "#"` to `href: `/wiki/category/${cat.slug}``. This is a one-line change.
  </action>
  <verify>Run `npx tsc --noEmit` to confirm no type errors. Grep queries.ts for `href: "#"` -- should return zero matches. Grep for `getCategoryBySlug` -- should find the new function.</verify>
  <done>getCategoryBySlug function exported from queries.ts. getCategoryChain returns segments with `/wiki/category/{slug}` hrefs instead of "#".</done>
</task>

<task type="auto">
  <name>Task 2: Create category listing page and update breadcrumb to use Next.js Link</name>
  <files>src/app/(wiki)/wiki/category/[categorySlug]/page.tsx, src/components/wiki/article-breadcrumb.tsx</files>
  <action>
**Category page** at `src/app/(wiki)/wiki/category/[categorySlug]/page.tsx`:

Create a server component page that:
1. Extracts `categorySlug` from `params` (Next.js 15 pattern: `params: Promise<{ categorySlug: string }>`, await it).
2. Calls `getCategoryBySlug(categorySlug)` from `@/lib/wiki/queries`.
3. If null, call `notFound()` from `next/navigation`.
4. If the category has a `parentCategoryId`, call `getCategoryChain(category.parentCategoryId)` to get ancestor breadcrumbs. Otherwise, empty segments array.
5. Render:
   - `ArticleBreadcrumb` with the ancestor segments and `currentTitle` = category name.
   - `<h1>` with category name.
   - If subcategories exist: a "Subcategories" section with a grid of cards (use shadcn Card component). Each card links to `/wiki/category/{subcategory.slug}` and shows the subcategory name.
   - If articles exist: an "Articles" section with a list of links. Each links to `/wiki/{article.slug}` and shows the article title.
   - If neither: a message "This category is empty."

Use Tailwind classes consistent with the article page styling (text-3xl font-bold for h1, gap-8, etc.). Import Link from next/link for all navigation links. Import Card, CardHeader, CardTitle from `@/components/ui/card`.

**Breadcrumb update** in `src/components/wiki/article-breadcrumb.tsx`:

Update the category segment rendering to use Next.js `Link` component for proper client-side navigation (matching the Home breadcrumb pattern that already uses `asChild` + `<Link>`):

Change the segment map from:
```tsx
<BreadcrumbLink href={segment.href}>
```
to:
```tsx
<BreadcrumbLink asChild>
  <Link href={segment.href}>{segment.label}</Link>
</BreadcrumbLink>
```

Import `Link` from `next/link` (it may already be imported for the Home link).
  </action>
  <verify>Run `npm run build` to confirm the category page route compiles and the breadcrumb renders without errors. Check that `/wiki/category/[categorySlug]` appears in the build output routes.</verify>
  <done>Category page renders at /wiki/category/{slug} showing subcategories and articles. Breadcrumb segments are proper Next.js Links navigating to category pages.</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with no errors
2. Grep `src/lib/wiki/queries.ts` for `href: "#"` returns zero matches
3. Grep `src/lib/wiki/queries.ts` for `getCategoryBySlug` returns the new function
4. Grep `src/app/(wiki)/wiki/category` confirms the route file exists
5. Breadcrumb segments use `<Link>` with real `/wiki/category/` URLs
</verification>

<success_criteria>
- Category breadcrumb segments navigate to /wiki/category/{slug} (not "#")
- Category page displays category name, subcategories as cards, articles as links
- Breadcrumb uses Next.js Link for client-side navigation
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/04-wiki-viewer/04-04-SUMMARY.md`
</output>
