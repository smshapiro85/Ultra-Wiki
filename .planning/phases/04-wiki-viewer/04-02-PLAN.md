---
phase: 04-wiki-viewer
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/app/(wiki)/wiki/[articleSlug]/page.tsx
  - src/components/wiki/article-content.tsx
  - src/components/wiki/table-of-contents.tsx
  - src/components/wiki/article-tabs.tsx
  - src/components/wiki/article-metadata.tsx
  - src/components/wiki/regenerate-button.tsx
  - src/lib/wiki/actions.ts
autonomous: true

must_haves:
  truths:
    - "User can navigate to /wiki/[articleSlug] and see the article content rendered as formatted Markdown with syntax-highlighted code blocks"
    - "An auto-generated table of contents appears alongside the article, built from heading elements"
    - "Article page has four tabs: Article (active), Technical View (rendered), Comments (disabled placeholder), History (disabled placeholder)"
    - "A metadata sidebar shows last updated date, last editor name, AI/human badge, and category name"
    - "Admin users see a Regenerate Article button that re-fetches source files and re-runs AI generation"
    - "Regenerate respects merge strategy: direct overwrite for AI-only articles, three-way merge for human-edited articles"
    - "Breadcrumb on article page shows Home > Category > Article Title"
  artifacts:
    - path: "src/app/(wiki)/wiki/[articleSlug]/page.tsx"
      provides: "Article page route with data fetching and component assembly"
      contains: "getArticleBySlug"
    - path: "src/components/wiki/article-content.tsx"
      provides: "Server-side Markdown rendering with shiki syntax highlighting"
      contains: "MarkdownAsync"
    - path: "src/components/wiki/table-of-contents.tsx"
      provides: "Sticky TOC generated from article headings"
      contains: "extractToc"
    - path: "src/components/wiki/article-tabs.tsx"
      provides: "Tab system for Article, Technical View, Comments, History"
      contains: "TabsList"
    - path: "src/components/wiki/article-metadata.tsx"
      provides: "Metadata panel with dates, editor, badges"
      contains: "hasHumanEdits"
    - path: "src/components/wiki/regenerate-button.tsx"
      provides: "Admin-only regenerate action trigger"
      contains: "regenerateArticle"
    - path: "src/lib/wiki/actions.ts"
      provides: "Server action for article regeneration"
      exports: ["regenerateArticle"]
  key_links:
    - from: "src/app/(wiki)/wiki/[articleSlug]/page.tsx"
      to: "src/lib/wiki/queries.ts"
      via: "getArticleBySlug + getCategoryChain calls"
      pattern: "getArticleBySlug"
    - from: "src/components/wiki/article-content.tsx"
      to: "@shikijs/rehype"
      via: "rehypePlugins in MarkdownAsync"
      pattern: "rehypeShiki"
    - from: "src/lib/wiki/actions.ts"
      to: "src/lib/ai/pipeline.ts"
      via: "Dynamic import of pipeline functions for regeneration"
      pattern: "import.*pipeline"
    - from: "src/components/wiki/regenerate-button.tsx"
      to: "src/lib/wiki/actions.ts"
      via: "Server action call on button click"
      pattern: "regenerateArticle"
---

<objective>
Build the article view page with Markdown rendering, syntax highlighting, table of contents, tab system, metadata sidebar, and admin regenerate action.

Purpose: This is the core reading experience -- users spend most time here. The Markdown renderer with shiki highlighting, TOC, and metadata give articles a polished, navigable presentation. The regenerate button lets admins keep articles fresh.
Output: Fully functional /wiki/[articleSlug] page with all VIEW-03, VIEW-04, VIEW-05, VIEW-08 requirements and the admin regenerate action.
</objective>

<execution_context>
@/Users/michael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-wiki-viewer/04-RESEARCH.md
@.planning/phases/04-wiki-viewer/04-01-SUMMARY.md
@src/lib/db/schema.ts
@src/lib/ai/pipeline.ts
@src/lib/ai/analyze.ts
@src/lib/ai/generate.ts
@src/lib/merge/three-way.ts
@src/lib/merge/conflict.ts
@src/lib/content/version.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Article content renderer, TOC, tabs, and metadata components</name>
  <files>
    src/components/wiki/article-content.tsx
    src/components/wiki/table-of-contents.tsx
    src/components/wiki/article-tabs.tsx
    src/components/wiki/article-metadata.tsx
  </files>
  <action>
    1. Create `src/components/wiki/article-content.tsx`:
       - This is an async server component (NO "use client").
       - Import `MarkdownAsync` from "react-markdown" (react-markdown v10 default export supports async).
         IMPORTANT: react-markdown v10 may export the async component differently. Check: `import Markdown from "react-markdown"` -- in v10 the default export already supports async rehype plugins when used in RSC. If MarkdownAsync is a named export, use that. If not, the default `Markdown` component in RSC context handles async plugins.
       - Import `remarkGfm` from "remark-gfm".
       - Import `rehypeShiki` from "@shikijs/rehype".
       - `ArticleContent` component: receives `{ markdown: string }` prop.
       - Renders:
         ```tsx
         <article className="prose prose-zinc dark:prose-invert max-w-none">
           <Markdown
             remarkPlugins={[remarkGfm]}
             rehypePlugins={[
               [rehypeShiki, {
                 themes: { light: "github-light", dark: "github-dark" },
                 defaultColor: false,
               }],
             ]}
           >
             {markdown}
           </Markdown>
         </article>
         ```
       - The `defaultColor: false` tells shiki to use CSS variables approach (matches our globals.css dual theme CSS).
       - If the `prose` classes don't produce styled output (missing @tailwindcss/typography), fall back to manual typography classes.

    2. Create `src/components/wiki/table-of-contents.tsx`:
       - Server component (no "use client").
       - Export `extractToc(markdown: string): TocEntry[]` function:
         - Uses regex `/^(#{1,6})\s+(.+)$/gm` to find headings.
         - Returns array of `{ id: string, text: string, level: number }`.
         - `id` = text.toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/^-+|-+$/g, "").
       - `TableOfContents` component: receives `{ entries: TocEntry[] }` prop.
       - Renders a sticky aside (use `className="sticky top-20"`) with heading "On this page", then a list of links:
         - Each entry: `<a href={#${entry.id}} className="...">{entry.text}</a>`.
         - Indent based on level: `pl-${(entry.level - 1) * 3}` or similar Tailwind spacing.
         - Style: text-sm text-muted-foreground, hover:text-foreground.
       - Note: For the heading IDs to match, the Markdown renderer needs to generate matching IDs on headings. Add a custom component override in article-content.tsx that generates IDs on h1-h6 elements using the same slugification logic as extractToc. Use react-markdown's `components` prop:
         ```tsx
         components={{
           h1: ({children, ...props}) => <h1 id={slugify(String(children))} {...props}>{children}</h1>,
           h2: ({children, ...props}) => <h2 id={slugify(String(children))} {...props}>{children}</h2>,
           // ... h3-h6
         }}
         ```
         Export the `slugify` function from table-of-contents.tsx for reuse in article-content.tsx.

    3. Create `src/components/wiki/article-tabs.tsx`:
       - Server component (no "use client" needed -- shadcn Tabs is a client component but wrapping in server is fine since we pass ReactNode children).
       - Actually, Tabs requires client interactivity. Make this "use client".
       - Receives `{ articleContent: React.ReactNode, technicalView: React.ReactNode }` props.
       - Renders shadcn `Tabs` with `defaultValue="article"`:
         - TabsTrigger "Article" with FileText icon.
         - TabsTrigger "Technical View" with Code icon (enabled, renders technicalView prop content or "No technical view available" if null).
         - TabsTrigger "Comments" with MessageSquare icon -- disabled, shows "Comments will be available in Phase 6."
         - TabsTrigger "History" with History icon -- disabled, shows "Version history will be available in Phase 5."
       - Icons from lucide-react.

    4. Create `src/components/wiki/article-metadata.tsx`:
       - Server component.
       - Receives props: `{ updatedAt: Date, lastAiGeneratedAt: Date | null, lastHumanEditedAt: Date | null, lastEditorName: string | null, hasHumanEdits: boolean, needsReview: boolean, categoryName: string, categorySlug: string }`.
       - Renders a Card or a simple bordered div with:
         - Category: Badge with category name.
         - Last updated: formatted date (use `updatedAt.toLocaleDateString()`).
         - Source badge: if hasHumanEdits, show Badge "Human edited" with User icon (lucide). If not, show Badge "AI generated" with Bot icon.
         - Last editor: if lastEditorName, show "Edited by {name}".
         - If needsReview: show an amber Alert or Banner "This article has unresolved AI merge conflicts. An admin should review."
         - Use icons: Clock, User, Bot, AlertTriangle from lucide-react.
       - Admin regenerate button is NOT in this component -- it's a separate component placed by the page.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - All 4 component files exist and export their main components
    - article-content.tsx imports react-markdown and @shikijs/rehype
    - table-of-contents.tsx exports extractToc function and TableOfContents component
  </verify>
  <done>
    ArticleContent renders Markdown with shiki syntax highlighting (dual theme, server-side). TableOfContents extracts headings and renders sticky sidebar with anchor links. ArticleTabs provides four-tab system with Article and Technical View active, Comments and History disabled. ArticleMetadata shows dates, editor, AI/human badge, and review warning.
  </done>
</task>

<task type="auto">
  <name>Task 2: Article page route, regenerate action, and regenerate button</name>
  <files>
    src/app/(wiki)/wiki/[articleSlug]/page.tsx
    src/lib/wiki/actions.ts
    src/components/wiki/regenerate-button.tsx
  </files>
  <action>
    1. Create `src/lib/wiki/actions.ts`:
       - "use server" directive at top.
       - `regenerateArticle(articleId: string)` server action:
         a. Auth check: `const session = await auth(); if (session?.user?.role !== "admin") throw new Error("Unauthorized");`
         b. Load article from DB: `SELECT id, slug, title, contentMarkdown, hasHumanEdits, categoryId FROM articles WHERE id = articleId`.
         c. Load linked files: `SELECT githubFileId, githubFiles.filePath FROM article_file_links JOIN github_files ON ... WHERE articleId = articleId`.
         d. Fetch file contents from GitHub: `const { fetchFileContents } = await import("@/lib/ai/analyze");` (dynamic import to avoid BlockNote transitive dependency). Call `fetchFileContents(filePaths)`.
         e. Get article style prompt: `await getSetting(SETTING_KEYS.article_style_prompt)`.
         f. Generate new content: `const { generateArticle } = await import("@/lib/ai/generate");` Call `generateArticle({ slug, title, related_files: filePaths, content_markdown: "", technical_view_markdown: "", change_summary: "Regenerated by admin", related_db_tables: [], category_suggestion: "" }, stylePrompt)`.
         g. If `!article.hasHumanEdits`: Direct overwrite -- update article with new contentMarkdown, contentJson=null, technicalViewMarkdown, lastAiGeneratedAt=now, updatedAt=now. Create version with changeSource "ai_updated".
         h. If `article.hasHumanEdits`: Run merge strategy:
            - `const { getLastAIVersion } = await import("@/lib/content/version");`
            - `const { mergeArticleContent } = await import("@/lib/merge/three-way");`
            - `const { resolveConflict } = await import("@/lib/merge/conflict");`
            - Get base from last AI version, run 3-way merge, resolve conflicts.
            - Update article with resolved content.
         i. `revalidatePath("/wiki/[articleSlug]", "page");` to refresh the page.
         j. Return `{ success: true }` or `{ success: false, error: string }`.
       - CRITICAL: Use dynamic imports for all AI/merge modules to avoid @blocknote/server-util createContext crash.

    2. Create `src/components/wiki/regenerate-button.tsx`:
       - "use client" component.
       - Receives `{ articleId: string }` prop.
       - Renders a Button (variant="outline", size="sm") with RefreshCw icon and text "Regenerate".
       - On click: calls `regenerateArticle(articleId)` server action.
       - Uses `useTransition` for loading state -- while pending, show spinner (RefreshCw with animate-spin) and disable button.
       - On success: show sonner toast "Article regenerated successfully".
       - On error: show sonner toast with error message.
       - Import toast from sonner, regenerateArticle from "@/lib/wiki/actions".

    3. Create `src/app/(wiki)/wiki/[articleSlug]/page.tsx`:
       - Async server component.
       - Params: `{ params: Promise<{ articleSlug: string }> }` (Next.js 15+ async params).
       - Fetch article: `const result = await getArticleBySlug(articleSlug);` If null, call `notFound()`.
       - Fetch category chain for breadcrumb: `const segments = article.categoryId ? await getCategoryChain(article.categoryId) : [];`
       - Fetch last editor name if lastHumanEditorId exists: query users table for name.
       - Extract TOC: `const tocEntries = extractToc(article.contentMarkdown);`
       - Get session for admin check: `const session = await auth();`
       - Render layout:
         ```
         <div>
           {/* Breadcrumb in a bar at top */}
           <ArticleBreadcrumb segments={segments} currentTitle={article.title} />

           <div className="mt-4 flex gap-8">
             {/* Main content area */}
             <div className="min-w-0 flex-1">
               <h1 className="text-3xl font-bold mb-4">{article.title}</h1>

               {/* Review banner if needsReview */}
               {article.needsReview && (
                 <div className="mb-4 rounded-lg border border-amber-200 bg-amber-50 p-4 text-amber-800 dark:border-amber-800 dark:bg-amber-950 dark:text-amber-200">
                   This article has unresolved merge conflicts and needs admin review.
                 </div>
               )}

               {/* Admin regenerate button */}
               {session?.user?.role === "admin" && (
                 <div className="mb-4">
                   <RegenerateButton articleId={article.id} />
                 </div>
               )}

               <ArticleTabs
                 articleContent={<ArticleContent markdown={article.contentMarkdown} />}
                 technicalView={
                   article.technicalViewMarkdown
                     ? <ArticleContent markdown={article.technicalViewMarkdown} />
                     : <p className="text-muted-foreground">No technical view available.</p>
                 }
               />
             </div>

             {/* Right sidebar: TOC + Metadata */}
             <aside className="hidden w-64 shrink-0 lg:block">
               {tocEntries.length > 0 && <TableOfContents entries={tocEntries} />}
               <div className="mt-6">
                 <ArticleMetadata
                   updatedAt={article.updatedAt}
                   lastAiGeneratedAt={article.lastAiGeneratedAt}
                   lastHumanEditedAt={article.lastHumanEditedAt}
                   lastEditorName={editorName}
                   hasHumanEdits={article.hasHumanEdits}
                   needsReview={article.needsReview}
                   categoryName={category?.name ?? "Uncategorized"}
                   categorySlug={category?.slug ?? ""}
                 />
               </div>
             </aside>
           </div>
         </div>
         ```
       - Import all components from their respective files.
       - Import notFound from "next/navigation".
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` passes
    - If articles exist in DB: visiting /wiki/[slug] shows rendered Markdown with syntax-highlighted code, TOC on right sidebar, tabs (Article active, Technical View clickable, Comments/History disabled), metadata panel, and Regenerate button for admins
    - If no articles: /wiki/nonexistent returns 404 page
  </verify>
  <done>
    Article page at /wiki/[articleSlug] renders Markdown content with shiki syntax highlighting, auto-generated table of contents from headings, four-tab system (Article, Technical View active; Comments, History disabled), metadata sidebar with dates/editor/badges, review banner for merge conflicts, and admin-only Regenerate Article button that re-fetches source files and re-runs AI pipeline with merge strategy awareness.
  </done>
</task>

</tasks>

<verification>
- `npm run build` passes
- Article pages render Markdown with syntax-highlighted code blocks (shiki dual themes)
- TOC generated from headings with working anchor links
- Tab switching between Article and Technical View works
- Metadata sidebar shows correct badges and dates
- Admin sees Regenerate button; non-admin does not
- Regenerate action completes and updates article content
- Breadcrumb shows Home > Category > Article on article pages
</verification>

<success_criteria>
1. Article Markdown renders with shiki syntax highlighting, light and dark themes (VIEW-03)
2. Tab system shows Article (default), Technical View, Comments (disabled), History (disabled) (VIEW-04)
3. Metadata sidebar shows updated date, editor, AI/human badge, category (VIEW-05)
4. Auto-generated TOC from headings with anchor links (VIEW-08)
5. Admin can regenerate article with merge strategy awareness (Success Criteria 4)
6. Breadcrumb shows navigation path on article pages (VIEW-02)
</success_criteria>

<output>
After completion, create `.planning/phases/04-wiki-viewer/04-02-SUMMARY.md`
</output>
