---
phase: 04-wiki-viewer
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/lib/db/schema.ts
  - src/app/(wiki)/page.tsx
  - src/app/(wiki)/search/page.tsx
  - src/components/wiki/search-input.tsx
  - src/components/wiki/search-results.tsx
  - src/components/wiki/home-dashboard.tsx
  - src/lib/wiki/queries.ts
  - src/lib/wiki/actions.ts
  - src/app/(wiki)/layout.tsx
autonomous: true

must_haves:
  truths:
    - "User can type in search bar and results appear as they type (debounced at 300ms)"
    - "Search results show article title, category, highlighted snippet with <mark> tags, and relevance ranking"
    - "Search uses full-text search (tsvector) -- not ILIKE pattern matching"
    - "Home page shows recent article updates with title, category, date, and change source badge"
    - "Home page shows bookmarked articles for the logged-in user"
    - "User can bookmark and unbookmark articles"
    - "Layout is responsive -- sidebar collapses on mobile, content fills available width"
  artifacts:
    - path: "src/app/(wiki)/search/page.tsx"
      provides: "Search results page reading query from URL params"
      contains: "searchParams"
    - path: "src/components/wiki/search-input.tsx"
      provides: "Debounced search input updating URL params"
      contains: "useDebouncedCallback"
    - path: "src/components/wiki/search-results.tsx"
      provides: "Search result list with highlighted snippets"
      contains: "headline"
    - path: "src/app/(wiki)/page.tsx"
      provides: "Home dashboard with recent updates, search, bookmarks"
      contains: "getRecentArticles"
    - path: "src/lib/db/schema.ts"
      provides: "user_bookmarks junction table"
      contains: "userBookmarks"
  key_links:
    - from: "src/components/wiki/search-input.tsx"
      to: "/search?q="
      via: "router.push with URL search params on debounced input"
      pattern: "router.push.*search"
    - from: "src/app/(wiki)/search/page.tsx"
      to: "src/lib/wiki/queries.ts"
      via: "searchArticles(query) call with URL param"
      pattern: "searchArticles"
    - from: "src/app/(wiki)/page.tsx"
      to: "src/lib/wiki/queries.ts"
      via: "getRecentArticles + getUserBookmarks calls"
      pattern: "getRecentArticles"
    - from: "src/lib/db/schema.ts"
      to: "src/lib/wiki/queries.ts"
      via: "userBookmarks table used in bookmark queries"
      pattern: "userBookmarks"
---

<objective>
Build full-text search with debounced as-you-type results, the home dashboard with recent updates and bookmarked articles, and the user_bookmarks schema addition.

Purpose: Search is the primary discovery mechanism for a wiki with many articles. The home dashboard provides a landing experience showing recent activity and personal bookmarks. Together they complete the user-facing browse and find workflow.
Output: Working search page at /search with debounced input, home dashboard with recent updates and bookmarks, bookmark toggle functionality.
</objective>

<execution_context>
@/Users/michael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-wiki-viewer/04-RESEARCH.md
@.planning/phases/04-wiki-viewer/04-01-SUMMARY.md
@src/lib/db/schema.ts
@src/lib/wiki/queries.ts
@src/app/(wiki)/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add user_bookmarks table, migration, and bookmark queries/actions</name>
  <files>
    src/lib/db/schema.ts
    src/lib/wiki/queries.ts
    src/lib/wiki/actions.ts
  </files>
  <action>
    1. Add `userBookmarks` table to `src/lib/db/schema.ts`:
       - Place it after the `articles` table definition (alongside other user-facing tables).
       - Schema:
         ```ts
         export const userBookmarks = pgTable(
           "user_bookmarks",
           {
             userId: uuid("user_id")
               .notNull()
               .references(() => users.id, { onDelete: "cascade" }),
             articleId: uuid("article_id")
               .notNull()
               .references(() => articles.id, { onDelete: "cascade" }),
             createdAt: timestamp("created_at", { withTimezone: true })
               .defaultNow()
               .notNull(),
           },
           (t) => [primaryKey({ columns: [t.userId, t.articleId] })]
         );
         ```
       - This is a simple junction table with composite PK (userId + articleId), no separate id column needed.

    2. Run migration:
       ```
       npm run db:generate
       npm run db:migrate
       ```
       This creates the user_bookmarks table in the database.

    3. Add bookmark query functions to `src/lib/wiki/queries.ts`:

       a. `getUserBookmarks(userId: string)`: Fetches all bookmarked articles for a user. Joins user_bookmarks -> articles -> categories. Returns array of { id, title, slug, categoryName, categorySlug, bookmarkedAt }. Order by bookmarkedAt DESC.

       b. `isArticleBookmarked(userId: string, articleId: string)`: Returns boolean. Simple SELECT EXISTS query on user_bookmarks.

    4. Add bookmark server actions to `src/lib/wiki/actions.ts` (this file was created in Plan 02 -- add to it, or create it if Plan 03 executes before 02):

       a. `toggleBookmark(articleId: string)` server action:
          - "use server" (file already has this directive from regenerateArticle).
          - Auth check: get session, require user.id.
          - Check if bookmark exists: SELECT from user_bookmarks WHERE userId AND articleId.
          - If exists: DELETE. Return { bookmarked: false }.
          - If not exists: INSERT. Return { bookmarked: true }.
          - `revalidatePath("/")` to refresh home dashboard bookmarks.

       NOTE: If this plan executes before Plan 02, create `src/lib/wiki/actions.ts` with "use server" directive and the toggleBookmark action. Plan 02 will add regenerateArticle to this same file. Use `import { auth } from "@/lib/auth"` and `import { getDb } from "@/lib/db"`.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Migration applied: user_bookmarks table exists in database
    - `getUserBookmarks`, `isArticleBookmarked` functions exported from queries.ts
    - `toggleBookmark` function exported from actions.ts
  </verify>
  <done>
    user_bookmarks table created with composite PK (userId, articleId), migration applied, query functions for fetching bookmarks and checking bookmark status, server action for toggling bookmarks with revalidation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Search page, search input, and home dashboard</name>
  <files>
    src/components/wiki/search-input.tsx
    src/components/wiki/search-results.tsx
    src/app/(wiki)/search/page.tsx
    src/components/wiki/home-dashboard.tsx
    src/app/(wiki)/page.tsx
    src/app/(wiki)/layout.tsx
  </files>
  <action>
    1. Create `src/components/wiki/search-input.tsx`:
       - "use client" component.
       - Uses `useDebouncedCallback` from "use-debounce" with 300ms delay.
       - Uses `useRouter` and `useSearchParams` from "next/navigation".
       - Renders an Input (shadcn) with Search icon (lucide-react) prefix.
       - On input change: debounced callback updates URL params -- if term is non-empty, `router.push(/search?q=${encodeURIComponent(term)})`. If empty, `router.push("/search")`.
       - defaultValue reads from `searchParams.get("q")`.
       - Wrap in Suspense boundary when used in layout (useSearchParams requires it).
       - Style: relative container with Search icon absolutely positioned left, input with `pl-9` padding.

    2. Create `src/components/wiki/search-results.tsx`:
       - Server component (no "use client").
       - Receives `{ results: SearchResult[] }` where SearchResult = { id, title, slug, categoryName, categorySlug, updatedAt, rank, headline }.
       - For each result, render a Card-like div with:
         - Title as a Link to `/wiki/${result.slug}` (bold, text-lg).
         - Category badge: `Badge variant="outline"` with categoryName.
         - Headline: render using `dangerouslySetInnerHTML={{ __html: sanitizedHeadline }}`.
           Sanitize: strip all HTML tags EXCEPT `<mark>` and `</mark>`. Use a simple regex replacement: `headline.replace(/<(?!\/?mark\b)[^>]*>/gi, "")`. This prevents any XSS from article content while preserving the search highlighting.
         - Updated date in muted text.
       - If results is empty: show "No results found" message.

    3. Create `src/app/(wiki)/search/page.tsx`:
       - Async server component.
       - Reads `searchParams` (Next.js 15 async): `const { q } = await searchParams;`
       - If `q` exists and is non-empty: call `searchArticles(q)` from queries.ts.
       - Render:
         - `<SearchInput />` at top (wrapped in Suspense for useSearchParams).
         - If q: `<SearchResults results={results} />` + result count ("Found N articles").
         - If no q: show prompt "Enter a search term to find articles."
       - Page title: "Search" (or "Search Results" if q exists).

    4. Create `src/components/wiki/home-dashboard.tsx`:
       - Server component.
       - Receives `{ recentArticles, bookmarkedArticles, userName }` props.
       - Layout: Two-column grid on desktop (lg:grid-cols-2), single column on mobile.
       - Left column -- "Recent Updates":
         - List of recent articles, each showing:
           - Title as Link to `/wiki/${slug}`.
           - Category name in muted text.
           - Updated date formatted.
           - Change source badge (ai_generated, ai_updated, human_edited, ai_merged) with appropriate colors.
         - If empty: "No articles yet. Run a sync to generate content."
       - Right column -- "Your Bookmarks":
         - List of bookmarked articles, each showing:
           - Title as Link to `/wiki/${slug}`.
           - Category name.
           - Bookmarked date.
         - If empty: "No bookmarks yet. Star articles to save them here."
       - Use Card components for the two sections.

    5. Update `src/app/(wiki)/page.tsx` (home page):
       - Async server component.
       - Get session: `const session = await auth();` (already redirects if not logged in via layout).
       - Fetch data in parallel:
         ```ts
         const [recentArticles, bookmarks] = await Promise.all([
           getRecentArticles(10),
           getUserBookmarks(session.user.id),
         ]);
         ```
       - Get user name from session.
       - Render: `<HomeDashboard recentArticles={recentArticles} bookmarkedArticles={bookmarks} userName={session.user.name} />`
       - Add a search bar at the top: `<SearchInput />` wrapped in Suspense with Skeleton fallback.
       - Heading: "Welcome to UltraWiki" or "Dashboard".

    6. Update `src/app/(wiki)/layout.tsx`:
       - Add the SearchInput to the header bar (next to SidebarTrigger).
       - Inside the `<header>` element in SidebarInset, after `<SidebarTrigger />`, add:
         ```tsx
         <div className="flex flex-1 items-center gap-2">
           <Separator orientation="vertical" className="h-4" />
           {/* Breadcrumb will be rendered per-page */}
           <div className="ml-auto w-64">
             <Suspense fallback={<Skeleton className="h-9 w-full" />}>
               <SearchInput />
             </Suspense>
           </div>
         </div>
         ```
       - Import SearchInput, Suspense, Skeleton, Separator.
       - The search input in the header navigates to /search?q=... on input. This provides global search access from any page.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` passes
    - Visit /search -- search input appears, typing triggers navigation to /search?q=term
    - Search results show highlighted snippets with <mark> tags
    - Home page (/) shows recent updates and bookmarks sections
    - Search input appears in header bar on all wiki pages
    - Layout is responsive -- content fills width, sidebar collapses on mobile
  </verify>
  <done>
    Search page at /search with debounced input (300ms) updates URL params and shows full-text search results with highlighted snippets, relevance ranking, category badges, and dates. Home dashboard shows recent article updates (title, category, date, change source) and user's bookmarked articles. Search input in global header provides search access from any wiki page. Layout is fully responsive.
  </done>
</task>

</tasks>

<verification>
- `npm run build` passes
- Search produces ranked results with highlighted snippets from tsvector
- Typing in search input debounces at 300ms and updates URL
- Home page shows recent updates and bookmarks
- Bookmark toggle works (add/remove)
- Search input accessible from header on all wiki pages
- Responsive layout works on mobile viewports
</verification>

<success_criteria>
1. Full-text search uses Postgres tsvector with websearch_to_tsquery, ts_rank, ts_headline (VIEW-06)
2. Search-as-you-type with 300ms debouncing via URL params (VIEW-07)
3. Home page shows recent updates, search bar, bookmarked articles (VIEW-09)
4. Responsive layout with sidebar collapsing on mobile (VIEW-10)
5. user_bookmarks table created and bookmark toggle functional
6. Search results show highlighted snippets, relevance ranking, category context
</success_criteria>

<output>
After completion, create `.planning/phases/04-wiki-viewer/04-03-SUMMARY.md`
</output>
