---
phase: 04-wiki-viewer
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/wiki/bookmark-button.tsx
  - src/app/(wiki)/wiki/[articleSlug]/page.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User sees a bookmark toggle button on every article page"
    - "Clicking the bookmark button toggles bookmark state with visual feedback (filled/unfilled star, toast)"
    - "Bookmarked articles appear in the home dashboard bookmarks section"
  artifacts:
    - path: "src/components/wiki/bookmark-button.tsx"
      provides: "BookmarkButton client component"
      contains: "toggleBookmark"
    - path: "src/app/(wiki)/wiki/[articleSlug]/page.tsx"
      provides: "Article page rendering BookmarkButton"
      contains: "BookmarkButton"
  key_links:
    - from: "src/components/wiki/bookmark-button.tsx"
      to: "src/lib/wiki/actions.ts"
      via: "toggleBookmark server action import"
      pattern: "import.*toggleBookmark.*from.*actions"
    - from: "src/app/(wiki)/wiki/[articleSlug]/page.tsx"
      to: "src/lib/wiki/queries.ts"
      via: "isArticleBookmarked query"
      pattern: "isArticleBookmarked"
    - from: "src/app/(wiki)/wiki/[articleSlug]/page.tsx"
      to: "src/components/wiki/bookmark-button.tsx"
      via: "BookmarkButton render"
      pattern: "<BookmarkButton"
---

<objective>
Add a BookmarkButton client component to article pages so users can toggle bookmarks.

Purpose: UAT Test 10 failed -- toggleBookmark server action and isArticleBookmarked query exist but no UI component renders the bookmark toggle. Users cannot see or interact with the bookmark feature.
Output: BookmarkButton component on every article page, wired to existing backend.
</objective>

<execution_context>
@/Users/michael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/wiki/actions.ts
@src/lib/wiki/queries.ts
@src/components/wiki/regenerate-button.tsx
@src/app/(wiki)/wiki/[articleSlug]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BookmarkButton client component</name>
  <files>src/components/wiki/bookmark-button.tsx</files>
  <action>
Create a "use client" component following the exact RegenerateButton pattern (src/components/wiki/regenerate-button.tsx).

Props: `{ articleId: string; initialBookmarked: boolean }`

Implementation:
1. `const [isBookmarked, setIsBookmarked] = useState(initialBookmarked)` for optimistic UI.
2. `const [isPending, startTransition] = useTransition()` for loading state.
3. `handleToggle` function that:
   - Calls `startTransition(async () => { ... })`
   - Inside: optimistically flip `setIsBookmarked(!isBookmarked)` BEFORE the server call
   - Call `const result = await toggleBookmark(articleId)` from `@/lib/wiki/actions`
   - On success: `setIsBookmarked(result.bookmarked)` (confirm server state), show `toast.success(result.bookmarked ? "Article bookmarked" : "Bookmark removed")`
   - On error (catch block): revert `setIsBookmarked(isBookmarked)`, show `toast.error("Failed to update bookmark")`
4. Render a `<Button>` from `@/components/ui/button`:
   - `variant="outline"`, `size="sm"`
   - `onClick={handleToggle}`, `disabled={isPending}`
   - Icon: `Star` from `lucide-react`. When `isBookmarked` is true, add `fill="currentColor"` and `className="size-4 text-yellow-500"`. When false, just `className="size-4"`.
   - Text: `isBookmarked ? "Bookmarked" : "Bookmark"`

Import: `useState`, `useTransition` from "react"; `Button` from "@/components/ui/button"; `Star` from "lucide-react"; `toast` from "sonner"; `toggleBookmark` from "@/lib/wiki/actions".
  </action>
  <verify>Run `npx tsc --noEmit` to confirm no type errors in the new component.</verify>
  <done>BookmarkButton component exists at src/components/wiki/bookmark-button.tsx with Star icon, optimistic toggle, useTransition loading, and sonner toast feedback.</done>
</task>

<task type="auto">
  <name>Task 2: Wire BookmarkButton into article page</name>
  <files>src/app/(wiki)/wiki/[articleSlug]/page.tsx</files>
  <action>
Update the article page to render BookmarkButton:

1. Add import: `import { isArticleBookmarked } from "@/lib/wiki/queries"` (already imported from queries but isArticleBookmarked is not -- add it to the existing import).
2. Add import: `import { BookmarkButton } from "@/components/wiki/bookmark-button"`.
3. After the existing `const session = await auth()` call (line ~67), add a bookmark check:
   ```tsx
   const bookmarked = session?.user?.id
     ? await isArticleBookmarked(session.user.id, article.id)
     : false;
   ```
4. Render BookmarkButton next to the RegenerateButton. Place it in the same area but visible to ALL authenticated users (not just admins). Specifically, add a flex container that holds both the bookmark button and the admin regenerate button:

Replace the current admin regenerate block (lines ~90-95):
```tsx
{session?.user?.role === "admin" && (
  <div className="mb-4">
    <RegenerateButton articleId={article.id} />
  </div>
)}
```

With:
```tsx
<div className="mb-4 flex items-center gap-2">
  <BookmarkButton articleId={article.id} initialBookmarked={bookmarked} />
  {session?.user?.role === "admin" && (
    <RegenerateButton articleId={article.id} />
  )}
</div>
```

This places the bookmark button before the regenerate button, visible to all users, with the admin regenerate button conditionally shown next to it.
  </action>
  <verify>Run `npm run build` to confirm the article page compiles. Grep the article page for "BookmarkButton" and "isArticleBookmarked" to confirm both are present.</verify>
  <done>Article page renders BookmarkButton for all authenticated users. Bookmark initial state is fetched server-side via isArticleBookmarked. Build passes.</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with no errors
2. Grep `src/components/wiki/bookmark-button.tsx` for `toggleBookmark` confirms wiring to server action
3. Grep `src/app/(wiki)/wiki/[articleSlug]/page.tsx` for `BookmarkButton` confirms rendering
4. Grep `src/app/(wiki)/wiki/[articleSlug]/page.tsx` for `isArticleBookmarked` confirms initial state fetch
</verification>

<success_criteria>
- BookmarkButton visible on article pages for all authenticated users
- Star icon reflects bookmark state (filled yellow when bookmarked, outline when not)
- Clicking toggles bookmark with optimistic UI update and toast notification
- Bookmarked articles appear on home dashboard (existing wiring from 04-03)
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/04-wiki-viewer/04-05-SUMMARY.md`
</output>
