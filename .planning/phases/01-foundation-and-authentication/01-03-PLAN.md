---
phase: 01-foundation-and-authentication
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - src/app/(wiki)/profile/page.tsx
  - src/app/(wiki)/profile/actions.ts
  - src/app/(wiki)/profile/notification-form.tsx
  - src/app/(wiki)/profile/profile-form.tsx
  - src/components/common/user-menu.tsx
autonomous: true

must_haves:
  truths:
    - "User can edit their display name from the profile page"
    - "User can set a custom avatar URL from the profile page"
    - "User can toggle Slack notification preference on/off"
    - "User can toggle email notification preference on/off"
    - "User can toggle mention notification preference on/off"
    - "User can toggle activity notification preference on/off"
    - "User can enter their Slack user ID for DM notifications"
    - "Profile changes persist across page refresh"
  artifacts:
    - path: "src/app/(wiki)/profile/page.tsx"
      provides: "Profile page with name, avatar, and notification forms"
      contains: "ProfileForm"
    - path: "src/app/(wiki)/profile/actions.ts"
      provides: "Server actions for profile and notification updates"
      exports: ["updateProfile", "updateNotificationPreferences"]
    - path: "src/app/(wiki)/profile/profile-form.tsx"
      provides: "Client form for display name and avatar URL"
      contains: "useFormState"
    - path: "src/app/(wiki)/profile/notification-form.tsx"
      provides: "Client form for notification preference toggles"
      contains: "Switch"
    - path: "src/components/common/user-menu.tsx"
      provides: "Extracted user menu component with profile link"
      contains: "DropdownMenu"
  key_links:
    - from: "src/app/(wiki)/profile/profile-form.tsx"
      to: "src/app/(wiki)/profile/actions.ts"
      via: "form action binding to updateProfile"
      pattern: "updateProfile"
    - from: "src/app/(wiki)/profile/notification-form.tsx"
      to: "src/app/(wiki)/profile/actions.ts"
      via: "form action binding to updateNotificationPreferences"
      pattern: "updateNotificationPreferences"
    - from: "src/app/(wiki)/profile/actions.ts"
      to: "src/lib/db/index.ts"
      via: "db.update(users) for persisting changes"
      pattern: "db\\.update\\(users\\)"
    - from: "src/app/(wiki)/profile/page.tsx"
      to: "src/lib/auth/index.ts"
      via: "auth() to get current user session and load user data"
      pattern: "auth\\(\\)"
---

<objective>
Build the user profile page where users can edit their display name, avatar URL, and notification preferences (Slack, email, mention, activity toggles).

Purpose: Completes the AUTH-04 (edit display name and avatar) and AUTH-05 (notification preferences) requirements. Users need a way to manage their identity and control how they receive notifications from the system.
Output: Profile page with two form sections (identity + notifications), server actions for persistence, and an extracted user menu component.
</objective>

<execution_context>
@/Users/michael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-and-authentication/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create profile page with display name/avatar editing and notification preferences</name>
  <files>
    src/app/(wiki)/profile/page.tsx
    src/app/(wiki)/profile/actions.ts
    src/app/(wiki)/profile/profile-form.tsx
    src/app/(wiki)/profile/notification-form.tsx
  </files>
  <action>
    1. Install additional shadcn/ui components:
       ```
       npx shadcn@latest add input label switch separator toast
       ```
       Also install sonner for toast notifications if not already present:
       ```
       npx shadcn@latest add sonner
       ```
       Add the Toaster component to the root layout if not already there.

    2. Create `src/app/(wiki)/profile/actions.ts` -- Server actions:

       **`updateProfile(formData: FormData)`:**
       - Get session via `auth()`, throw if not authenticated
       - Extract `name` (string, required, trim, validate length 1-100) and `avatarUrl` (string, optional, validate URL format if provided) from formData
       - Use Zod schema for validation:
         ```typescript
         const profileSchema = z.object({
           name: z.string().trim().min(1, "Name is required").max(100),
           avatarUrl: z.string().url("Invalid URL").optional().or(z.literal("")),
         });
         ```
       - Update the users table: `db.update(users).set({ name, avatarUrl: avatarUrl || null, updatedAt: new Date() }).where(eq(users.id, session.user.id))`
       - Call `revalidatePath("/profile")`
       - Return `{ success: true }` or `{ success: false, error: string }`

       **`updateNotificationPreferences(formData: FormData)`:**
       - Get session via `auth()`, throw if not authenticated
       - Extract boolean toggles from formData (checkboxes/switches send "on" or are absent):
         - notifySlackEnabled, notifyEmailEnabled, notifyOnMention, notifyOnActivity
       - Extract slackUserId (string, optional)
       - Update users table with all preference fields
       - Call `revalidatePath("/profile")`
       - Return `{ success: true }` or `{ success: false, error: string }`

       **`getUserProfile()`:**
       - Get session via `auth()`, throw if not authenticated
       - Query the full user record: `db.select().from(users).where(eq(users.id, session.user.id)).limit(1)`
       - Return the user record (name, email, image, avatarUrl, role, and all notification fields)

    3. Create `src/app/(wiki)/profile/profile-form.tsx` -- Client component:
       - "use client" directive
       - Props: `{ user: { name, email, image, avatarUrl } }`
       - Display:
         - Current Google avatar (from user.image) as a preview, non-editable label "Google avatar"
         - Input field for "Display Name" pre-filled with user.name
         - Input field for "Custom Avatar URL" pre-filled with user.avatarUrl (placeholder: "https://example.com/avatar.jpg")
         - Help text: "Leave empty to use your Google profile picture"
         - Submit button "Save Profile"
       - Use `useActionState` (React 19) or form action binding to call `updateProfile`
       - Show success/error toast via sonner after submission
       - Disable submit button while pending (useTransition or useFormStatus)

    4. Create `src/app/(wiki)/profile/notification-form.tsx` -- Client component:
       - "use client" directive
       - Props: `{ user: { notifySlackEnabled, slackUserId, notifyEmailEnabled, notifyOnMention, notifyOnActivity } }`
       - Display:
         - Section header "Notification Channels"
         - Switch toggle for "Slack DM notifications" with label. When enabled, show an Input for "Slack User ID" (placeholder: "U0XXXXXXXXX") with help text "Find your Slack member ID in your Slack profile"
         - Switch toggle for "Email notifications" with label and help text "Notifications sent to {user.email}"
         - Separator
         - Section header "Notification Types"
         - Switch toggle for "Mentions" -- "Notify when someone @mentions you in a comment"
         - Switch toggle for "Activity" -- "Notify when articles you edited are updated"
       - Submit button "Save Preferences"
       - Use form action binding to call `updateNotificationPreferences`
       - Show success/error toast via sonner after submission

    5. Create `src/app/(wiki)/profile/page.tsx` -- Server component:
       - Call `getUserProfile()` to load user data
       - Page title: "Profile Settings"
       - Two Card sections stacked vertically:
         - Card 1: "Profile" -- contains ProfileForm with user identity data
         - Card 2: "Notification Preferences" -- contains NotificationForm with notification fields
       - Show user's current role as a Badge (read-only, not editable)
       - Show user's email (read-only, not editable -- comes from Google)
  </action>
  <verify>
    Run `npm run build` -- must succeed.
    Run `npx tsc --noEmit` -- must pass.
    Verify profile page exists: `ls src/app/(wiki)/profile/page.tsx`
    Verify server actions exist with both exports: grep for "updateProfile" and "updateNotificationPreferences" in actions.ts
    Verify Zod validation is used in updateProfile action.
  </verify>
  <done>
    Profile page renders at /profile with two sections: (1) Profile card with editable display name and avatar URL, (2) Notification Preferences card with Slack/email channel toggles, Slack user ID input, and mention/activity type toggles. Both forms use server actions with Zod validation, persist to database, show toast feedback, and handle loading states.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract reusable user menu component and wire up navigation</name>
  <files>
    src/components/common/user-menu.tsx
    src/app/(wiki)/layout.tsx
  </files>
  <action>
    1. Create `src/components/common/user-menu.tsx` -- Client component:
       - "use client" directive
       - Install dropdown menu if not present: `npx shadcn@latest add dropdown-menu`
       - Props: `{ user: { name, email, image, avatarUrl, role } }`
       - Display a DropdownMenu (shadcn):
         - Trigger: Avatar image (use avatarUrl if set, fall back to image from Google, fall back to initials). Show the user's name next to the avatar.
         - Menu items:
           - "Profile" -- Link to "/profile"
           - "Admin" -- Link to "/admin/users" (only shown if role === "admin")
           - Separator
           - "Sign Out" -- calls signOut() from "next-auth/react"
       - Use the shadcn Avatar component with AvatarImage and AvatarFallback (initials from name)

    2. Update `src/app/(wiki)/layout.tsx` to use the extracted UserMenu component:
       - Replace any inline user menu/nav with the UserMenu component
       - Pass user data from session to UserMenu: `{ name: session.user.name, email: session.user.email, image: session.user.image, avatarUrl: null, role: session.user.role }`
       - Note: avatarUrl is not on the session -- for now pass null. The Google avatar (session.user.image) will be used. When the user sets a custom avatarUrl, it will be loaded in future iterations or via a DB query in the layout.
       - The nav bar should show: "CodeWiki" (left), UserMenu (right)
       - Use clean Tailwind: `flex items-center justify-between px-6 py-3 border-b`
  </action>
  <verify>
    Run `npm run build` -- must succeed.
    Run `npx tsc --noEmit` -- must pass.
    Verify UserMenu component exists: `ls src/components/common/user-menu.tsx`
    Verify it exports a component that renders DropdownMenu with profile link and sign out.
  </verify>
  <done>
    UserMenu component extracted as reusable client component with avatar, name, dropdown menu (Profile link, conditional Admin link, Sign Out). Wiki layout uses UserMenu in the top nav bar. Navigation between profile, admin, and home is functional.
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- Profile page is accessible at /profile for authenticated users
- Profile form validates input with Zod (name required, avatarUrl must be valid URL or empty)
- Notification preferences form has 4 toggles (Slack, email, mention, activity) + Slack user ID input
- Server actions persist changes to the users table
- UserMenu shows profile link, conditional admin link, and sign out
- Both forms show toast feedback on success/error
</verification>

<success_criteria>
1. User can navigate to /profile and see their current display name, email, avatar, and role
2. User can update display name and avatar URL; changes persist after page refresh
3. User can toggle all 4 notification preferences and enter Slack user ID; changes persist
4. UserMenu dropdown appears in wiki layout nav with profile, admin (if admin), and sign out options
5. Form validation prevents empty names and invalid URLs
6. Toast notifications appear on successful save
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-authentication/01-03-SUMMARY.md`
</output>
