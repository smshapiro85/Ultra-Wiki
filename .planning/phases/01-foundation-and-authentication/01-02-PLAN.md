---
phase: 01-foundation-and-authentication
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/lib/auth/config.ts
  - src/lib/auth/index.ts
  - src/middleware.ts
  - src/types/next-auth.d.ts
  - src/app/api/auth/[...nextauth]/route.ts
  - src/app/layout.tsx
  - src/app/(auth)/login/page.tsx
  - src/app/(auth)/layout.tsx
  - src/app/(admin)/layout.tsx
  - src/app/(admin)/users/page.tsx
  - src/app/(admin)/users/actions.ts
  - src/app/api/users/route.ts
  - src/components/common/session-provider.tsx
autonomous: true
user_setup:
  - service: google-oauth
    why: "Google OIDC is the sole authentication method"
    env_vars:
      - name: AUTH_GOOGLE_ID
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client ID"
      - name: AUTH_GOOGLE_SECRET
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client Secret"
      - name: AUTH_SECRET
        source: "Generate with: openssl rand -base64 32"
    dashboard_config:
      - task: "Create OAuth 2.0 Client ID (Web application type)"
        location: "Google Cloud Console -> APIs & Services -> Credentials"
      - task: "Add authorized redirect URI: http://localhost:3000/api/auth/callback/google"
        location: "Google Cloud Console -> OAuth Client -> Authorized redirect URIs"
  - service: neon-postgres
    why: "Database for all application data"
    env_vars:
      - name: DATABASE_URL
        source: "Neon Console -> Connection Details -> Pooled connection string"
      - name: DATABASE_URL_UNPOOLED
        source: "Neon Console -> Connection Details -> Direct (non-pooled) connection string"

must_haves:
  truths:
    - "User can sign in with Google and see a logged-in state"
    - "First user to log in is automatically assigned admin role"
    - "Subsequent users are assigned regular user role"
    - "Admin can promote a regular user to admin"
    - "Admin can demote an admin to user (but not themselves)"
    - "Unauthenticated users are redirected to login page"
    - "Non-admin users cannot access admin pages"
  artifacts:
    - path: "src/lib/auth/config.ts"
      provides: "Edge-safe auth config (no DB adapter)"
      contains: "Google"
    - path: "src/lib/auth/index.ts"
      provides: "Full auth with DrizzleAdapter, JWT strategy, first-user-is-admin"
      exports: ["handlers", "auth", "signIn", "signOut"]
    - path: "src/middleware.ts"
      provides: "Route protection middleware"
      contains: "authConfig"
    - path: "src/types/next-auth.d.ts"
      provides: "Type augmentation for role and id on session"
      contains: "role"
    - path: "src/app/(auth)/login/page.tsx"
      provides: "Login page with Google sign-in button"
      contains: "signIn"
    - path: "src/app/(admin)/users/page.tsx"
      provides: "Admin user management page"
      contains: "promoteUser"
    - path: "src/app/(admin)/users/actions.ts"
      provides: "Server actions for promote/demote"
      exports: ["promoteUser", "demoteUser"]
  key_links:
    - from: "src/middleware.ts"
      to: "src/lib/auth/config.ts"
      via: "Edge-safe import (NOT from auth/index.ts)"
      pattern: "import.*auth/config"
    - from: "src/lib/auth/index.ts"
      to: "src/lib/db/schema.ts"
      via: "DrizzleAdapter with table references"
      pattern: "DrizzleAdapter.*users.*accounts.*sessions"
    - from: "src/lib/auth/index.ts"
      to: "src/lib/db/index.ts"
      via: "Database client for adapter and first-user check"
      pattern: "import.*db.*from"
    - from: "src/app/(admin)/users/actions.ts"
      to: "src/lib/auth/index.ts"
      via: "auth() call for admin role check"
      pattern: "auth\\(\\)"
    - from: "src/app/api/auth/[...nextauth]/route.ts"
      to: "src/lib/auth/index.ts"
      via: "Route handler exports"
      pattern: "import.*handlers.*from.*auth"
---

<objective>
Implement the complete authentication system using NextAuth v5 with Google OIDC, including the split config pattern for edge/node compatibility, first-user-is-admin logic, role-based route protection, and admin user management.

Purpose: Authentication is the gateway to every feature. Without it, nothing downstream works. The role system (admin/user) gates access to admin features in Phases 2-7.
Output: Working Google OIDC login, JWT sessions with role, route protection middleware, login page, and admin user management page.
</objective>

<execution_context>
@/Users/michael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-and-authentication/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Auth.js v5 split config with Google OIDC, JWT sessions, middleware, and type augmentation</name>
  <files>
    src/lib/auth/config.ts
    src/lib/auth/index.ts
    src/middleware.ts
    src/types/next-auth.d.ts
    src/app/api/auth/[...nextauth]/route.ts
    src/app/layout.tsx
    src/components/common/session-provider.tsx
  </files>
  <action>
    1. Create `src/types/next-auth.d.ts` -- Type augmentation for Auth.js:
       Extend the `Session` interface to include `user.id` (string) and `user.role` (string) alongside DefaultSession["user"]. Extend the `User` interface to include `role` (string). Extend the `JWT` interface (from "next-auth/jwt") to include `id` (string) and `role` (string). Use the exact pattern from research Pattern 6.

    2. Create `src/lib/auth/config.ts` -- Edge-safe auth config (NO database imports):
       - Import Google provider from "next-auth/providers/google"
       - Configure Google provider with AUTH_GOOGLE_ID and AUTH_GOOGLE_SECRET env vars
       - Set `pages.signIn` to "/login"
       - Add `authorized` callback: allow /login access always, redirect unauthenticated users to /login, return true for authenticated
       - Add `jwt` callback: if `user` exists (sign-in), set `token.role = user.role` and `token.id = user.id`
       - Add `session` callback: copy `token.role` and `token.id` to `session.user`
       - Export as `satisfies NextAuthConfig`
       - **CRITICAL:** This file must NOT import anything from `@/lib/db` or `pg` or `@neondatabase/serverless`. It runs in edge runtime.

    3. Create `src/lib/auth/index.ts` -- Full auth with DrizzleAdapter (Node.js only):
       - Import NextAuth, DrizzleAdapter, db, schema tables, and authConfig
       - Configure NextAuth with:
         - `adapter: DrizzleAdapter(db, { usersTable: users, accountsTable: accounts, sessionsTable: sessions, verificationTokensTable: verificationTokens })`
         - `session: { strategy: "jwt" }`
         - Spread authConfig
         - Override `callbacks.jwt`: if `user` exists, query the database for current role (`select role from users where id = user.id`) and set on token. This handles the first-sign-in race condition where createUser event may not have set admin role yet. On subsequent calls (no user), just return token.
         - Override `callbacks.session`: copy token.id and token.role to session.user
         - Add `events.createUser`: count existing users. If count <= 1 (this is the first user), update the user's role to "admin". Import `eq` and `count` from drizzle-orm.
       - Export `{ handlers, auth, signIn, signOut }`

       **CRITICAL for first-user-is-admin race condition:** The `jwt` callback fires after `createUser` event. But to be safe, the `jwt` callback should ALWAYS query the user's role from the database on first sign-in (when `user` is present), not rely on the `user` object passed by the OAuth provider. This ensures the admin role set by `createUser` event is picked up immediately.

    4. Create `src/middleware.ts` -- Edge-safe middleware:
       - Import NextAuth from "next-auth" and authConfig from "@/lib/auth/config" (NOT from "@/lib/auth")
       - Create auth middleware with `NextAuth(authConfig)`
       - Export as default
       - Export config.matcher: `["/((?!api/auth|_next/static|_next/image|favicon.ico).*)"]`

    5. Create `src/app/api/auth/[...nextauth]/route.ts`:
       ```typescript
       import { handlers } from "@/lib/auth";
       export const { GET, POST } = handlers;
       ```

    6. Create `src/components/common/session-provider.tsx` -- Client component wrapper:
       ```typescript
       "use client";
       import { SessionProvider } from "next-auth/react";

       export function AuthSessionProvider({ children }: { children: React.ReactNode }) {
         return <SessionProvider>{children}</SessionProvider>;
       }
       ```

    7. Update `src/app/layout.tsx` -- Wrap the app with SessionProvider:
       Import AuthSessionProvider. Wrap `{children}` inside `<AuthSessionProvider>`. Keep existing html/body structure.
  </action>
  <verify>
    Run `npx tsc --noEmit` -- must pass with no type errors.
    Run `npm run build` -- must succeed. Watch specifically for edge runtime errors (if middleware imports db, the build will fail with "Module not found: pg").
    Verify `src/middleware.ts` imports ONLY from `@/lib/auth/config`, not from `@/lib/auth` or `@/lib/auth/index`.
  </verify>
  <done>
    Auth.js v5 configured with split pattern (edge-safe config + Node.js full auth), Google OIDC provider, JWT sessions with role/id, middleware protecting all routes except login and auth API, type augmentation for role on session, SessionProvider wrapping the app. First-user-is-admin event handler with race-condition-safe JWT callback.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create login page, admin user management, and route group layouts</name>
  <files>
    src/app/(auth)/login/page.tsx
    src/app/(auth)/layout.tsx
    src/app/(wiki)/layout.tsx
    src/app/(wiki)/page.tsx
    src/app/(admin)/layout.tsx
    src/app/(admin)/users/page.tsx
    src/app/(admin)/users/actions.ts
  </files>
  <action>
    1. Install shadcn/ui components needed for this task:
       ```
       npx shadcn@latest add button card table badge avatar
       ```

    2. Create `src/app/(auth)/layout.tsx` -- Minimal layout for auth pages:
       Simple centered layout with no sidebar/nav. Wrap children in a flex container centered both horizontally and vertically, min-h-screen. Add a subtle background.

    3. Create `src/app/(auth)/login/page.tsx` -- Login page:
       - Import `signIn` from "next-auth/react" (client component) OR use a server action that calls `signIn("google")` from "@/lib/auth"
       - Use server action approach (preferred): Create an async function that calls `signIn("google", { redirectTo: "/" })`
       - Display: App logo/name "CodeWiki", brief tagline "AI-powered documentation that stays in sync", a Card component containing a "Sign in with Google" Button
       - Use the shadcn Button with a Google icon (inline SVG or lucide-react icon)
       - If `searchParams.error` exists, show an error message (e.g., "Authentication failed. Please try again.")

    4. Create `src/app/(wiki)/layout.tsx` -- Layout for authenticated wiki pages:
       - This is a server component. Call `auth()` from "@/lib/auth" to get session.
       - If no session, redirect to "/login".
       - For now, render a minimal shell: a top navigation bar with app name "CodeWiki", user info (name, avatar from session.user.image), a user menu dropdown with "Profile" link and "Sign Out" button, and a "Admin" link if session.user.role === "admin".
       - The "Sign Out" button should call a server action that invokes `signOut()` from "@/lib/auth".
       - Render {children} below the nav.

    5. Create `src/app/(wiki)/page.tsx` -- Placeholder home page:
       - Server component. Call `auth()` to get session.
       - Display "Welcome, {session.user.name}" and "Role: {session.user.role}".
       - This is a placeholder -- Phase 4 will replace it with the real dashboard.

    6. Create `src/app/(admin)/layout.tsx` -- Admin route group layout:
       - Server component. Call `auth()` to get session.
       - If `session.user.role !== "admin"`, redirect to "/" (or show 403).
       - Render admin navigation (link to "Users") plus {children}.

    7. Create `src/app/(admin)/users/actions.ts` -- Server actions for user management:
       - `promoteUser(userId: string)`: Check caller is admin via auth(), update user role to "admin", revalidate path "/admin/users"
       - `demoteUser(userId: string)`: Check caller is admin, prevent self-demotion (throw if userId === session.user.id), update user role to "user", revalidate path
       - `getUsers()`: Check caller is admin, return all users with id, name, email, role, image, createdAt. Order by createdAt asc.
       - Use `eq` from drizzle-orm, import db and users schema.

    8. Create `src/app/(admin)/users/page.tsx` -- Admin user management page:
       - Server component. Call `getUsers()` to fetch all users.
       - Display a Table (shadcn) with columns: Avatar (small image), Name, Email, Role (Badge: "admin" = destructive variant, "user" = secondary), Actions.
       - Actions column: If user is admin and NOT the current user, show "Demote" button. If user is "user", show "Promote" button.
       - Promote/Demote buttons should call the server actions. Use a client component wrapper for the action buttons with form action binding or useTransition.
       - Show current user count and admin count at the top.
  </action>
  <verify>
    Run `npm run build` -- must succeed.
    Run `npx tsc --noEmit` -- must pass.
    Verify route groups exist: `ls src/app/(auth)/login/page.tsx src/app/(wiki)/page.tsx src/app/(admin)/users/page.tsx`
    Verify server actions exist: `ls src/app/(admin)/users/actions.ts`
  </verify>
  <done>
    Login page with Google sign-in button renders at /login. Authenticated users see wiki layout with nav and user menu. Admin users can access /admin/users to see all users in a table with promote/demote actions. Non-admin users are redirected away from admin pages. Sign out works from the user menu.
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds with no edge runtime errors
- Auth split pattern: middleware imports only from config.ts, not auth/index.ts
- Type augmentation: session.user.role and session.user.id are typed as string
- Route groups: (auth), (wiki), (admin) each have their own layout
- Admin guard: (admin)/layout.tsx checks role before rendering
- Server actions: promoteUser and demoteUser check admin role, demoteUser prevents self-demotion
</verification>

<success_criteria>
1. Auth.js v5 is configured with Google OIDC, JWT sessions, and DrizzleAdapter
2. Middleware protects all routes except /login and /api/auth/*
3. First-user-is-admin logic is implemented in createUser event with safe JWT re-query
4. Login page renders with Google sign-in button
5. Admin user management page shows all users with promote/demote actions
6. Non-admin users cannot access /admin/* routes
7. The project builds without edge runtime errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-authentication/01-02-SUMMARY.md`
</output>
