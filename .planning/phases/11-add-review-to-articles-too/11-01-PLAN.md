---
phase: 11-add-review-to-articles-too
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/wiki/queries.ts
  - src/components/wiki/article-review-queue.tsx
  - src/components/wiki/article-tabs.tsx
  - src/app/(wiki)/wiki/[articleSlug]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin users see a Review Queue tab on article pages positioned after Comments and before History"
    - "Review Queue tab label shows count of pending items in parentheses when count > 0"
    - "Review Queue tab content shows merge conflict status and individual AI review annotations with dismiss capability"
    - "Non-admin users do NOT see the Review Queue tab"
    - "Comments tab label shows comment count in parentheses when count > 0 for all users"
  artifacts:
    - path: "src/lib/wiki/queries.ts"
      provides: "getArticleCommentCount query"
      contains: "getArticleCommentCount"
    - path: "src/components/wiki/article-review-queue.tsx"
      provides: "Article-scoped review queue tab content component"
      exports: ["ArticleReviewQueue"]
    - path: "src/components/wiki/article-tabs.tsx"
      provides: "5-tab system with conditional Review Queue tab and count labels"
      contains: "reviewQueueContent"
    - path: "src/app/(wiki)/wiki/[articleSlug]/page.tsx"
      provides: "Server-side count fetching and conditional tab rendering"
      contains: "commentCount"
  key_links:
    - from: "src/app/(wiki)/wiki/[articleSlug]/page.tsx"
      to: "src/lib/wiki/queries.ts"
      via: "getArticleCommentCount call in Promise.all"
      pattern: "getArticleCommentCount"
    - from: "src/app/(wiki)/wiki/[articleSlug]/page.tsx"
      to: "src/components/wiki/article-tabs.tsx"
      via: "commentCount, reviewCount, reviewQueueContent props"
      pattern: "commentCount=|reviewCount=|reviewQueueContent="
    - from: "src/components/wiki/article-tabs.tsx"
      to: "tab labels"
      via: "conditional count display in tab trigger text"
      pattern: "commentCount.*\\(.*\\)"
---

<objective>
Add article-level Review Queue tab and comment counts to article page tabs.

Purpose: Admins can review merge conflicts and AI annotations directly on each article page, and all users can see comment activity at a glance from the tab label.
Output: Updated article page with 5th Review Queue tab (admin-only) and comment count on Comments tab.
</objective>

<execution_context>
@/Users/michael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-add-review-to-articles-too/11-CONTEXT.md
@.planning/phases/11-add-review-to-articles-too/11-RESEARCH.md
@src/components/wiki/article-tabs.tsx
@src/app/(wiki)/wiki/[articleSlug]/page.tsx
@src/lib/wiki/queries.ts
@src/components/wiki/annotation-banner.tsx
@src/app/(admin)/admin/review-queue/review-queue-list.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getArticleCommentCount query and create ArticleReviewQueue component</name>
  <files>src/lib/wiki/queries.ts, src/components/wiki/article-review-queue.tsx</files>
  <action>
**In `src/lib/wiki/queries.ts`:**

Add a new exported function `getArticleCommentCount(articleId: string): Promise<number>` that counts all comments (not just root-level) for an article. Use the existing `comments` table import and drizzle query builder pattern matching `getActiveAnnotationCount`. Query: `select count(*) from comments where articleId = $1`.

**In `src/components/wiki/article-review-queue.tsx`:**

Create a new client component `ArticleReviewQueue` that accepts `{ articleId: string; needsReview: boolean }` props.

This component:
1. Fetches annotations from the existing API endpoint `/api/articles/${articleId}/annotations` on mount (same as AnnotationBanner does)
2. Renders a list of review items:
   - If `needsReview` is true, show a card with an orange "Needs Review" badge, text "This article has unresolved merge conflicts", and a relative timestamp
   - For each annotation, show a card with severity icon (reuse the same icon pattern from AnnotationBanner: Info=blue, AlertTriangle=amber, OctagonAlert=red), the section heading, concern text, timestamp, and a Dismiss button
3. Dismiss calls the existing `POST /api/articles/${articleId}/annotations/${annotationId}/dismiss` endpoint (same as AnnotationBanner)
4. Shows "No review items" empty state when both needsReview is false and no annotations exist
5. Uses Card/CardContent from shadcn/ui and Badge for status indicators

Do NOT duplicate the full ReviewQueueList from the admin page. This is a simpler, article-scoped view without search/category filter/sort controls (per user decision: reuse concepts but the single-article context doesn't need those controls). The card markup will be similar in spirit to the admin version but tailored for in-article context (no link to article since we're already on it).

Import icons from lucide-react: AlertTriangle, Info, OctagonAlert, X, Loader2. Import Badge, Card, CardContent, Button from shadcn/ui. Import toast from sonner for dismiss feedback.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors. Verify `getArticleCommentCount` is exported from queries.ts. Verify `ArticleReviewQueue` is exported from the new file.
  </verify>
  <done>
`getArticleCommentCount` query function exists and returns a number. `ArticleReviewQueue` component exists, fetches annotations via existing API, renders review items with dismiss capability, handles empty state.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update ArticleTabs for 5th tab and counts, wire into article page</name>
  <files>src/components/wiki/article-tabs.tsx, src/app/(wiki)/wiki/[articleSlug]/page.tsx</files>
  <action>
**In `src/components/wiki/article-tabs.tsx`:**

1. Extend `ArticleTabsProps` interface to add:
   - `reviewQueueContent?: React.ReactNode` (optional -- undefined for non-admin)
   - `commentCount?: number`
   - `reviewCount?: number`

2. Update the Comments TabsTrigger text: show `Comments{commentCount ? \` (\${commentCount})\` : ""}` -- count only when > 0

3. Add a conditional Review Queue tab AFTER Comments and BEFORE History (per locked decision). Only render the TabsTrigger and TabsContent when `reviewQueueContent` is provided:
   ```
   {reviewQueueContent && (
     <TabsTrigger value="review">
       <ClipboardList className="size-4" />
       Review Queue{reviewCount ? ` (${reviewCount})` : ""}
     </TabsTrigger>
   )}
   ```
   And matching:
   ```
   {reviewQueueContent && (
     <TabsContent value="review">{reviewQueueContent}</TabsContent>
   )}
   ```

4. Add `ClipboardList` to the lucide-react imports.

**In `src/app/(wiki)/wiki/[articleSlug]/page.tsx`:**

1. Import `getArticleCommentCount` from queries and `ArticleReviewQueue` from the new component.

2. Add `getArticleCommentCount(article.id)` to the existing `Promise.all` call (alongside bookmarked, annotationCount, fileLinks, dbTables). Destructure the new value as `commentCount`.

3. Compute `reviewCount` after the Promise.all: `const reviewCount = (article.needsReview ? 1 : 0) + annotationCount;`

4. Determine admin status: `const isAdmin = session?.user?.role === "admin";`

5. Pass new props to `<ArticleTabs>`:
   - `commentCount={commentCount}`
   - `reviewCount={isAdmin ? reviewCount : undefined}`
   - `reviewQueueContent={isAdmin ? <ArticleReviewQueue articleId={article.id} needsReview={article.needsReview} /> : undefined}`

This ensures non-admin users never receive the Review Queue tab content at all (it's undefined, so ArticleTabs won't render it). Comment count is visible to all users per locked decision.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors. Run `npm run build` to verify the build succeeds. Manually verify by visiting an article page: the Comments tab should show a count in parentheses if comments exist, and admin users should see the Review Queue tab between Comments and History.
  </verify>
  <done>
Article page renders 5 tabs for admin (Article, Technical View, Comments (N), Review Queue (N), History) and 4 tabs for non-admin (Article, Technical View, Comments (N), History). Counts only appear when > 0. Review Queue tab shows article-scoped review items with dismiss.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run build` succeeds
3. Article page loads without errors for both admin and non-admin users
4. Comments tab shows "(N)" count when comments exist, no count when 0
5. Review Queue tab appears for admin users only, positioned after Comments and before History
6. Review Queue tab shows "(N)" count when review items exist
7. Review Queue tab content shows merge conflict card (when needsReview) and annotation cards with dismiss
8. Non-admin users see exactly 4 tabs with no trace of review queue
</verification>

<success_criteria>
- Admin sees 5 tabs: Article, Technical View, Comments (N), Review Queue (N), History
- Non-admin sees 4 tabs: Article, Technical View, Comments (N), History
- Tab counts only appear in parentheses when > 0
- Review Queue tab content shows article-scoped review items (merge conflicts + annotations)
- Annotations can be dismissed from the Review Queue tab
- No new dependencies installed
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/11-add-review-to-articles-too/11-01-SUMMARY.md`
</output>
