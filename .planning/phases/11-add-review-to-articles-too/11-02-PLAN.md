---
phase: 11-add-review-to-articles-too
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/wiki/queries.ts
  - src/app/(wiki)/layout.tsx
  - src/components/wiki/app-sidebar.tsx
  - src/components/wiki/sortable-sidebar.tsx
  - src/components/wiki/sortable-item.tsx
  - src/components/wiki/category-tree.tsx
autonomous: true

must_haves:
  truths:
    - "Admin users see a subtle count badge on sidebar articles that have pending review items"
    - "Non-admin users see no review badges in the sidebar"
    - "Sidebar badges show accurate counts matching (needsReview ? 1 : 0) + activeAnnotationCount"
    - "Sidebar badges only appear when count > 0"
    - "Badge counts are fetched via a single batch query, not per-article"
  artifacts:
    - path: "src/lib/wiki/queries.ts"
      provides: "getReviewCountsByArticle batch query"
      contains: "getReviewCountsByArticle"
    - path: "src/app/(wiki)/layout.tsx"
      provides: "Batch review count fetch and prop passing"
      contains: "getReviewCountsByArticle"
    - path: "src/components/wiki/app-sidebar.tsx"
      provides: "reviewCounts prop threading"
      contains: "reviewCounts"
    - path: "src/components/wiki/sortable-item.tsx"
      provides: "Badge rendering for admin articles"
      contains: "reviewCount"
    - path: "src/components/wiki/category-tree.tsx"
      provides: "Badge rendering for admin articles"
      contains: "reviewCount"
  key_links:
    - from: "src/app/(wiki)/layout.tsx"
      to: "src/lib/wiki/queries.ts"
      via: "getReviewCountsByArticle call"
      pattern: "getReviewCountsByArticle"
    - from: "src/app/(wiki)/layout.tsx"
      to: "src/components/wiki/app-sidebar.tsx"
      via: "reviewCounts prop"
      pattern: "reviewCounts="
    - from: "src/components/wiki/app-sidebar.tsx"
      to: "src/components/wiki/sortable-sidebar.tsx"
      via: "reviewCounts prop"
      pattern: "reviewCounts="
    - from: "src/components/wiki/sortable-sidebar.tsx"
      to: "src/components/wiki/sortable-item.tsx"
      via: "reviewCount prop per item"
      pattern: "reviewCount="
---

<objective>
Add subtle review item count badges to sidebar articles for admin users.

Purpose: Admins can scan the sidebar and instantly see which articles need attention without opening each one.
Output: Sidebar articles display a small muted count badge when they have pending review items (merge conflicts or active AI annotations). Non-admin users see no badges.
</objective>

<execution_context>
@/Users/michael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-add-review-to-articles-too/11-CONTEXT.md
@.planning/phases/11-add-review-to-articles-too/11-RESEARCH.md
@src/app/(wiki)/layout.tsx
@src/components/wiki/app-sidebar.tsx
@src/components/wiki/sortable-sidebar.tsx
@src/components/wiki/sortable-item.tsx
@src/components/wiki/category-tree.tsx
@src/lib/wiki/queries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add batch review count query and wire through wiki layout to AppSidebar</name>
  <files>src/lib/wiki/queries.ts, src/app/(wiki)/layout.tsx, src/components/wiki/app-sidebar.tsx</files>
  <action>
**In `src/lib/wiki/queries.ts`:**

Add a new exported function `getReviewCountsByArticle(): Promise<Map<string, number>>`. This performs a single SQL query returning articleId + reviewCount for all articles that have either `needs_review = true` OR active (non-dismissed) AI review annotations. The count formula is: `(CASE WHEN needs_review THEN 1 ELSE 0 END) + COALESCE(annotation_count, 0)`.

```sql
SELECT
  a.id AS "articleId",
  (CASE WHEN a.needs_review THEN 1 ELSE 0 END +
   COALESCE(ann.count, 0))::int AS "reviewCount"
FROM articles a
LEFT JOIN (
  SELECT article_id, COUNT(*) AS count
  FROM ai_review_annotations
  WHERE is_dismissed = false
  GROUP BY article_id
) ann ON a.id = ann.article_id
WHERE a.needs_review = true OR ann.count > 0
```

Return a `Map<string, number>` with articleId as key and reviewCount as value. Use `db.execute(sql\`...\`)` pattern matching the existing `getReviewQueueItems` function.

**In `src/app/(wiki)/layout.tsx`:**

1. Import `getReviewCountsByArticle` from queries.
2. Conditionally fetch review counts only for admin users. After the existing `getCategoryTreeWithArticles()` call, add: if `user.role === "admin"`, call `getReviewCountsByArticle()`. For non-admin, use an empty Map. These two calls (categoryTree and reviewCounts) can be parallelized with `Promise.all` since they're independent.
3. Pass `reviewCounts` as a new prop to `<AppSidebar>`: `reviewCounts={reviewCounts}`.

**In `src/components/wiki/app-sidebar.tsx`:**

1. Update `AppSidebarProps` to add `reviewCounts?: Map<string, number>`.
2. Pass `reviewCounts` through to both `<SortableSidebar>` and `<CategoryTree>`: `reviewCounts={reviewCounts}`.

Note: The `Map<string, number>` will be serialized over the server/client boundary. Since AppSidebar is a client component, the Map will be serialized as a plain object. To handle this, convert it: accept `reviewCounts` as `Record<string, number>` in the client components (or convert with `Object.entries` on the server side before passing). Actually, since Next.js cannot serialize Map objects as props from server to client components, convert the Map to a plain `Record<string, number>` (using `Object.fromEntries(reviewCounts)`) in `layout.tsx` before passing as a prop. Update `AppSidebarProps` to use `reviewCounts?: Record<string, number>`.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors. Verify `getReviewCountsByArticle` is exported. Verify layout.tsx passes reviewCounts prop to AppSidebar without errors.
  </verify>
  <done>
Batch query `getReviewCountsByArticle` exists and returns review counts efficiently. Wiki layout fetches counts for admin users and passes them as a serializable `Record<string, number>` through AppSidebar.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add review count badges to SortableSidebar, SortableItem, and CategoryTree</name>
  <files>src/components/wiki/sortable-sidebar.tsx, src/components/wiki/sortable-item.tsx, src/components/wiki/category-tree.tsx</files>
  <action>
**In `src/components/wiki/sortable-sidebar.tsx`:**

1. Update `SortableSidebarProps` to add `reviewCounts?: Record<string, number>`.
2. When rendering `<SortableItem>`, pass a `reviewCount` prop for article items: `reviewCount={item.type === "article" && isAdmin ? (reviewCounts?.[item.id] ?? 0) : 0}`.

**In `src/components/wiki/sortable-item.tsx`:**

1. Add `reviewCount?: number` to `SortableItemProps`.
2. After the Name/Link section and before the context menu section, render the badge for article items when `reviewCount > 0`:
   ```tsx
   {isArticle && reviewCount > 0 && (
     <span className="ml-auto shrink-0 flex items-center justify-center size-5 rounded-full bg-muted text-[10px] font-medium text-muted-foreground">
       {reviewCount}
     </span>
   )}
   ```
   The badge should be positioned between the article name and the context menu. It uses `ml-auto` to push to the right. The styling is subtle per user decision: small muted circle with small text, not a bright notification badge. Use `bg-muted` and `text-muted-foreground` for a subdued look that works in both light and dark modes.

3. Adjust the context menu container: since the badge uses `ml-auto`, the context menu div should NOT also use `ml-auto`. Remove `ml-auto` from the context menu wrapper if present and keep it only on the badge (or whichever comes first). The layout should be: `[name flex-1] [badge ml-auto if present] [context-menu shrink-0]`. If there's no badge, the context menu's existing `ml-auto` handles right-alignment. To handle both cases cleanly, keep the article name as `flex-1`, the badge as `shrink-0` with no ml-auto (the flex-1 on the name pushes everything right), and context menu as `shrink-0`.

**In `src/components/wiki/category-tree.tsx`:**

1. Update `CategoryTreeProps` to add `reviewCounts?: Record<string, number>`.
2. Pass `reviewCounts` down to `<CategoryNode>` instances.
3. Update `CategoryNodeProps` to add `reviewCounts?: Record<string, number>`.
4. In the article rendering section of `CategoryNode`, after the article title `<span>` inside the `SidebarMenuSubButton`, add a badge:
   ```tsx
   {(() => {
     const count = reviewCounts?.[article.id] ?? 0;
     return count > 0 ? (
       <span className="ml-auto shrink-0 flex items-center justify-center size-5 rounded-full bg-muted text-[10px] font-medium text-muted-foreground">
         {count}
       </span>
     ) : null;
   })()}
   ```
   Position this inside the `div.group/item` wrapper, after the `SidebarMenuSubButton` and before the `ArticleContextMenu`. The badge is only visible when `isAdmin` is true (in practice, CategoryTree is only rendered for non-admin users based on the current AppSidebar logic, so badges won't appear there — but include the logic for correctness in case the component is reused). Actually, since CategoryTree is only used for non-admin users (AppSidebar renders SortableSidebar for admin), and the layout.tsx passes an empty record for non-admin, the badges will naturally not appear. Still, guard with `isAdmin` check for safety — but since CategoryTree doesn't receive `isAdmin` in a way that would show badges (non-admin users get empty reviewCounts), this is handled by the data being empty.

Note: The badge should ONLY appear for admin users. Since the wiki layout only fetches review counts for admin users (non-admin gets empty record), and SortableSidebar is only rendered for admin users, the badge will only appear where appropriate. CategoryTree (non-admin) will receive an empty reviewCounts and naturally show no badges.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors. Run `npm run build` to verify the build succeeds. For admin users, articles with review items should show a small circular badge with the count. For non-admin users, no badges should be visible.
  </verify>
  <done>
Sidebar articles display subtle muted count badges for admin users when review items exist. Badges show accurate counts (needsReview + annotations). Non-admin users see no badges. Badges are rendered in both SortableSidebar (admin) and CategoryTree (non-admin, but with empty data so no badges show).
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run build` succeeds
3. Admin user sees subtle count badges on sidebar articles with pending review items
4. Non-admin user sees no badges in the sidebar
5. Badge count matches (needsReview ? 1 : 0) + active annotation count
6. Badges only appear when count > 0
7. Badge styling is subtle: small muted circle with small text, not bright/alarming
8. Only one database query is made for all sidebar badges (batch query, not N+1)
9. Sidebar load time is not noticeably impacted
</verification>

<success_criteria>
- Admin sidebar shows subtle count badges on articles with pending review items
- Non-admin sidebar shows no review badges
- Badges are small, muted circles with count text (not bright alerts)
- Single batch query fetches all review counts efficiently
- Build passes cleanly
- No new dependencies installed
</success_criteria>

<output>
After completion, create `.planning/phases/11-add-review-to-articles-too/11-02-SUMMARY.md`
</output>
