---
phase: 08-ai-prompt-refinement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/ai/prompts.ts
autonomous: false
gap_closure: false

must_haves:
  truths:
    - "The analysis prompt includes an explicit category strategy section with deterministic rules for reuse vs. creation"
    - "The category strategy defines: when a code folder becomes one category, when it becomes multiple articles in one category, and naming conventions"
    - "The prompt instructs the LLM to match existing category naming patterns (casing, pluralization, word choice) before inventing new names"
    - "The prompt includes anchoring rules: given the same source files and same category tree, produce the same assignments"
    - "The generation prompt explicitly states: never start article content with the article title"
    - "The generation prompt states: the first line of content must be the first section heading or introductory paragraph, not a title repetition"
  artifacts:
    - path: "src/lib/ai/prompts.ts"
      provides: "Updated DEFAULT_ANALYSIS_PROMPT with category strategy, updated DEFAULT_ARTICLE_STYLE_PROMPT with no-title-duplication and heading rules"
  key_links:
    - from: "src/lib/ai/prompts.ts"
      to: "src/lib/ai/analyze.ts"
      via: "buildAnalysisPrompt called during analysis step"
      pattern: "buildAnalysisPrompt"
    - from: "src/lib/ai/prompts.ts"
      to: "src/lib/ai/generate.ts"
      via: "buildGenerationPrompt called during generation step"
      pattern: "buildGenerationPrompt"
---

<objective>
Harden the AI prompts to produce consistent, predictable category structures and article content across every pipeline run. The two biggest issues today:

1. **Category drift**: The same code folder (e.g., `resource-library/`) sometimes becomes a top-level category, sometimes a subcategory under a "Modules" parent, sometimes multiple categories — depending on the run. There is no explicit strategy in the prompt for when to create vs. reuse categories.

2. **Title duplication**: Generated articles sometimes start with an H1 that repeats the article title, which looks duplicative since the article page already renders the title above the content.

This plan updates the default prompts in `src/lib/ai/prompts.ts` to fix both issues. It must first analyze the existing database state (categories, articles, their relationships) to understand what patterns have already been established, then codify those patterns into explicit prompt instructions.

Purpose: Eliminate run-to-run inconsistency in category creation and article structure.
Output: Updated DEFAULT_ANALYSIS_PROMPT and DEFAULT_ARTICLE_STYLE_PROMPT in prompts.ts.
</objective>

<execution_context>
@/Users/michael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/ai/prompts.ts
@src/lib/ai/schemas.ts
@src/lib/ai/analyze.ts
@src/lib/ai/generate.ts
@src/lib/db/schema.ts
</context>

<tasks>

<task type="manual">
  <name>Task 1: Analyze existing category and article data to understand current patterns</name>
  <files>src/lib/ai/prompts.ts</files>
  <action>
**Before writing any prompt changes, analyze the existing data to inform the strategy.**

Connect to the database (or query via the app) to understand:

1. **Category structure**: List all categories with their parent relationships. Identify:
   - How many top-level categories exist vs. subcategories
   - Naming patterns (singular vs. plural, title case vs. sentence case)
   - Which categories map to code folders vs. which are conceptual groupings
   - Any inconsistencies (duplicate concepts under different names, orphaned categories)

2. **Article-to-category mapping**: For each category, count how many articles it contains. Identify:
   - Categories with only 1 article (might be over-fragmented)
   - Articles that seem like they belong in a different category
   - Whether the same code folder's files ended up in multiple different categories

3. **Article structure**: Sample 5-10 articles and check:
   - Do they start with an H1 that duplicates the title?
   - What heading levels do they use (H1 vs. H2 for top sections)?
   - Is there a consistent pattern or is it mixed?

Document findings in a brief analysis block within the prompt file as a comment, then use those findings to inform the prompt changes in Task 2.

**SQL queries to run (via `psql` or app DB connection):**
```sql
-- Category tree
SELECT c.id, c.name, c.slug, p.name AS parent_name
FROM categories c
LEFT JOIN categories p ON c.parent_id = p.id
ORDER BY p.name NULLS FIRST, c.name;

-- Articles per category
SELECT c.name AS category, COUNT(a.id) AS article_count
FROM categories c
LEFT JOIN articles a ON a.category_id = c.id
GROUP BY c.name
ORDER BY article_count DESC;

-- Sample article content starts (first 200 chars)
SELECT a.title, LEFT(a.content_markdown, 200) AS content_start
FROM articles a
LIMIT 10;
```

Use these findings to write the category strategy and content rules in Task 2.
  </action>
  <verify>
Confirm the analysis was performed and findings documented. The analysis should identify at least: category naming patterns, category depth patterns, and article content starting patterns.
  </verify>
  <done>
Existing data analyzed. Category patterns, naming conventions, and article content structure documented. Findings ready to inform prompt changes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update DEFAULT_ANALYSIS_PROMPT with explicit category strategy</name>
  <files>src/lib/ai/prompts.ts</files>
  <action>
**Update the DEFAULT_ANALYSIS_PROMPT in src/lib/ai/prompts.ts** to include an explicit category strategy section. Add the following after the existing "### Guidelines" section:

```
### Category Strategy (CRITICAL — follow exactly)

You MUST follow these rules when assigning articles to categories:

**Rule 1: Reuse over create.** Always place an article in an existing category if one fits, even loosely. Only create a new category when NO existing category covers the topic. Creating a new category requires explicit justification in the change_summary.

**Rule 2: One code folder = one category.** When source files come from the same code folder (e.g., `src/features/resource-library/`), all articles derived from those files belong in the SAME category. Do not split a single folder's files across multiple categories. Do not create a separate category for each file.

**Rule 3: Match existing naming conventions.** Look at the existing category tree and match:
- Casing (if existing categories use Title Case, use Title Case)
- Pluralization (if existing categories use singular nouns, use singular)
- Naming style (if existing categories are short labels like "Authentication", don't create verbose names like "User Authentication and Authorization Module")

**Rule 4: Flat over nested.** Prefer top-level categories unless there is an existing parent-child pattern that clearly fits. Do not create subcategory hierarchies speculatively.

**Rule 5: No "Modules" parent.** Do not create generic parent categories like "Modules", "Features", or "Components" to group other categories. Each functional area is a top-level category.

**Rule 6: Stable assignments.** If an article already exists in a category, do NOT move it to a different category during an update — even if a "better" category exists. Only move articles when explicitly requested. Category stability is more important than perfect organization.
```

Also update the `buildAnalysisPrompt` function's category reuse directive (the "IMPORTANT:" block after the category tree) to reinforce Rule 1:

```
IMPORTANT: You MUST use an existing category unless absolutely no existing category covers the topic. Creating a new category requires explicit justification in the change_summary. When in doubt, use the closest existing category. Category consistency across runs is critical — the same source folder must always map to the same category.
```
  </action>
  <verify>
Read src/lib/ai/prompts.ts and confirm: the Category Strategy section exists with all 6 rules, the IMPORTANT directive is updated. Run `npx tsc --noEmit` to verify no syntax errors.
  </verify>
  <done>
DEFAULT_ANALYSIS_PROMPT includes explicit 6-rule category strategy. Rules cover: reuse over create, one-folder-one-category, naming convention matching, flat-over-nested preference, no generic parents, stable assignments. The category reuse directive in buildAnalysisPrompt is reinforced.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update article style prompt with no-title-duplication and heading rules</name>
  <files>src/lib/ai/prompts.ts</files>
  <action>
**1. Update DEFAULT_ARTICLE_STYLE_PROMPT in src/lib/ai/prompts.ts:**

Add these rules to the "### Output Rules" section:

```
### Content Structure Rules
- NEVER start the article with the article title as a heading. The title is already displayed separately above the content. The first line of content should be either an introductory paragraph or the first section heading — never a repetition of the title.
- Use H1 (#) for top-level section headings within the article (e.g., "# Overview", "# How It Works", "# Permissions")
- Use H2 (##) for sub-sections within an H1 section
- Use H3 (###) for sub-sub-sections within an H2 section
- Never skip heading levels (no H1 followed directly by H3)
- Every article should have at least one H1 section heading
```

**2. Update buildGenerationPrompt in src/lib/ai/prompts.ts:**

Add the no-title-duplication rule to the generation prompt as well, since this is where individual article content is generated:

After the "Generate the full article content in Markdown following the style guidelines above." line, add:

```
IMPORTANT: Do NOT start the article content with the article title as a heading. The title "${articlePlan.title}" is displayed separately. Begin with an introductory paragraph or the first section heading (using H1 #).
```
  </action>
  <verify>
Read src/lib/ai/prompts.ts and confirm: the Content Structure Rules section exists in DEFAULT_ARTICLE_STYLE_PROMPT with no-title-duplication rule and heading hierarchy rules. Confirm buildGenerationPrompt includes the no-title-duplication instruction. Run `npx tsc --noEmit` to verify no syntax errors.
  </verify>
  <done>
Article style prompt includes explicit rules: no title duplication, H1 for top-level sections, H2 for sub-sections, no skipped heading levels. Generation prompt also includes no-title-duplication instruction with the specific article title interpolated.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. DEFAULT_ANALYSIS_PROMPT contains "### Category Strategy" section with 6 numbered rules
3. DEFAULT_ARTICLE_STYLE_PROMPT contains "### Content Structure Rules" section
4. No-title-duplication rule present in both style prompt and generation prompt
5. Category reuse directive in buildAnalysisPrompt is reinforced
6. Heading hierarchy rules specify H1 for sections, H2 for sub-sections
7. Existing data analysis was performed before writing prompt changes
</verification>

<success_criteria>
The AI analysis prompt includes a deterministic 6-rule category strategy that eliminates run-to-run drift in category creation. The article style prompt prevents title duplication and enforces a clear heading hierarchy (H1 > H2 > H3). The generation prompt reinforces these rules. Changes are informed by analysis of existing data patterns.
</success_criteria>

<output>
After completion, create `.planning/phases/08-ai-prompt-refinement/08-01-SUMMARY.md`
</output>
