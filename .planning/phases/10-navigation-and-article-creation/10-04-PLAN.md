---
phase: 10-navigation-and-article-creation
plan: 04
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/components/wiki/sidebar-context-menu.tsx
  - src/components/wiki/category-tree.tsx
  - src/components/wiki/app-sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Categories show a hover '+' icon that opens a DropdownMenu with Add Subcategory, Add Article, Rename, Delete"
    - "Subcategories show a hover icon with DropdownMenu: Add Article, Rename, Delete"
    - "Articles show a hover icon with DropdownMenu: Rename, Delete, Move to..."
    - "Context menus are only visible to admin users"
    - "Delete is blocked with a toast error if category/subcategory contains articles"
    - "Rename opens an inline edit input or small dialog"
    - "Move to... opens a category picker dialog"
    - "Add Article creates an article directly in the category/subcategory and navigates to editor"
    - "Add Subcategory creates a subcategory via inline input and refreshes sidebar"
  artifacts:
    - path: "src/components/wiki/sidebar-context-menu.tsx"
      provides: "Hover-triggered DropdownMenu components for category, subcategory, and article items"
      exports: ["CategoryContextMenu", "SubcategoryContextMenu", "ArticleContextMenu"]
    - path: "src/components/wiki/category-tree.tsx"
      provides: "Updated CategoryNode with context menus integrated"
      contains: "CategoryContextMenu"
  key_links:
    - from: "src/components/wiki/sidebar-context-menu.tsx"
      to: "src/lib/wiki/category-actions.ts"
      via: "createCategory, renameCategory, deleteCategory server actions"
      pattern: "createCategory|renameCategory|deleteCategory"
    - from: "src/components/wiki/sidebar-context-menu.tsx"
      to: "src/lib/wiki/article-actions.ts"
      via: "createArticle, renameArticle, deleteArticle, moveArticle server actions"
      pattern: "createArticle|renameArticle|deleteArticle|moveArticle"
    - from: "src/components/wiki/category-tree.tsx"
      to: "src/components/wiki/sidebar-context-menu.tsx"
      via: "React component import"
      pattern: "CategoryContextMenu|ArticleContextMenu"
---

<objective>
Add hover-triggered context menus to all sidebar items (categories, subcategories, articles) for inline management actions.

Purpose: Admins need to manage the wiki structure directly from the sidebar -- rename, delete, add subcategories/articles, and move articles between categories. Hover-triggered menus keep the sidebar clean while making management actions one click away.
Output: sidebar-context-menu.tsx with three menu variants, updated category-tree.tsx integrating them
</objective>

<execution_context>
@/Users/michael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-navigation-and-article-creation/10-CONTEXT.md
@.planning/phases/10-navigation-and-article-creation/10-RESEARCH.md
@.planning/phases/10-navigation-and-article-creation/10-01-SUMMARY.md
@src/components/wiki/category-tree.tsx
@src/components/wiki/app-sidebar.tsx
@src/components/ui/dropdown-menu.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build sidebar context menu components</name>
  <files>src/components/wiki/sidebar-context-menu.tsx</files>
  <action>
Create `src/components/wiki/sidebar-context-menu.tsx` as a "use client" component. This file exports three components that wrap hover-triggered DropdownMenu patterns.

**Shared patterns across all three menus:**
- The trigger is a small button (size-6 or similar) with a Plus or MoreHorizontal icon (use Plus for categories/subcategories per user decision, MoreHorizontal/Ellipsis for articles since articles don't have an "add" action)
- Trigger has: `className="opacity-0 group-hover/item:opacity-100 transition-opacity"` — only visible on hover of the parent item
- The parent item wrapper uses `className="group/item"` for scoped hover
- All actions call server actions and then `router.refresh()` to sync sidebar
- Use `toast.success()` and `toast.error()` from sonner for feedback

**CategoryContextMenu({ category, isAdmin }: { category: { id: string; name: string; slug: string }; isAdmin: boolean }):**
- If !isAdmin, return null
- DropdownMenu items:
  1. "Add Subcategory" (FolderPlus icon) — opens a small Dialog or popover with a name input. On submit, calls `createCategory({ name, parentCategoryId: category.id })`. On success, toast + router.refresh()
  2. "Add Article" (FilePlus icon) — opens a small Dialog with a title input. On submit, calls `createArticle({ title, categoryId: category.id })`. On success, toast + router.push(`/wiki/${slug}/edit`)
  3. Separator
  4. "Rename" (Pencil icon) — opens a Dialog with name input prefilled with current name. On submit, calls `renameCategory({ id: category.id, name })`. On success, toast + router.refresh()
  5. "Delete" (Trash2 icon, destructive variant) — calls `deleteCategory({ id: category.id })`. If error (contains articles), show toast.error with the message. On success, toast + router.refresh(). No confirmation dialog needed since the server blocks deletion if articles exist.

**SubcategoryContextMenu({ subcategory, isAdmin }: { subcategory: { id: string; name: string; slug: string }; isAdmin: boolean }):**
- If !isAdmin, return null
- DropdownMenu items:
  1. "Add Article" (FilePlus icon) — same pattern as category but categoryId is subcategory.id
  2. Separator
  3. "Rename" (Pencil icon) — same as category rename but for subcategory
  4. "Delete" (Trash2 icon, destructive) — calls `deleteCategory({ id: subcategory.id })`

**ArticleContextMenu({ article, categories, isAdmin }: { article: { id: string; title: string; slug: string }; categories: CategoryWithArticles[]; isAdmin: boolean }):**
- If !isAdmin, return null
- Trigger icon: Ellipsis (MoreHorizontal) instead of Plus
- DropdownMenu items:
  1. "Rename" (Pencil icon) — Dialog with title input prefilled. Calls `renameArticle({ id: article.id, title })`
  2. "Move to..." (FolderInput or ArrowRightLeft icon) — Opens a Dialog with a category picker (flat list of all categories and subcategories). Uses a simple Select component. On submit, calls `moveArticle({ id: article.id, categoryId: selectedCategoryId })`. Toast + router.refresh()
  3. Separator
  4. "Delete" (Trash2 icon, destructive) — Calls `deleteArticle({ id: article.id })`. Show a confirmation dialog first (AlertDialog) since article deletion is destructive and non-recoverable. On confirm, execute delete, toast + router.refresh()

**Implementation detail for inline dialogs:** Each menu item that opens a dialog manages its own open state. Use pattern: the DropdownMenuItem has `onSelect={(e) => { e.preventDefault(); setRenameOpen(true); }}` to prevent the menu from closing, then render a Dialog controlled by renameOpen state. Alternatively, render the dialogs outside the DropdownMenu and just toggle their state from the menu items.

Imports: DropdownMenu/DropdownMenuContent/DropdownMenuItem/DropdownMenuSeparator/DropdownMenuTrigger from @/components/ui/dropdown-menu, Dialog/DialogContent/DialogHeader/DialogTitle from @/components/ui/dialog, AlertDialog/AlertDialogAction/AlertDialogCancel/AlertDialogContent/AlertDialogDescription/AlertDialogFooter/AlertDialogHeader/AlertDialogTitle from @/components/ui/alert-dialog, Select/SelectContent/SelectItem/SelectTrigger/SelectValue from @/components/ui/select, Button from @/components/ui/button, Input from @/components/ui/input, Label from @/components/ui/label, Plus/Ellipsis/FolderPlus/FilePlus/Pencil/Trash2/ArrowRightLeft from lucide-react, toast from sonner, useRouter from next/navigation, server actions from category-actions and article-actions, CategoryWithArticles from queries.
  </action>
  <verify>`npx tsc --noEmit` passes. Grep for three exported components: CategoryContextMenu, SubcategoryContextMenu, ArticleContextMenu. Grep for server action imports (createCategory, renameCategory, deleteCategory, createArticle, renameArticle, deleteArticle, moveArticle).</verify>
  <done>Three context menu components exported, each with appropriate actions (add, rename, delete, move) wired to server actions with toast feedback and router.refresh().</done>
</task>

<task type="auto">
  <name>Task 2: Integrate context menus into category tree</name>
  <files>src/components/wiki/category-tree.tsx, src/components/wiki/app-sidebar.tsx</files>
  <action>
**category-tree.tsx:** Update the CategoryTree and CategoryNode components to include context menus.

Add `isAdmin` and `allCategories` props to both components:
```typescript
interface CategoryTreeProps {
  categories: CategoryWithArticles[];
  isAdmin: boolean;
}
```

**CategoryNode updates:**
1. Wrap the SidebarMenuButton in a `group/item` div for hover detection
2. After the SidebarMenuButton (category name + chevron), render `<CategoryContextMenu category={category} isAdmin={isAdmin} />` — this appears as a hover-visible '+' icon to the right
3. For articles within the category: wrap each SidebarMenuSubItem in a `group/item` div and add `<ArticleContextMenu article={article} categories={allCategories} isAdmin={isAdmin} />`
4. For child categories (subcategories): when rendering recursively, determine whether the child is a subcategory (it has a parentCategoryId). Pass `isAdmin` and `allCategories` through. The context menu for subcategories uses SubcategoryContextMenu instead of CategoryContextMenu

The structural change for each item:
```tsx
// Before:
<SidebarMenuButton className="font-medium">
  <FolderOpen /> <span>{category.name}</span> <ChevronRight />
</SidebarMenuButton>

// After:
<div className="group/item flex items-center">
  <CollapsibleTrigger asChild>
    <SidebarMenuButton className="font-medium flex-1">
      <FolderOpen /> <span>{category.name}</span> <ChevronRight />
    </SidebarMenuButton>
  </CollapsibleTrigger>
  <CategoryContextMenu category={category} isAdmin={isAdmin} />
</div>
```

Similarly for articles:
```tsx
<div className="group/item flex items-center">
  <SidebarMenuSubButton asChild isActive={isActive} className="flex-1">
    <Link href={`/wiki/${article.slug}`}>
      <FileText /> <span>{article.title}</span>
    </Link>
  </SidebarMenuSubButton>
  <ArticleContextMenu article={article} categories={allCategories} isAdmin={isAdmin} />
</div>
```

Note: The CollapsibleTrigger wrapping needs to be adjusted. Currently the entire SidebarMenuButton is the CollapsibleTrigger. With context menus, the trigger should only be the button area, not the context menu icon. Move CollapsibleTrigger to wrap only the SidebarMenuButton, keeping the context menu outside.

**app-sidebar.tsx:** Pass `isAdmin` prop from the parent. Update AppSidebarProps:
```typescript
interface AppSidebarProps {
  categories: CategoryWithArticles[];
  isAdmin: boolean;
}
```
Pass `isAdmin` to `<CategoryTree categories={categories} isAdmin={isAdmin} />`.

**layout.tsx:** Already has `user.role` available. Pass `isAdmin={user.role === "admin"}` to `<AppSidebar categories={categoryTree} isAdmin={user.role === "admin"} />`.

Import CategoryContextMenu, SubcategoryContextMenu, ArticleContextMenu in category-tree.tsx.
  </action>
  <verify>`npx tsc --noEmit` passes. Grep category-tree.tsx for "CategoryContextMenu", "SubcategoryContextMenu", "ArticleContextMenu". Grep app-sidebar.tsx for "isAdmin". Grep layout.tsx for "isAdmin".</verify>
  <done>Category tree renders context menus on hover for all item types. Admin users see management actions; non-admins see a clean sidebar with no menu icons. Layout passes isAdmin through AppSidebar to CategoryTree.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- CategoryContextMenu has: Add Subcategory, Add Article, Rename, Delete
- SubcategoryContextMenu has: Add Article, Rename, Delete
- ArticleContextMenu has: Rename, Delete (with confirmation), Move to...
- All menus check isAdmin and return null for non-admins
- Context menus are opacity-0 by default, visible on parent hover
- Category tree passes isAdmin from layout through app-sidebar
</verification>

<success_criteria>
Admin users can hover over any sidebar item to reveal a management menu. Categories offer subcategory/article creation plus rename/delete. Subcategories offer article creation plus rename/delete. Articles offer rename, delete (with confirmation), and move to another category. All actions persist via server actions with toast feedback. Non-admins see no management controls.
</success_criteria>

<output>
After completion, create `.planning/phases/10-navigation-and-article-creation/10-04-SUMMARY.md`
</output>
