---
phase: 10-navigation-and-article-creation
plan: 03
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/app/(wiki)/layout.tsx
  - src/components/wiki/create-article-modal.tsx
  - src/components/wiki/search-input.tsx
autonomous: true

must_haves:
  truths:
    - "Search bar is centered in the header and wider than before (max-w-xl or similar)"
    - "Admin sees a primary-styled Create button to the right of the search bar"
    - "Non-admin users do not see the Create button at all"
    - "Clicking Create opens a modal with title input, category dropdown, and dynamic subcategory dropdown"
    - "Category dropdown includes '+ New Category' option at the bottom"
    - "Subcategory dropdown appears only when selected category has subcategories, includes '+ New Subcategory' option"
    - "After creating an article, user is navigated to the article editor (/wiki/[slug]/edit)"
    - "Inline category creation works within the modal (creates category without closing modal)"
  artifacts:
    - path: "src/app/(wiki)/layout.tsx"
      provides: "Redesigned header with centered search and create button"
      contains: "CreateArticleModal"
    - path: "src/components/wiki/create-article-modal.tsx"
      provides: "Modal dialog with title + cascading category/subcategory picker"
      exports: ["CreateArticleModal"]
    - path: "src/components/wiki/search-input.tsx"
      provides: "Same search input, no width constraint (parent controls width)"
  key_links:
    - from: "src/components/wiki/create-article-modal.tsx"
      to: "src/lib/wiki/article-actions.ts"
      via: "createArticle server action"
      pattern: "createArticle"
    - from: "src/components/wiki/create-article-modal.tsx"
      to: "src/lib/wiki/category-actions.ts"
      via: "createCategory server action for inline creation"
      pattern: "createCategory"
    - from: "src/app/(wiki)/layout.tsx"
      to: "src/components/wiki/create-article-modal.tsx"
      via: "React component import"
      pattern: "CreateArticleModal"
---

<objective>
Redesign the header layout with centered wider search bar and admin-only Create Article button, plus build the create article modal with cascading category/subcategory picker.

Purpose: This is the primary article creation workflow -- admins need to manually create articles from any page. The header redesign makes search more prominent and adds the create action in a discoverable location.
Output: Redesigned header, CreateArticleModal component
</objective>

<execution_context>
@/Users/michael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-navigation-and-article-creation/10-CONTEXT.md
@.planning/phases/10-navigation-and-article-creation/10-RESEARCH.md
@.planning/phases/10-navigation-and-article-creation/10-01-SUMMARY.md
@src/app/(wiki)/layout.tsx
@src/components/wiki/search-input.tsx
@src/lib/wiki/queries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Redesign header layout with centered search and create button</name>
  <files>src/app/(wiki)/layout.tsx, src/components/wiki/search-input.tsx</files>
  <action>
**layout.tsx header redesign:** Restructure the header into three sections using flexbox:

```
Left section:   AskAiGlobalTrigger (flex items-center gap-2)
Center section: SearchInput in a wider container (flex-1 flex justify-center, inner div w-full max-w-xl)
Right section:  [Create button for admin] + Help + AdminSettings + UserMenu (flex items-center gap-2)
```

The current header has search in `ml-auto` right section with `w-64`. Change to:
1. Remove the `ml-auto` wrapper. Make AskAiGlobalTrigger the left section
2. Center section: `<div className="flex-1 flex justify-center"><div className="w-full max-w-xl">` wrapping the Suspense/SearchInput
3. Right section: conditionally render `<CreateArticleModal categories={categoryTree} />` for admins (before the Help link), then Help, AdminSettings, UserMenu

Pass `categoryTree` (already fetched in the layout) and `user.role` to the CreateArticleModal. The modal component handles the button + dialog internally.

**search-input.tsx:** No functional changes needed. The parent container in layout.tsx now controls the width. Remove any hardcoded width constraints if present (currently there are none in the component itself -- the `w-64` is in layout.tsx).

Import `CreateArticleModal` from `@/components/wiki/create-article-modal` in layout.tsx. Since it's a client component used in a server component, this works via standard Next.js patterns (server renders the client component boundary).
  </action>
  <verify>Run `npx tsc --noEmit` to verify imports resolve. Visually verify the header structure by reading the JSX.</verify>
  <done>Header has three-section layout: left (Ask AI), center (wide search), right (Create + Help + Admin + User). Create button only rendered when user.role === "admin".</done>
</task>

<task type="auto">
  <name>Task 2: Build create article modal with cascading category/subcategory picker</name>
  <files>src/components/wiki/create-article-modal.tsx</files>
  <action>
Create `src/components/wiki/create-article-modal.tsx` as a "use client" component.

**Props:**
```typescript
interface CreateArticleModalProps {
  categories: CategoryWithArticles[]; // Full tree from layout
}
```

**Component structure:**
1. **Trigger button:** Primary styled button (filled, colored) with Plus icon and "Create" text. Uses shadcn Button with `variant="default"` (which is the primary/filled variant).

2. **Dialog (from shadcn):** Opens on button click. Contains:
   - DialogHeader with title "Create Article"
   - Form with:
     a. **Title input:** Required text input, placeholder "Article title"
     b. **Category select:** Using shadcn Select component. Options are all root categories (where parentCategoryId is null) from the categories prop. At the bottom, add a separator and a "+" button/item labeled "New Category" that, when clicked, shows an inline text input to type a new category name and a "Create" mini-button. On create, call `createCategory` server action, then add the new category to local state and select it.
     c. **Subcategory select:** Only visible when the selected category has children (subcategories). Uses shadcn Select. Options are subcategories of the selected category. First option is "None (direct in category)" with value "none". At bottom, "New Subcategory" inline creation (same pattern as category). When category changes, reset subcategory to null.
     d. **Create button:** Primary button, disabled while submitting. On click:
        - Call `createArticle({ title, categoryId, subcategoryId })` server action
        - If success (returns `{ slug }`), close dialog, call `router.push(\`/wiki/\${slug}/edit\`)` to navigate to the editor
        - If error, show toast via sonner
        - Call `router.refresh()` to refresh sidebar data

3. **State management:** Use React useState for: open (dialog), title, categoryId, subcategoryId, isCreating (loading), showNewCategory (inline create mode), newCategoryName, showNewSubcategory, newSubcategoryName. Use a local `categoriesState` that starts from props but can be augmented when inline creation adds new ones.

4. **Inline category creation flow:**
   - User clicks "+ New Category" in the Select dropdown
   - A small inline form appears (inside the SelectContent or below the Select) with a text input and "Create" button
   - On create: call `createCategory({ name })`, add to local state, select the new category, hide inline form
   - Use `router.refresh()` after creation to sync sidebar

5. **Inline subcategory creation flow:**
   - Same pattern but calls `createCategory({ name, parentCategoryId: selectedCategoryId })`

**Important implementation notes:**
- The shadcn Select component uses Radix Select primitives. The "New Category" action needs to prevent the Select from closing when clicked. One approach: use a separate button outside the SelectContent that toggles an inline input below the Select, rather than trying to put interactive elements inside SelectContent (which closes on item selection).
- After article creation, navigate to `/wiki/${slug}/edit` -- this is the existing edit page route.
- Use `toast.success("Article created")` and `toast.error(result.error)` from sonner.

Import: Dialog/DialogContent/DialogHeader/DialogTitle/DialogTrigger from @/components/ui/dialog, Select/SelectContent/SelectItem/SelectTrigger/SelectValue from @/components/ui/select, Button from @/components/ui/button, Input from @/components/ui/input, Label from @/components/ui/label, Plus from lucide-react, toast from sonner, useRouter from next/navigation, createArticle from @/lib/wiki/article-actions, createCategory from @/lib/wiki/category-actions, CategoryWithArticles from @/lib/wiki/queries.
  </action>
  <verify>`npx tsc --noEmit` passes. Grep for "createArticle" and "createCategory" calls in the component. Grep for `router.push` with `/edit` path. Grep for "use client" at top.</verify>
  <done>CreateArticleModal renders a primary Create button (admin-only via parent), opens a Dialog with title input, cascading category/subcategory Selects with inline creation, creates article via server action, and navigates to editor on success.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- Header has centered search (max-w-xl wrapper) and Create button for admins
- CreateArticleModal imports and calls createArticle + createCategory server actions
- Modal has title, category, conditional subcategory fields
- After creation, navigates to /wiki/[slug]/edit
- Non-admin users see no Create button (conditional rendering in layout.tsx)
</verification>

<success_criteria>
Admins see a "Create" button in the header that opens a modal. The modal lets them enter a title, pick/create a category, optionally pick/create a subcategory, and submit. On success, they are taken directly to the article editor. Non-admins see only the wider centered search bar and existing controls.
</success_criteria>

<output>
After completion, create `.planning/phases/10-navigation-and-article-creation/10-03-SUMMARY.md`
</output>
