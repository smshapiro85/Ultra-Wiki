---
phase: 10-navigation-and-article-creation
plan: 05
type: execute
wave: 3
depends_on: ["10-01", "10-04"]
files_modified:
  - src/components/wiki/sortable-sidebar.tsx
  - src/components/wiki/sortable-item.tsx
  - src/components/wiki/app-sidebar.tsx
  - src/components/wiki/category-tree.tsx
autonomous: false

must_haves:
  truths:
    - "Admin can drag categories to reorder them"
    - "Admin can drag subcategories between categories"
    - "Admin can drag articles between categories, subcategories, and reorder within"
    - "Drag handles (GripVertical icon) appear on hover for admin users only"
    - "A blue drop indicator line shows where the item will land during drag"
    - "Drop is auto-saved immediately via reorderSidebarItems server action"
    - "Dragging a subcategory into another subcategory is prevented (max depth 2)"
    - "Non-admin users see the normal sidebar with no drag handles"
    - "Collapsible expand/collapse still works without accidentally triggering drag"
  artifacts:
    - path: "src/components/wiki/sortable-sidebar.tsx"
      provides: "DndContext + SortableContext wrapper with flatten-then-reorder logic"
      exports: ["SortableSidebar"]
    - path: "src/components/wiki/sortable-item.tsx"
      provides: "Individual draggable sidebar item with GripVertical handle"
      exports: ["SortableItem"]
    - path: "src/components/wiki/app-sidebar.tsx"
      provides: "Updated sidebar using SortableSidebar for admin, CategoryTree for non-admin"
      contains: "SortableSidebar"
  key_links:
    - from: "src/components/wiki/sortable-sidebar.tsx"
      to: "src/lib/wiki/category-actions.ts"
      via: "reorderSidebarItems server action"
      pattern: "reorderSidebarItems"
    - from: "src/components/wiki/sortable-sidebar.tsx"
      to: "@dnd-kit/core"
      via: "DndContext, DragOverlay"
      pattern: "DndContext"
    - from: "src/components/wiki/sortable-item.tsx"
      to: "@dnd-kit/sortable"
      via: "useSortable hook"
      pattern: "useSortable"
---

<objective>
Build the drag-and-drop sidebar that allows admins to reorder and reparent categories, subcategories, and articles with immediate persistence.

Purpose: This is the most complex UI feature in Phase 10. It turns the static sidebar tree into a fully manageable, drag-and-drop interface where admins can reorganize the entire wiki structure by dragging items.
Output: SortableSidebar and SortableItem components, integrated into the app sidebar for admin users
</objective>

<execution_context>
@/Users/michael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-navigation-and-article-creation/10-CONTEXT.md
@.planning/phases/10-navigation-and-article-creation/10-RESEARCH.md
@.planning/phases/10-navigation-and-article-creation/10-01-SUMMARY.md
@.planning/phases/10-navigation-and-article-creation/10-04-SUMMARY.md
@src/components/wiki/category-tree.tsx
@src/components/wiki/app-sidebar.tsx
@src/lib/wiki/queries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build sortable sidebar wrapper and sortable item components</name>
  <files>src/components/wiki/sortable-sidebar.tsx, src/components/wiki/sortable-item.tsx</files>
  <action>
**sortable-sidebar.tsx** — "use client" component. This is the DnD wrapper that implements the flatten-then-reorder pattern.

**Props:**
```typescript
interface SortableSidebarProps {
  categories: CategoryWithArticles[];
  isAdmin: boolean;
}
```

**FlattenedItem type:**
```typescript
interface FlattenedItem {
  id: string;
  parentId: string | null;
  depth: number;        // 0 = category, 1 = subcategory or article under category, 2 = article under subcategory
  type: 'category' | 'subcategory' | 'article';
  name: string;
  slug: string;
  collapsed: boolean;
  sortOrder: number;
}
```

**Core logic:**

1. **flattenTree(categories):** Convert the hierarchical CategoryWithArticles[] into FlattenedItem[]. Iterate categories (depth 0), then for each category: its direct articles (depth 1, type 'article'), then its children/subcategories (depth 1, type 'subcategory'), then each subcategory's articles (depth 2, type 'article'). Sort children by sortOrder at each level. The flat array preserves visual order.

2. **State:** `items` (FlattenedItem[]), `collapsedIds` (Set<string>), `activeId` (string | null for drag overlay). Initialize items from flattenTree(categories). Use useEffect to re-flatten when categories prop changes.

3. **Visible items:** Filter `items` to exclude children of collapsed parents. This is the array passed to SortableContext.

4. **DndContext setup:**
   - `sensors`: useSensors with PointerSensor (activationConstraint: { distance: 8 }) and KeyboardSensor. The distance: 8 prevents accidental drags when clicking to expand/collapse.
   - `collisionDetection`: closestCenter
   - `onDragStart`: set activeId
   - `onDragOver`: handle hover state for drop indicators. Calculate projected depth based on cursor position. **Depth enforcement:** If the active item is a category being dragged over a subcategory, reject (categories can only be at depth 0). If the active item is a subcategory being dragged over another subcategory's child, reject (max depth 2). If an article is being dragged, allow anywhere depth 1-2.
   - `onDragEnd`: Compute new parentId and sortOrder for the moved item. Calculate affected siblings (all items sharing the new parent). Build the updates array: `{ id, type, parentId, sortOrder }[]` for all affected items. Optimistically update local state, then call `reorderSidebarItems(updates)`. If server action fails, revert to previous state and show toast.error. On success, call `router.refresh()`.
   - `onDragCancel`: reset activeId

5. **DragOverlay:** Renders a visual copy of the dragged item (just the name with an icon, styled with a slight shadow/elevation).

6. **Drop indicator:** Use the dnd-kit `measuring` config and custom modifier to show a blue horizontal line between items at the drop target position. This can be achieved by styling the SortableItem's `transform` and adding a `::before` pseudo-element on the item being hovered over, or using the DragOverlay approach.

7. **Rendering:** Map over visible items, render `<SortableItem>` for each. Pass item data, isAdmin, collapsed state, onToggleCollapse callback, and the context menu component (CategoryContextMenu, SubcategoryContextMenu, or ArticleContextMenu based on item.type).

**sortable-item.tsx** — "use client" component.

**Props:**
```typescript
interface SortableItemProps {
  item: FlattenedItem;
  isAdmin: boolean;
  isCollapsed: boolean;
  onToggleCollapse?: () => void;
  contextMenu?: React.ReactNode;
  isDragOverlay?: boolean;
}
```

**Implementation:**
1. Use `useSortable({ id: item.id, data: { type: item.type, depth: item.depth, parentId: item.parentId } })` from @dnd-kit/sortable
2. Apply `transform` and `transition` from useSortable to the wrapper div via CSS.Transform.toString() from @dnd-kit/utilities
3. The wrapper div has: `style={{ paddingLeft: item.depth * 16 }}` for indentation, `ref` from useSortable
4. Inside the wrapper:
   - **Drag handle:** GripVertical icon, only visible on hover for admins: `className="opacity-0 group-hover/sortable:opacity-100 cursor-grab"`. Attach `{...attributes, ...listeners}` from useSortable to this element specifically (NOT the whole item — this prevents drag from conflicting with collapse/click)
   - **Collapse chevron:** For category and subcategory types, ChevronRight icon that rotates 90deg when expanded. onClick calls onToggleCollapse. NOT part of the drag handle.
   - **Icon:** FolderOpen for categories/subcategories, FileText for articles
   - **Name/link:** For articles, wrap in Link to `/wiki/${item.slug}`. For categories, just text.
   - **Context menu:** Render the contextMenu prop if provided
5. The entire item wrapper: `className="group/sortable flex items-center h-8 text-sm"` with appropriate sidebar styling to match existing category-tree look.
6. Active state: when being dragged (isDragging from useSortable), reduce opacity to 0.4.
7. Drop indicator: When this item has the `isOver` and `isBefore`/`isAfter` state, render a 2px blue line on the appropriate edge.

**Important implementation notes:**
- The drag handle (`{...listeners, ...attributes}`) must be on a SEPARATE element from the collapse trigger. Otherwise clicking to expand/collapse triggers drag.
- Use `activationConstraint: { distance: 8 }` on the PointerSensor as a safety net.
- For the blue drop indicator line: use a CSS approach where the item being dragged over gets a `border-top: 2px solid blue` or `border-bottom: 2px solid blue` depending on the drop position (before vs after).

Imports for sortable-sidebar.tsx: DndContext, DragOverlay, closestCenter, PointerSensor, KeyboardSensor, useSensors, useSensor from @dnd-kit/core; SortableContext, verticalListSortingStrategy from @dnd-kit/sortable; arrayMove from @dnd-kit/sortable; CategoryWithArticles from queries; reorderSidebarItems from category-actions; useRouter from next/navigation; toast from sonner; CategoryContextMenu, SubcategoryContextMenu, ArticleContextMenu from sidebar-context-menu.

Imports for sortable-item.tsx: useSortable from @dnd-kit/sortable; CSS from @dnd-kit/utilities; GripVertical, ChevronRight, FolderOpen, FileText from lucide-react; Link from next/link; usePathname from next/navigation.
  </action>
  <verify>`npx tsc --noEmit` passes. Grep sortable-sidebar.tsx for "DndContext" and "reorderSidebarItems" and "flattenTree". Grep sortable-item.tsx for "useSortable" and "GripVertical".</verify>
  <done>SortableSidebar implements flatten-then-reorder with DndContext, depth enforcement, optimistic updates with revert, and blue drop indicator. SortableItem renders individual draggable items with separate drag handle, collapse toggle, and context menu.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate SortableSidebar into app-sidebar with admin/non-admin branching</name>
  <files>src/components/wiki/app-sidebar.tsx, src/components/wiki/category-tree.tsx</files>
  <action>
**app-sidebar.tsx:** Update to conditionally render SortableSidebar for admins and CategoryTree for non-admins.

```typescript
interface AppSidebarProps {
  categories: CategoryWithArticles[];
  isAdmin: boolean;
}

export function AppSidebar({ categories, isAdmin }: AppSidebarProps) {
  return (
    <Sidebar collapsible="icon">
      <SidebarHeader>...</SidebarHeader>
      <SidebarContent>
        <SidebarGroup>
          <SidebarGroupLabel>Navigation</SidebarGroupLabel>
          <SidebarGroupContent>
            {isAdmin ? (
              <SortableSidebar categories={categories} isAdmin={isAdmin} />
            ) : (
              <CategoryTree categories={categories} isAdmin={false} />
            )}
          </SidebarGroupContent>
        </SidebarGroup>
        <SidebarToc />
      </SidebarContent>
    </Sidebar>
  );
}
```

Import SortableSidebar from `@/components/wiki/sortable-sidebar`.

**category-tree.tsx:** This component remains as the non-admin sidebar view (already updated in Plan 04 with context menu integration, but since isAdmin will be false for non-admins, the context menus will return null). No further changes needed beyond what Plan 04 already does, but ensure the component still works standalone when isAdmin is false.

**layout.tsx:** Already updated in Plan 03/04 to pass isAdmin. Verify it passes `isAdmin={user.role === "admin"}` to AppSidebar.
  </action>
  <verify>`npx tsc --noEmit` passes. Grep app-sidebar.tsx for "SortableSidebar" and "isAdmin". Run `npm run build` to verify the full build succeeds with all new components.</verify>
  <done>Admin users get the full DnD-enabled SortableSidebar with drag handles, reordering, and reparenting. Non-admin users get the static CategoryTree. Both share the same data from layout.tsx.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete Phase 10 functionality</name>
  <files>n/a</files>
  <action>
Human verification of the complete Phase 10 implementation:
1. Server actions for all sidebar management (create/rename/delete categories, articles, reorder)
2. AI pipeline updated with subcategory awareness (schema, prompts, pipeline code)
3. Redesigned header with centered wider search bar and admin-only Create Article button
4. Create Article modal with cascading category/subcategory picker and inline creation
5. Hover-triggered context menus on all sidebar items (categories, subcategories, articles)
6. Full drag-and-drop sidebar with flatten-then-reorder pattern, depth enforcement, and auto-save
  </action>
  <verify>
1. Start the dev server: `npm run dev`
2. Log in as an admin user
3. Header check: Search bar should be centered and wider. "Create" button should be visible to the right of search.
4. Create Article: Click Create, enter a title, select a category, click Create. Verify you land on the article editor page. Check the sidebar shows the new article.
5. Context menus: Hover over a category in the sidebar. A small '+' icon should appear. Click it and verify the dropdown has: Add Subcategory, Add Article, Rename, Delete. Try renaming a category. Try adding a subcategory.
6. Article context menu: Hover over an article in the sidebar. An ellipsis icon should appear. Click it and verify: Rename, Delete, Move to... options.
7. Drag and drop: As admin, hover over a sidebar item. A grip handle should appear on the left. Drag an article from one category to another. Verify it persists after page refresh. Drag a category to reorder. Verify the order persists.
8. Depth enforcement: Try dragging a subcategory into another subcategory. It should not be allowed (the drop should be rejected or the item snaps back).
9. Non-admin check: Log in as a non-admin. Verify: no Create button in header, no context menus on hover, no drag handles.
10. Delete guard: Try deleting a category that has articles via context menu. Should show an error toast.
  </verify>
  <done>All Phase 10 features verified: header redesign, article creation modal, sidebar context menus, drag-and-drop reordering, depth enforcement, admin/non-admin separation, and AI pipeline subcategory awareness.</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- Admin sidebar has drag-and-drop enabled with GripVertical handles on hover
- Non-admin sidebar is static (no drag handles, no context menus)
- Dragging items persists order via reorderSidebarItems server action
- Depth enforcement prevents subcategory nesting beyond 2 levels
- Blue drop indicator line appears during drag
- Expand/collapse still works without triggering drag (separate elements)
</verification>

<success_criteria>
The sidebar is fully manageable by admins: drag to reorder/reparent, hover menus for all CRUD actions, depth-limited to 2 levels. Non-admins see a clean, static sidebar. All changes auto-persist. The header shows a centered wider search bar and admin-only Create button leading to a functional article creation modal.
</success_criteria>

<output>
After completion, create `.planning/phases/10-navigation-and-article-creation/10-05-SUMMARY.md`
</output>
