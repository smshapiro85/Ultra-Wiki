---
phase: 10-navigation-and-article-creation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/wiki/category-actions.ts
  - src/lib/wiki/article-actions.ts
  - src/components/ui/select.tsx
  - package.json
autonomous: true

must_haves:
  truths:
    - "Server actions exist for creating, renaming, and deleting categories and subcategories"
    - "Server actions exist for creating, renaming, deleting, and moving articles"
    - "Reorder server action accepts batch updates for categories and articles with new parentId and sortOrder"
    - "All management actions are admin-only (auth check)"
    - "Category/subcategory deletion is blocked if it still contains articles"
    - "Category depth is enforced at max 2 levels in create/move operations"
    - "@dnd-kit packages are installed and available"
  artifacts:
    - path: "src/lib/wiki/category-actions.ts"
      provides: "Server actions for category CRUD and reorder"
      exports: ["createCategory", "renameCategory", "deleteCategory", "reorderSidebarItems"]
    - path: "src/lib/wiki/article-actions.ts"
      provides: "Server actions for article CRUD and move"
      exports: ["createArticle", "renameArticle", "deleteArticle", "moveArticle"]
    - path: "src/components/ui/select.tsx"
      provides: "shadcn Select component for create modal dropdowns"
  key_links:
    - from: "src/lib/wiki/category-actions.ts"
      to: "src/lib/db/schema.ts"
      via: "drizzle categories table"
      pattern: "categories"
    - from: "src/lib/wiki/article-actions.ts"
      to: "src/lib/db/schema.ts"
      via: "drizzle articles table"
      pattern: "articles"
---

<objective>
Install dependencies and create all server actions needed for sidebar management, article creation, and drag-and-drop reordering.

Purpose: Every UI feature in Phase 10 (context menus, create modal, drag-and-drop) calls server actions. Building them first ensures the UI plans can focus purely on components.
Output: category-actions.ts, article-actions.ts, shadcn Select component, @dnd-kit packages installed
</objective>

<execution_context>
@/Users/michael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-navigation-and-article-creation/10-CONTEXT.md
@.planning/phases/10-navigation-and-article-creation/10-RESEARCH.md
@src/lib/db/schema.ts
@src/lib/wiki/actions.ts
@src/lib/ai/pipeline.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and add Select component</name>
  <files>package.json, src/components/ui/select.tsx</files>
  <action>
Run:
```
npm install @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities
npx shadcn@latest add select
```
Verify packages appear in package.json dependencies and select.tsx is generated in src/components/ui/.
  </action>
  <verify>`npm ls @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities` shows installed versions. `ls src/components/ui/select.tsx` exists.</verify>
  <done>@dnd-kit/core 6.x, @dnd-kit/sortable 10.x, @dnd-kit/utilities 3.x in package.json. Select component exists at src/components/ui/select.tsx.</done>
</task>

<task type="auto">
  <name>Task 2: Create category server actions</name>
  <files>src/lib/wiki/category-actions.ts</files>
  <action>
Create `src/lib/wiki/category-actions.ts` with "use server" directive. All actions check `auth()` and require `role === "admin"`, returning `{ error: string }` on failure.

**createCategory(data: { name: string; parentCategoryId?: string | null }):**
- Validate name is non-empty, trimmed, 1-100 chars
- If parentCategoryId is provided, verify the parent exists AND the parent itself has no parentCategoryId (enforce max depth 2: parent must be a root category). If parent has a parent, return error "Maximum nesting depth is 2 levels"
- Generate slug via the same pattern as pipeline.ts: lowercase, replace non-alphanumeric with hyphens, trim hyphens, slice to 120
- Insert with `onConflictDoNothing()` on slug. If conflict, look up existing by slug
- `revalidatePath("/")`
- Return `{ id: string; slug: string }` or `{ error: string }`

**renameCategory(data: { id: string; name: string }):**
- Validate name non-empty, trimmed, 1-100 chars
- Update category name and regenerate slug
- Handle slug conflict: if new slug already taken by a different category, append -2, -3, etc.
- `revalidatePath("/")`
- Return `{ success: true }` or `{ error: string }`

**deleteCategory(data: { id: string }):**
- Check if category has ANY articles directly assigned to it (`articles.categoryId === id`)
- Check if category has ANY child categories (`categories.parentCategoryId === id`) that themselves have articles
- If either check finds articles, return `{ error: "Cannot delete: category contains articles. Move articles out first." }`
- If child categories exist but are empty, delete children first, then delete the category
- `revalidatePath("/")`
- Return `{ success: true }` or `{ error: string }`

**reorderSidebarItems(updates: Array<{ id: string; type: 'category' | 'article'; parentId: string | null; sortOrder: number }>):**
- Validate each update: for category type with a parentId, verify the target parent has no parentCategoryId itself (depth enforcement)
- Batch update: for type 'category', update `categories` table setting `sortOrder` and `parentCategoryId`. For type 'article', update `articles` table setting `sortOrder` and `categoryId`
- `revalidatePath("/")`
- Return `{ success: true }` or `{ error: string }`

Import `auth` from `@/lib/auth`, `getDb` from `@/lib/db`, `categories` and `articles` from `@/lib/db/schema`, `eq` from `drizzle-orm`, `revalidatePath` from `next/cache`.
  </action>
  <verify>`npx tsc --noEmit` passes with no errors in category-actions.ts. Grep for "use server" at top of file. Grep for `auth()` in each exported function.</verify>
  <done>Four exported server actions (createCategory, renameCategory, deleteCategory, reorderSidebarItems) all with admin auth check, depth enforcement, and deletion guard.</done>
</task>

<task type="auto">
  <name>Task 3: Create article server actions</name>
  <files>src/lib/wiki/article-actions.ts</files>
  <action>
Create `src/lib/wiki/article-actions.ts` with "use server" directive. All actions check `auth()` and require `role === "admin"`.

**createArticle(data: { title: string; categoryId: string; subcategoryId?: string | null }):**
- Validate title non-empty, trimmed, 1-200 chars
- Determine effectiveCategoryId: use subcategoryId if provided, otherwise categoryId
- Generate slug: lowercase title, replace non-alphanumeric with hyphens, trim, slice to 120
- Ensure unique slug: check articles table, append -2, -3, etc. if exists (same pattern as pipeline.ts `ensureUniqueSlug`)
- Insert article with: title, slug, contentMarkdown: "", contentJson: null, categoryId: effectiveCategoryId, hasHumanEdits: false, needsReview: false
- Create initial version via `createArticleVersion` from `@/lib/content/version` with changeSource "human_edited", changeSummary "Article created manually", createdBy: session.user.id
- `revalidatePath("/")`
- Return `{ slug: string }` or `{ error: string }`

**renameArticle(data: { id: string; title: string }):**
- Validate title non-empty, trimmed, 1-200 chars
- Update article title. Do NOT change slug (URLs should be stable)
- `revalidatePath("/")`
- Return `{ success: true }` or `{ error: string }`

**deleteArticle(data: { id: string }):**
- Delete related records first to avoid FK violations: articleFileLinks, articleDbTables, articleVersions, userBookmarks, aiReviewAnnotations, comments, mentions (where articleId or via comment). Use cascading delete pattern from schema or manual delete
- Delete the article itself
- `revalidatePath("/")`
- Return `{ success: true }` or `{ error: string }`

**moveArticle(data: { id: string; categoryId: string }):**
- Verify target category exists
- Update article's categoryId to the new category
- `revalidatePath("/")`
- Return `{ success: true }` or `{ error: string }`

Import from `@/lib/auth`, `@/lib/db`, `@/lib/db/schema` (articles, articleVersions, articleFileLinks, articleDbTables, userBookmarks, aiReviewAnnotations, comments, mentions), `drizzle-orm` (eq), `next/cache` (revalidatePath), `@/lib/content/version` (createArticleVersion).
  </action>
  <verify>`npx tsc --noEmit` passes with no errors in article-actions.ts. Grep for "use server" at top. Grep for `auth()` in each exported function.</verify>
  <done>Four exported server actions (createArticle, renameArticle, deleteArticle, moveArticle) all with admin auth check. createArticle generates unique slug and creates initial version. deleteArticle cleans up all related records.</done>
</task>

</tasks>

<verification>
- `npm ls @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities` shows all three packages
- `ls src/components/ui/select.tsx` exists
- `npx tsc --noEmit` passes
- Both server action files have "use server" directive
- All 8 exported functions include `auth()` admin check
</verification>

<success_criteria>
All dependencies installed, Select UI component exists, 8 server actions created and type-checking. No runtime testing needed -- these are consumed by UI plans.
</success_criteria>

<output>
After completion, create `.planning/phases/10-navigation-and-article-creation/10-01-SUMMARY.md`
</output>
