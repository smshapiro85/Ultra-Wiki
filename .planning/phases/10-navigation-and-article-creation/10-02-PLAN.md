---
phase: 10-navigation-and-article-creation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/ai/schemas.ts
  - src/lib/ai/prompts.ts
  - src/lib/ai/pipeline.ts
  - src/lib/ai/analyze.ts
  - src/lib/ai/plan.ts
autonomous: true

must_haves:
  truths:
    - "AI analysis schema accepts subcategory_suggestion field on each article plan"
    - "Analysis prompt includes explicit subcategory rules (when to create, naming, depth limit)"
    - "Category tree in prompt context shows subcategory hierarchy (Category > Subcategory notation)"
    - "resolveOrCreateCategory handles optional subcategory parameter and creates subcategories under parents"
    - "Planning prompt includes subcategory awareness for group planning"
  artifacts:
    - path: "src/lib/ai/schemas.ts"
      provides: "Updated articlePlanSchema with subcategory_suggestion"
      contains: "subcategory_suggestion"
    - path: "src/lib/ai/prompts.ts"
      provides: "Updated analysis prompt with subcategory rules 7 and 8"
      contains: "subcategory"
    - path: "src/lib/ai/pipeline.ts"
      provides: "Updated resolveOrCreateCategory with subcategory support"
      contains: "subcategorySuggestion"
    - path: "src/lib/ai/analyze.ts"
      provides: "Updated getFullCategoryTree with depth info"
      contains: "parentCategoryId"
    - path: "src/lib/ai/plan.ts"
      provides: "Updated buildPlanningPrompt with subcategory awareness"
      contains: "subcategor"
  key_links:
    - from: "src/lib/ai/pipeline.ts"
      to: "src/lib/ai/schemas.ts"
      via: "ArticlePlan type with subcategory_suggestion"
      pattern: "subcategory_suggestion"
    - from: "src/lib/ai/pipeline.ts"
      to: "src/lib/db/schema.ts"
      via: "categories table with parentCategoryId"
      pattern: "parentCategoryId"
---

<objective>
Update the AI pipeline to understand and generate subcategories during article analysis and creation.

Purpose: The AI pipeline must be subcategory-aware so that automated article generation can place articles into subcategories and create new subcategories when appropriate. This is independent of UI work and can run in parallel with Plan 01.
Output: Updated schemas, prompts, pipeline, analyze, and plan modules with subcategory support
</objective>

<execution_context>
@/Users/michael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-navigation-and-article-creation/10-CONTEXT.md
@.planning/phases/10-navigation-and-article-creation/10-RESEARCH.md
@src/lib/ai/schemas.ts
@src/lib/ai/prompts.ts
@src/lib/ai/pipeline.ts
@src/lib/ai/analyze.ts
@src/lib/ai/plan.ts
@src/lib/db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update AI schemas and prompts for subcategory awareness</name>
  <files>src/lib/ai/schemas.ts, src/lib/ai/prompts.ts</files>
  <action>
**schemas.ts:** Add `subcategory_suggestion` field to `articlePlanSchema`:
```typescript
subcategory_suggestion: z.string().nullable().describe(
  "Slug of the suggested subcategory within the category, or null if article should be directly in the category. Only suggest subcategories when the category has 8+ articles covering distinct sub-topics."
),
```
Place it immediately after the existing `category_suggestion` field.

**prompts.ts — DEFAULT_ANALYSIS_PROMPT:** Add two new rules to the "Category Strategy" section, after Rule 6:

```
**Rule 7: Subcategory creation.** Only create subcategories when a category has 8+ articles covering distinct sub-topics. Subcategories group related articles within a category. Maximum depth is 2 levels (Category > Subcategory). Never create a subcategory with fewer than 3 articles planned for it. When suggesting a subcategory, set `subcategory_suggestion` to the subcategory slug.

**Rule 8: Subcategory naming.** Subcategory names should be short topic labels (e.g., "Authentication", "Settings", "Permissions"), NOT full phrases. They describe a sub-topic within the parent category. Match the naming style of existing subcategories if any exist.
```

Also update Rule 4 from "Flat over nested" to acknowledge that subcategories are now supported but should be used sparingly:
```
**Rule 4: Flat over nested.** Prefer articles directly in categories unless the category has grown large (8+ articles) with clearly distinct sub-topics. Subcategories are supported (max depth 2) but should not be created speculatively.
```

**prompts.ts — buildAnalysisPrompt:** Update the category tree rendering to show subcategory hierarchy more clearly. Change the category tree format from:
```
- ParentName > ChildName (slug: child-slug)
```
to include depth indicators:
```
- CategoryName (slug: cat-slug)
  - SubcategoryName (slug: sub-slug) [subcategory of CategoryName]
```
This means iterating existingCategories, rendering root categories first, then indenting children under their parents.

**prompts.ts — buildPlanningPrompt (in plan.ts, but referenced here):** This is handled in Task 2.

**prompts.ts — buildGenerationPrompt:** No changes needed (generation doesn't handle category placement).
  </action>
  <verify>`npx tsc --noEmit` passes. Grep schemas.ts for "subcategory_suggestion". Grep prompts.ts for "Rule 7" and "Rule 8".</verify>
  <done>articlePlanSchema includes subcategory_suggestion (string | null). Analysis prompt includes Rules 7-8 for subcategory creation/naming. Category tree in prompt shows hierarchical indentation.</done>
</task>

<task type="auto">
  <name>Task 2: Update pipeline, analyze, and plan modules for subcategory handling</name>
  <files>src/lib/ai/pipeline.ts, src/lib/ai/analyze.ts, src/lib/ai/plan.ts</files>
  <action>
**pipeline.ts — resolveOrCreateCategory:** Extend the function signature to accept an optional `subcategorySuggestion` parameter:
```typescript
async function resolveOrCreateCategory(
  categorySuggestion: string,
  categoryTree: Array<{ id: string; name: string; slug: string; parentCategoryId?: string | null }>,
  subcategorySuggestion?: string | null
): Promise<string | null>
```

Logic:
1. First resolve the parent category using existing logic (match by slug, then name, then create)
2. If no subcategorySuggestion or it's null, return the parent category ID (existing behavior)
3. If subcategorySuggestion is provided:
   a. Look through categoryTree for a category whose slug matches subcategorySuggestion AND whose parentCategoryId matches the resolved parent
   b. If found, return that subcategory's ID
   c. If not found, create the subcategory: generate slug, capitalize name, insert with `parentCategoryId` set to the parent's ID, use `onConflictDoNothing()`
   d. Push new subcategory into categoryTree cache
   e. Return the subcategory's ID

Update the categoryTree type to include `parentCategoryId` in the array items (it's already returned by `getFullCategoryTree` in analyze.ts but the pipeline type didn't include it).

**pipeline.ts — processCreateArticle and processUpdateArticle:** Update the `articlePlan` parameter type to include `subcategory_suggestion?: string | null`. Pass it through to `resolveOrCreateCategory`:
```typescript
const categoryId = await resolveOrCreateCategory(
  articlePlan.category_suggestion,
  categoryTree,
  articlePlan.subcategory_suggestion
);
```

**analyze.ts — getFullCategoryTree:** Already returns parentCategoryId info via parentName. Also add `parentCategoryId` to the return type so pipeline.ts can use it for subcategory matching:
```typescript
export async function getFullCategoryTree(): Promise<
  Array<{ id: string; name: string; slug: string; parentName?: string; parentCategoryId?: string | null }>
>
```
Update the return statement to include `parentCategoryId: c.parentCategoryId`.

**plan.ts — buildPlanningPrompt:** Add a note about subcategories to the grouping rules:
```
9. **Subcategory awareness.** If the existing category tree shows subcategories (indented under a parent), propose articles into the appropriate subcategory when it fits. Do not create new subcategories in the planning stage — that decision is made during analysis.
```

Also update the category tree rendering in buildPlanningPrompt to show the hierarchical format (same indentation approach as buildAnalysisPrompt).
  </action>
  <verify>`npx tsc --noEmit` passes. Grep pipeline.ts for "subcategorySuggestion". Grep analyze.ts for "parentCategoryId" in the return type. Grep plan.ts for "Subcategory awareness".</verify>
  <done>resolveOrCreateCategory handles subcategory creation. processCreateArticle and processUpdateArticle pass subcategory_suggestion through. getFullCategoryTree returns parentCategoryId. Planning prompt includes subcategory awareness rule.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors
- `subcategory_suggestion` field exists in articlePlanSchema
- Analysis prompt contains Rules 7 and 8 about subcategories
- resolveOrCreateCategory accepts and handles subcategorySuggestion parameter
- Category tree rendering in prompts shows hierarchical indentation
</verification>

<success_criteria>
AI pipeline is fully subcategory-aware: schema accepts subcategory suggestions, prompts instruct the LLM when and how to use subcategories, and the pipeline code creates subcategories in the database when suggested. Existing behavior (no subcategory) is preserved as the default path.
</success_criteria>

<output>
After completion, create `.planning/phases/10-navigation-and-article-creation/10-02-SUMMARY.md`
</output>
