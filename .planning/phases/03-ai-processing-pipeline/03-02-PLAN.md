---
phase: 03-ai-processing-pipeline
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/merge/three-way.ts
  - src/lib/merge/diff.ts
  - src/lib/merge/conflict.ts
  - src/lib/content/markdown.ts
  - src/lib/content/version.ts
  - src/app/api/articles/[id]/dismiss-review/route.ts
autonomous: true

must_haves:
  truths:
    - "Three-way merge preserves human edits when AI updates an article"
    - "Conflicts between human edits and code changes are detected deterministically"
    - "When conflict is detected, the human-edited version is kept as article content"
    - "AI's proposed changes are stored in version history with change_source ai_merged"
    - "needs_review flag is set on the article when conflicts are detected"
    - "User can dismiss the review banner via an API endpoint"
    - "BlockNote JSON converts to Markdown for AI processing and back for storage"
    - "Unified diffs are generated for version history display"
  artifacts:
    - path: "src/lib/merge/three-way.ts"
      provides: "Three-way merge using node-diff3 with conflict detection"
      exports: ["mergeArticleContent", "MergeResult"]
    - path: "src/lib/merge/diff.ts"
      provides: "Unified diff generation for version history"
      exports: ["generateUnifiedDiff"]
    - path: "src/lib/merge/conflict.ts"
      provides: "Conflict resolution logic: keep human version, store AI version, set flags"
      exports: ["resolveConflict", "ConflictResolution"]
    - path: "src/lib/content/markdown.ts"
      provides: "BlockNote JSON <-> Markdown server-side conversion"
      exports: ["blocksToMarkdown", "markdownToBlocks"]
    - path: "src/lib/content/version.ts"
      provides: "Article version creation and tracking helpers"
      exports: ["createArticleVersion", "getLastAIVersion"]
    - path: "src/app/api/articles/[id]/dismiss-review/route.ts"
      provides: "POST endpoint to clear needs_review flag on an article"
      exports: ["POST"]
  key_links:
    - from: "src/lib/merge/three-way.ts"
      to: "node-diff3"
      via: "import { merge } from node-diff3"
      pattern: "merge.*node-diff3"
    - from: "src/lib/merge/conflict.ts"
      to: "src/lib/content/version.ts"
      via: "createArticleVersion to store AI's proposed content"
      pattern: "createArticleVersion"
    - from: "src/lib/content/version.ts"
      to: "src/lib/db/schema.ts"
      via: "insert into articleVersions table"
      pattern: "articleVersions"
    - from: "src/lib/content/markdown.ts"
      to: "@blocknote/server-util"
      via: "ServerBlockNoteEditor for conversion"
      pattern: "ServerBlockNoteEditor|blocksToMarkdownLossy|tryParseMarkdownToBlocks"
---

<objective>
Build the three-way merge engine, conflict resolution logic, BlockNote conversion utilities, version tracking, and the review banner dismissal endpoint.

Purpose: This is the merge strategy -- the critical differentiator. When AI updates a human-edited article, this module deterministically merges the changes, preserves human edits, detects conflicts, and provides a mechanism to dismiss the review banner.

Output: Three merge library files, two content utility files, and one API route.
</objective>

<execution_context>
@/Users/michael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ai-processing-pipeline/03-RESEARCH.md
@src/lib/db/schema.ts
@src/lib/db/index.ts
@docs/ultrawiki-spec.md (section 7: AI + Human Content Coexistence)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Three-way merge, diff generation, and BlockNote conversion</name>
  <files>src/lib/merge/three-way.ts, src/lib/merge/diff.ts, src/lib/content/markdown.ts</files>
  <action>
Install dependencies: `npm install node-diff3 diff @blocknote/server-util` and type packages if available (`npm install -D @types/diff` -- node-diff3 has built-in types).

**src/lib/merge/three-way.ts** -- Three-way merge:
- Import `{ merge }` from `node-diff3`.
- Export interface `MergeResult { mergedMarkdown: string; hasConflicts: boolean; conflictCount: number }`.
- Export `mergeArticleContent(base: string, current: string, incoming: string): MergeResult`:
  - `base` = last AI-generated version (common ancestor)
  - `current` = current article content including human edits ("ours")
  - `incoming` = new AI-generated content ("theirs")
  - Split each on `\n` for line-based merge.
  - Call `merge(current.split("\n"), base.split("\n"), incoming.split("\n"), { excludeFalseConflicts: true })`.
  - Note parameter order: node-diff3 `merge(a, o, b)` where a=ours, o=original, b=theirs.
  - Count conflict markers (`<<<<<<< a`, `=======`, `>>>>>>> b`) to derive conflictCount.
  - Return `{ mergedMarkdown: result.result.join("\n"), hasConflicts: result.conflict, conflictCount }`.

**src/lib/merge/diff.ts** -- Unified diff generation:
- Import `{ createPatch }` from `diff`.
- Export `generateUnifiedDiff(oldContent: string, newContent: string, label: string): string`:
  - Return `createPatch(label, oldContent, newContent, "previous version", "current version", { context: 3 })`.
  - This is stored in article versions for quick diff display in the History tab.

**src/lib/content/markdown.ts** -- BlockNote JSON <-> Markdown:
- Import `{ ServerBlockNoteEditor }` from `@blocknote/server-util`.
- Create a lazy singleton: `let editorInstance: ... | null = null` with `async function getServerEditor()`.
- Export `blocksToMarkdown(blocksJson: unknown): Promise<string>`:
  - Cast blocksJson to Block[] and call `editor.blocksToMarkdownLossy(blocks)`.
  - This is a LOSSY conversion -- acceptable for AI processing and diffs.
- Export `markdownToBlocks(markdown: string): Promise<unknown[]>`:
  - Call `editor.tryParseMarkdownToBlocks(markdown)`.
  - Returns BlockNote JSON blocks for storage in contentJson column.
- Note: @blocknote/server-util may need `@blocknote/core` as a peer dependency. If install complains, add it: `npm install @blocknote/core @blocknote/server-util`.
  </action>
  <verify>
`npx tsc --noEmit` passes. `mergeArticleContent("a\nb", "a\nb\nc", "a\nd")` returns a MergeResult with hasConflicts handling. `generateUnifiedDiff("old", "new", "test")` returns a unified diff string. `@blocknote/server-util` import resolves.
  </verify>
  <done>
Three-way merge produces deterministic results with conflict detection. Unified diffs can be generated for any two content strings. BlockNote conversion utilities can convert between JSON and Markdown.
  </done>
</task>

<task type="auto">
  <name>Task 2: Conflict resolution, version tracking, and review banner dismissal</name>
  <files>src/lib/merge/conflict.ts, src/lib/content/version.ts, src/app/api/articles/[id]/dismiss-review/route.ts</files>
  <action>
**src/lib/content/version.ts** -- Version tracking helpers:
- Import schema tables (`articles`, `articleVersions`, `changeSourceEnum`) from `@/lib/db/schema` and `getDb` from `@/lib/db`.
- Export `createArticleVersion(params: { articleId: string; contentMarkdown: string; contentJson?: unknown; technicalViewMarkdown?: string; changeSource: "ai_generated" | "ai_updated" | "human_edited" | "ai_merged"; changeSummary?: string; createdBy?: string }): Promise<string>`:
  - Insert into `articleVersions` table with all provided fields. Return the new version ID.
- Export `getLastAIVersion(articleId: string): Promise<{ contentMarkdown: string; contentJson?: unknown } | null>`:
  - Query `articleVersions` where `articleId` matches and `changeSource` is `ai_generated` or `ai_updated`, ordered by `createdAt DESC`, limit 1.
  - Return the content fields, or null if no AI version exists (first AI generation for this article).

**src/lib/merge/conflict.ts** -- Conflict resolution:
- Import `MergeResult` from `./three-way`, `createArticleVersion` from `@/lib/content/version`, `getDb` from `@/lib/db`, `articles` from `@/lib/db/schema`, `eq` from `drizzle-orm`.
- Export interface `ConflictResolution { finalMarkdown: string; changeSource: "ai_updated" | "ai_merged"; needsReview: boolean; conflictCount: number }`.
- Export `resolveConflict(params: { articleId: string; mergeResult: MergeResult; currentMarkdown: string; aiProposedMarkdown: string; changeSummary: string }): Promise<ConflictResolution>`:
  - If `mergeResult.hasConflicts`:
    - Keep the CURRENT (human-edited) version as the article content (`finalMarkdown = currentMarkdown`).
    - Store the AI's proposed full content as a version record with `changeSource: "ai_merged"` and changeSummary noting the conflict.
    - Set `needsReview = true` on the article via DB update (`articles.needsReview = true`).
    - Return `{ finalMarkdown: currentMarkdown, changeSource: "ai_merged", needsReview: true, conflictCount: mergeResult.conflictCount }`.
  - If no conflicts:
    - Use the merged content (`mergeResult.mergedMarkdown`) as the article content.
    - Return `{ finalMarkdown: mergeResult.mergedMarkdown, changeSource: "ai_merged", needsReview: false, conflictCount: 0 }`.
  - This follows the research recommendation: "Do NOT store conflict markers in article content."

**src/app/api/articles/[id]/dismiss-review/route.ts** -- Review banner dismissal (AIPL-08):
- Export `POST(request, { params })` handler:
  - Authenticate via `auth()` from `@/lib/auth` -- any logged-in user can dismiss (per spec: "Any user can dismiss the banner after reviewing").
  - Extract `id` from route params.
  - Update `articles` table: set `needsReview = false` where `id` matches.
  - Return 200 `{ success: true }` on success, 401 if not authenticated, 404 if article not found.
  - Use the same auth pattern as existing API routes (check `session?.user`).
  </action>
  <verify>
`npx tsc --noEmit` passes. The dismiss-review route file exists at the correct Next.js dynamic route path. `createArticleVersion` correctly inserts into the articleVersions table. `resolveConflict` returns the right shape based on conflict detection.
  </verify>
  <done>
Conflict resolution keeps human content when conflicts exist and stores AI proposals in version history. Version tracking creates proper article_versions records with correct change_source values. The dismiss-review API endpoint allows any authenticated user to clear the needs_review flag.
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- All 6 files exist: 3 in `src/lib/merge/`, 2 in `src/lib/content/`, 1 API route
- `mergeArticleContent()` uses node-diff3 (not AI-based merge)
- `resolveConflict()` keeps human version on conflict, stores AI version in history
- `createArticleVersion()` inserts into articleVersions with correct changeSource enum values
- `getLastAIVersion()` queries for most recent ai_generated or ai_updated version
- `blocksToMarkdown()` and `markdownToBlocks()` use @blocknote/server-util
- POST /api/articles/[id]/dismiss-review requires auth and updates needsReview to false
</verification>

<success_criteria>
The merge strategy is complete: three-way merge on Markdown, deterministic conflict detection, human-first conflict resolution (keep human edits, store AI proposals), version tracking for all changes, BlockNote conversion at boundaries, and a working API endpoint for dismissing the review banner.
</success_criteria>

<output>
After completion, create `.planning/phases/03-ai-processing-pipeline/03-02-SUMMARY.md`
</output>
