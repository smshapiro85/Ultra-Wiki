---
phase: 07-ask-ai-notifications
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/app/api/chat/article/route.ts
  - src/components/chat/context-indicator.tsx
  - src/components/chat/ask-ai-page-trigger.tsx
  - src/app/(wiki)/wiki/[articleSlug]/page.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can open a page-level Ask AI scoped to the current article"
    - "Page-level AI receives article content, technical view, file links, and DB tables as context"
    - "Context indicator shows what context was used for each response"
    - "Page-level conversations are persisted separately per article per user"
  artifacts:
    - path: "src/app/api/chat/article/route.ts"
      provides: "POST streaming endpoint for page-level Ask AI with article context"
      exports: ["POST"]
    - path: "src/components/chat/context-indicator.tsx"
      provides: "Shows what context was assembled for the AI"
      exports: ["ContextIndicator"]
    - path: "src/components/chat/ask-ai-page-trigger.tsx"
      provides: "Article page button that opens page-scoped Ask AI panel"
      exports: ["AskAiPageTrigger"]
  key_links:
    - from: "src/components/chat/ask-ai-page-trigger.tsx"
      to: "src/components/chat/ask-ai-panel.tsx"
      via: "renders AskAiPanel with endpoint=/api/chat/article and articleId"
      pattern: "AskAiPanel.*endpoint.*chat/article"
    - from: "src/app/api/chat/article/route.ts"
      to: "getArticleBySlug, getArticleFileLinks, getArticleDbTables"
      via: "context assembly from wiki queries"
      pattern: "getArticleFileLinks|getArticleDbTables"
    - from: "src/app/(wiki)/wiki/[articleSlug]/page.tsx"
      to: "src/components/chat/ask-ai-page-trigger.tsx"
      via: "rendered in article action buttons"
      pattern: "AskAiPageTrigger"
---

<objective>
Build the page-level Ask AI with rich article context assembly and context indicator.

Purpose: Users can ask AI questions scoped to the current article, with the AI receiving the article content, technical view, source files, and DB tables as context.
Output: Page-level streaming API route, context indicator component, page trigger button on article pages.
</objective>

<execution_context>
@/Users/michael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-ask-ai-notifications/07-RESEARCH.md
@.planning/phases/07-ask-ai-notifications/07-01-SUMMARY.md
@src/lib/db/schema.ts
@src/lib/ai/client.ts
@src/lib/wiki/queries.ts
@src/app/(wiki)/wiki/[articleSlug]/page.tsx
@src/components/chat/ask-ai-panel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Page-level chat API route with article context assembly</name>
  <files>
    src/app/api/chat/article/route.ts
  </files>
  <action>
Create `src/app/api/chat/article/route.ts` with POST handler:

**Auth:** Session required (return 401 if not authenticated).

**Body parsing:** `{ conversationId: string, message: UIMessage, articleId: string }`

**Context assembly** (the core of this task). Build a `buildArticleContext` async function:
1. Fetch in parallel using Promise.all:
   - Article data: query `articles` table by `articleId` -- get `title`, `contentMarkdown`, `technicalViewMarkdown`
   - File links: `getArticleFileLinks(articleId)` from `src/lib/wiki/queries.ts` -- returns file paths with AI summaries
   - DB tables: `getArticleDbTables(articleId)` from `src/lib/wiki/queries.ts` -- returns table names with relevance

2. Assemble context string:
```
## Article: {title}

{contentMarkdown}

## Technical View
{technicalViewMarkdown or "No technical view content."}

## Related Source Files
- {filePath}: {aiSummary or "No summary"}
...

## Related Database Tables
- {tableName}: {relevanceExplanation or ""}
...
```

3. Return both the context string AND a summary of what was included (for the context indicator):
```typescript
interface ContextInfo {
  articleTitle: string;
  hasArticleContent: boolean;
  hasTechnicalView: boolean;
  fileCount: number;
  tableCount: number;
}
```

**Streaming:** Same pattern as global chat route (from Plan 01):
- Load prior messages from `ai_conversation_messages`
- Load system prompt from `getSetting(SETTING_KEYS.ask_ai_page_prompt)` -- default: "You are a helpful assistant for CodeWiki. Answer questions about the article and its related source code. Use the provided context to give accurate, specific answers."
- Build context using `buildArticleContext(articleId)`
- `streamText({ model, system: systemPrompt + '\n\n' + contextText, messages: await convertToModelMessages(allMessages), abortSignal: req.signal })`
- `result.consumeStream()`
- Return `result.toUIMessageStreamResponse({ onFinish })` -- persist messages same as global route
- Include `contextInfo` in a custom response header `X-Context-Info` as JSON string, so the client can display it.

**Truncation safety:** If assembled context exceeds 32000 characters, truncate `contentMarkdown` and `technicalViewMarkdown` to fit. Log a warning. File summaries and DB tables are small -- no truncation needed.
  </action>
  <verify>
- `npm run build` succeeds
- Route file exists at `src/app/api/chat/article/route.ts`
- POST returns streaming response with article context (test with curl after auth)
  </verify>
  <done>
- POST /api/chat/article accepts articleId, assembles rich context from article + technical view + files + tables, streams AI response
- Context info returned via header for client-side context indicator
- Messages persisted to ai_conversation_messages on stream completion
  </done>
</task>

<task type="auto">
  <name>Task 2: Context indicator, page trigger, and article page integration</name>
  <files>
    src/components/chat/context-indicator.tsx
    src/components/chat/ask-ai-page-trigger.tsx
    src/app/(wiki)/wiki/[articleSlug]/page.tsx
  </files>
  <action>
**Step 1: Create `src/components/chat/context-indicator.tsx`**
"use client" component. Props:
```typescript
interface ContextIndicatorProps {
  articleTitle: string;
  hasArticleContent: boolean;
  hasTechnicalView: boolean;
  fileCount: number;
  tableCount: number;
}
```
Render a small info bar showing what context was included. Use a compact layout:
- Icon: `Info` from lucide-react
- Text like: "Context: Article content, Technical view, 5 source files, 3 DB tables"
- Use muted foreground color, small text (`text-xs text-muted-foreground`)
- Only show items that exist (e.g., skip "Technical view" if `hasTechnicalView` is false)
- Wrap in a rounded border div with subtle background

**Step 2: Create `src/components/chat/ask-ai-page-trigger.tsx`**
"use client" component. Props: `{ articleId: string, articleTitle: string }`.
- State: `open` boolean for the panel
- State: `contextInfo` (ContextIndicatorProps | null) -- populated when the panel opens or when context header is received
- Renders a `Button` with `Sparkles` icon + "Ask AI about this article" text (or just "Ask AI" with `variant="outline" size="sm"`)
- Renders `<AskAiPanel>` with:
  - `endpoint="/api/chat/article"`
  - `articleId={articleId}`
  - `title={`Ask AI: ${articleTitle}`}`
  - `contextIndicator={contextInfo ? <ContextIndicator {...contextInfo} /> : null}`
- For the context indicator, the AskAiPanel needs to support receiving context info. Two approaches:
  - (A) Fetch context info separately on panel open: `GET /api/chat/article/context?articleId=X` -- adds another route
  - (B) The ask-ai-panel component passes contextIndicator as a static prop and the page trigger computes it
  - (C) Simplest: When panel opens, make a quick fetch to get context info. Use a simple endpoint or compute client-side from article data.

**Chosen approach:** The page trigger passes the context indicator as a prop to AskAiPanel. The context info is known statically from the article page data. The article page passes `articleTitle`, `hasTechnicalView` (boolean from article), and counts for files and tables. To get file/table counts without an extra fetch, accept them as props from the article page.

Updated props: `{ articleId: string, articleTitle: string, hasTechnicalView: boolean, fileCount: number, tableCount: number }`

Build the `ContextIndicator` inline within AskAiPanel using these props. The `contextIndicator` prop on AskAiPanel receives the `<ContextIndicator>` JSX.

**Step 3: Update `src/app/(wiki)/wiki/[articleSlug]/page.tsx`**
- Import `AskAiPageTrigger` from `@/components/chat/ask-ai-page-trigger`
- Import `getArticleFileLinks`, `getArticleDbTables` from `@/lib/wiki/queries` (may already be used by TechnicalView -- check if counts are available or need separate queries)
- Fetch file link count and DB table count. Since `getArticleFileLinks` and `getArticleDbTables` return arrays, just call `.length`. Add these to the existing `Promise.all` on the page:
  ```typescript
  const [bookmarked, annotationCount, fileLinks, dbTables] = await Promise.all([
    ...existing...,
    getArticleFileLinks(article.id),
    getArticleDbTables(article.id),
  ]);
  ```
- Add `<AskAiPageTrigger>` in the action buttons area (next to Edit and Regenerate buttons):
  ```tsx
  <AskAiPageTrigger
    articleId={article.id}
    articleTitle={article.title}
    hasTechnicalView={!!article.technicalViewMarkdown}
    fileCount={fileLinks.length}
    tableCount={dbTables.length}
  />
  ```
  </action>
  <verify>
- `npm run build` succeeds
- Visit an article page -- "Ask AI" button appears next to Edit button
- Click it -- slide-out panel opens with article title and context indicator
- Context indicator shows relevant items (e.g., "Article content, 3 source files, 2 DB tables")
- Send a question about the article -- AI responds with knowledge of the article content
- Conversation is persisted per article (different from global conversations)
  </verify>
  <done>
- Page-level Ask AI scoped to current article with full context assembly (ASKI-03)
- Context indicator showing what was used for each response (ASKI-07)
- Page-level conversations persisted separately per article per user (ASKI-05)
  </done>
</task>

</tasks>

<verification>
1. Visit an article page -- "Ask AI" button visible in action bar (ASKI-03)
2. Click "Ask AI" -- panel opens showing "Ask AI: {Article Title}" and context indicator
3. Context indicator shows article content + technical view (if exists) + file count + table count (ASKI-07)
4. Ask "What is this article about?" -- AI responds using article content
5. Ask about source files -- AI references linked files from context
6. Close and reopen -- conversation persisted for this specific article
7. Visit different article -- separate conversation space
8. Global Ask AI still works independently
</verification>

<success_criteria>
- Page-level Ask AI scoped to current article (ASKI-03)
- AI receives article content, technical view, source files, DB tables as context (ASKI-03)
- Context indicator shows what context was used (ASKI-07)
- Page-level conversations persisted per article per user (ASKI-05)
- Does not break global Ask AI from Plan 01
</success_criteria>

<output>
After completion, create `.planning/phases/07-ask-ai-notifications/07-02-SUMMARY.md`
</output>
