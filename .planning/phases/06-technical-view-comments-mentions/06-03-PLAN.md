---
phase: 06-technical-view-comments-mentions
plan: 03
type: execute
wave: 3
depends_on: ["06-01"]
files_modified:
  - src/lib/settings/constants.ts
  - src/lib/db/schema.ts
  - src/lib/db/seed.ts
  - src/lib/ai/client.ts
  - src/lib/ai/pipeline.ts
  - src/lib/ai/prompts.ts
  - src/lib/wiki/queries.ts
  - src/app/(admin)/admin/settings/actions.ts
  - src/app/(admin)/admin/settings/api-keys-settings.tsx
  - src/app/(admin)/admin/settings/ai-prompts-settings.tsx
  - src/components/wiki/file-link-card.tsx
  - src/components/wiki/technical-view.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can configure a separate summary model name in the API Keys settings tab"
    - "Admin can configure a file summary prompt in the AI Prompts settings tab"
    - "Each github_files row has an aiSummary text column storing AI-generated file descriptions"
    - "During sync, new or changed files get 1-2 sentence AI summaries generated via the summary model"
    - "Technical View file cards display the aiSummary text instead of only the relevance explanation"
    - "Summary model client is reusable for other short-summary needs"
  artifacts:
    - path: "src/lib/settings/constants.ts"
      provides: "openrouter_summary_model and file_summary_prompt setting keys"
      contains: "openrouter_summary_model"
    - path: "src/lib/db/schema.ts"
      provides: "aiSummary column on githubFiles table"
      contains: "aiSummary"
    - path: "src/lib/ai/client.ts"
      provides: "getSummaryModel function for short AI outputs"
      exports: ["getAIModel", "getSummaryModel"]
    - path: "src/lib/ai/pipeline.ts"
      provides: "generateFileSummaries function called during pipeline"
      contains: "generateFileSummaries"
    - path: "src/components/wiki/file-link-card.tsx"
      provides: "Renders aiSummary prop on file cards"
      contains: "aiSummary"
  key_links:
    - from: "src/lib/ai/pipeline.ts"
      to: "src/lib/ai/client.ts"
      via: "getSummaryModel() call"
      pattern: "getSummaryModel"
    - from: "src/lib/ai/pipeline.ts"
      to: "src/lib/db/schema.ts"
      via: "update githubFiles.aiSummary"
      pattern: "githubFiles.*aiSummary"
    - from: "src/components/wiki/technical-view.tsx"
      to: "src/lib/wiki/queries.ts"
      via: "getArticleFileLinks returns aiSummary"
      pattern: "aiSummary"
    - from: "src/components/wiki/file-link-card.tsx"
      to: "src/components/wiki/technical-view.tsx"
      via: "aiSummary prop passed to FileLinkCard"
      pattern: "aiSummary"
---

<objective>
Add AI-generated file summaries to the Technical View: a separate "summary model" setting for short AI outputs, a `file_summary_prompt` admin setting, an `aiSummary` column on `github_files`, automatic summary generation during sync for new/changed files, and display of summaries on Technical View file cards.

Purpose: File cards in Technical View currently only show the relevance explanation from the AI analysis (which is per-article, not per-file). Adding per-file AI summaries gives users a quick understanding of what each source file does, independent of which article it is linked to.

Output: Working summary model configuration, automatic summary generation during sync, and file card UI displaying summaries.
</objective>

<execution_context>
@/Users/michael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-technical-view-comments-mentions/06-01-SUMMARY.md

@src/lib/settings/constants.ts
@src/lib/db/schema.ts
@src/lib/db/seed.ts
@src/lib/ai/client.ts
@src/lib/ai/pipeline.ts
@src/lib/ai/prompts.ts
@src/lib/wiki/queries.ts
@src/app/(admin)/admin/settings/actions.ts
@src/app/(admin)/admin/settings/api-keys-settings.tsx
@src/app/(admin)/admin/settings/ai-prompts-settings.tsx
@src/components/wiki/file-link-card.tsx
@src/components/wiki/technical-view.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Summary model settings, schema column, AI client, and seed</name>
  <files>
    src/lib/settings/constants.ts
    src/lib/db/schema.ts
    src/lib/db/seed.ts
    src/lib/ai/client.ts
    src/app/(admin)/admin/settings/actions.ts
    src/app/(admin)/admin/settings/api-keys-settings.tsx
    src/app/(admin)/admin/settings/ai-prompts-settings.tsx
  </files>
  <action>
    **1. Add setting keys** in `src/lib/settings/constants.ts`:
    - Add `openrouter_summary_model: "openrouter_summary_model"` to SETTING_KEYS object (after `openrouter_reasoning_effort`).
    - Add `file_summary_prompt: "file_summary_prompt"` to SETTING_KEYS object (after `ask_ai_page_prompt`).

    **2. Add aiSummary column** to `githubFiles` table in `src/lib/db/schema.ts`:
    - Add `aiSummary: text("ai_summary")` column (nullable, no default) to the `githubFiles` pgTable definition, after the `contentHash` field.

    **3. Add seed entries** in `src/lib/db/seed.ts`:
    - Add `{ key: "openrouter_summary_model", description: "OpenRouter model for short summaries (file descriptions, etc.)", value: "", isSecret: false }` to `requiredSettings` array.
    - Add `{ key: "file_summary_prompt", description: "Prompt for generating short file descriptions", value: "", isSecret: false }` to `requiredSettings` array.

    **4. Add getSummaryModel** in `src/lib/ai/client.ts`:
    - Create and export `async function getSummaryModel()` following the same pattern as `getAIModel()`.
    - It reads `openrouter_api_key` (reuses the same API key as the primary model) and `openrouter_summary_model` from settings.
    - If `openrouter_summary_model` is not configured, throw an error: "Summary model not configured. Please set it in Admin > Settings > API Keys."
    - Create an OpenRouter provider with the same headers as `getAIModel()`.
    - Do NOT pass reasoning config -- summary model is for fast, short outputs.
    - Return `openrouter(summaryModelName)`.

    **5. Add summary model field** to admin API Keys UI in `src/app/(admin)/admin/settings/api-keys-settings.tsx`:
    - In the OpenRouter Card (after the Reasoning Effort select), add a new form field:
      - Label: "Summary Model" with htmlFor="openrouter_summary_model"
      - Input: text input, name="openrouter_summary_model", defaultValue from `settings.openrouter_summary_model?.value ?? ""`, placeholder="google/gemini-2.0-flash-001" (a fast, cheap model suitable for summaries)
      - Helper text (text-xs text-muted-foreground): "Fast model for short outputs like file summaries. Uses the same API key as the primary model."

    **6. Save summary model** in `src/app/(admin)/admin/settings/actions.ts`:
    - Add `{ key: SETTING_KEYS.openrouter_summary_model, field: "openrouter_summary_model" }` to the `fields` array in `saveApiKeys`.

    **7. Add file summary prompt field** to AI Prompts UI in `src/app/(admin)/admin/settings/ai-prompts-settings.tsx`:
    - After the Article Style Prompt textarea and before the Global Ask AI Prompt textarea, add:
      - Label: "File Summary Prompt" with htmlFor="file_summary_prompt"
      - Textarea: name="file_summary_prompt", rows=4, defaultValue from `settings.file_summary_prompt?.value ?? ""`, placeholder="Prompt for generating 1-2 sentence file descriptions..."
      - Helper text: "Controls how AI generates short descriptions for source files. Used in the Technical View file cards."

    **8. Save file summary prompt** in `src/app/(admin)/admin/settings/actions.ts`:
    - Add `{ key: SETTING_KEYS.file_summary_prompt, field: "file_summary_prompt" }` to the `fields` array in `saveAiPrompts`.

    **9. Run `npx drizzle-kit push`** to apply the schema change (aiSummary column) to the database. Then run `npx tsx src/lib/db/seed.ts` to seed the new setting keys.
  </action>
  <verify>
    - `npx tsc --noEmit` passes with no errors.
    - `npm run build` succeeds.
    - grep confirms `openrouter_summary_model` exists in constants.ts, seed.ts, client.ts, actions.ts, api-keys-settings.tsx.
    - grep confirms `file_summary_prompt` exists in constants.ts, seed.ts, actions.ts, ai-prompts-settings.tsx.
    - grep confirms `aiSummary` exists in schema.ts githubFiles definition.
    - grep confirms `getSummaryModel` is exported from client.ts.
  </verify>
  <done>
    Summary model and file summary prompt are configurable in admin settings. The githubFiles table has an aiSummary column. getSummaryModel() is available for reuse. All setting keys are seeded.
  </done>
</task>

<task type="auto">
  <name>Task 2: Pipeline integration and Technical View UI update</name>
  <files>
    src/lib/ai/prompts.ts
    src/lib/ai/pipeline.ts
    src/lib/wiki/queries.ts
    src/components/wiki/file-link-card.tsx
    src/components/wiki/technical-view.tsx
  </files>
  <action>
    **1. Add file summary prompt builder** in `src/lib/ai/prompts.ts`:
    - Add a `DEFAULT_FILE_SUMMARY_PROMPT` constant:
      ```
      Describe what this source file does in 1-2 concise sentences. Focus on its purpose and role in the application. Be specific about functionality, not generic descriptions.
      ```
    - Export a function `buildFileSummaryPrompt(filePath: string, fileContent: string, customPrompt: string): string` that returns:
      ```
      ${customPrompt || DEFAULT_FILE_SUMMARY_PROMPT}

      File: ${filePath}

      ```${inferredLang}
      ${fileContent}
      ```
      ```
      For the language inference, just extract the file extension and use it (e.g., `ts`, `tsx`, `py`). No need to import the shiki language helper -- just use `filePath.split('.').pop() ?? ''`.

    **2. Add generateFileSummaries** in `src/lib/ai/pipeline.ts`:
    - Import `getSummaryModel` from `@/lib/ai/client` (via dynamic import like the existing pipeline pattern to avoid build-time issues).
    - Import `generateText` from `ai` (already used by analyze.ts/generate.ts -- check if already imported, otherwise add).
    - Add `import { SETTING_KEYS } from "@/lib/settings/constants"` and `import { getSetting } from "@/lib/settings"` (getSetting already imported).
    - Create `async function generateFileSummaries(changedFilePaths: string[]): Promise<void>`:
      a. Early exit if `changedFilePaths` is empty.
      b. Try to get the summary model via dynamic import: `const { getSummaryModel } = await import("@/lib/ai/client")`. Call `const model = await getSummaryModel()`. If this throws (model not configured), log a warning and return silently -- summary generation is optional.
      c. Read the `file_summary_prompt` setting: `const customPrompt = await getSetting(SETTING_KEYS.file_summary_prompt) ?? ""`.
      d. Import `buildFileSummaryPrompt` from `@/lib/ai/prompts` (dynamic import).
      e. Import `fetchFileContents` -- it is already imported at the top of pipeline.ts from `@/lib/ai/analyze`. Reuse it to get file contents for the changed paths.
      f. For each file in the fetched contents, call `generateText` with `{ model, prompt: buildFileSummaryPrompt(file.path, file.content, customPrompt) }`. Extract the `text` result.
      g. Update the `github_files` row: `await db.update(githubFiles).set({ aiSummary: text.trim().slice(0, 500) }).where(eq(githubFiles.filePath, file.path))`. Cap at 500 chars to prevent runaway outputs.
      h. Wrap each individual file's summary generation in try/catch -- log errors per file but continue with the rest. This follows the existing pipeline pattern of per-item error isolation.
      i. Log a summary: `console.log(\`[pipeline] Generated ${count} file summaries\`)`.

    **3. Wire generateFileSummaries into runAIPipeline** in `src/lib/ai/pipeline.ts`:
    - After step 6 (processing articles) and before step 7 (updating sync_logs), add a new step:
      ```
      // 6.5. Generate file summaries for changed files (non-blocking)
      try {
        await generateFileSummaries(changedFilePaths);
      } catch (error) {
        console.error("[pipeline] File summary generation error:", error);
        // Non-fatal -- summaries are supplementary
      }
      ```
    - Note: `changedFilePaths` is already available in the function scope -- it is the same array passed as the second argument to `runAIPipeline`.

    **4. Update getArticleFileLinks query** in `src/lib/wiki/queries.ts`:
    - In the `getArticleFileLinks` function, add `aiSummary: githubFiles.aiSummary` to the select fields (joining from githubFiles which is already joined).
    - Update the `ArticleFileLink` interface to include `aiSummary: string | null`.

    **5. Update FileLinkCard** in `src/components/wiki/file-link-card.tsx`:
    - Add `aiSummary: string | null` to the `FileLinkCardProps` interface.
    - Update the card rendering: if `aiSummary` exists, display it as a `<CardDescription>` line ABOVE the relevance explanation. Use `text-sm` styling. If `relevanceExplanation` also exists, show both (aiSummary first as the file description, relevanceExplanation below as the article-specific relevance).
    - If aiSummary is null, keep the current behavior (only show relevanceExplanation).

    **6. Update TechnicalView** in `src/components/wiki/technical-view.tsx`:
    - Pass `aiSummary={link.aiSummary}` to each `<FileLinkCard>` component in the fileLinks.map.
  </action>
  <verify>
    - `npx tsc --noEmit` passes with no errors.
    - `npm run build` succeeds.
    - grep confirms `generateFileSummaries` exists in pipeline.ts and is called within `runAIPipeline`.
    - grep confirms `buildFileSummaryPrompt` exists in prompts.ts.
    - grep confirms `aiSummary` is selected in queries.ts `getArticleFileLinks`.
    - grep confirms `aiSummary` prop is used in file-link-card.tsx and passed from technical-view.tsx.
  </verify>
  <done>
    During sync, new/changed files get AI-generated summaries via the summary model. Technical View file cards display the aiSummary. Summary generation is gracefully optional (skipped if model not configured). The summary model is reusable via getSummaryModel() for any future short-output needs.
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build` completes without errors
2. TypeScript clean: `npx tsc --noEmit` has no type errors
3. Admin Settings > API Keys tab has a "Summary Model" text input in the OpenRouter section
4. Admin Settings > AI Prompts tab has a "File Summary Prompt" textarea
5. The `github_files` table has an `ai_summary` column (verify via Drizzle Studio or SQL)
6. `getSummaryModel()` is exported from `src/lib/ai/client.ts` and throws if not configured
7. `runAIPipeline` calls `generateFileSummaries` for changed file paths
8. `getArticleFileLinks` returns `aiSummary` field from joined `github_files`
9. Technical View file cards render the `aiSummary` when present
</verification>

<success_criteria>
- Admin can configure `openrouter_summary_model` and `file_summary_prompt` in settings
- The `github_files.aiSummary` column exists and stores per-file AI descriptions
- Sync pipeline generates summaries for new/changed files using the summary model
- Summary generation failures do not block sync or article processing
- Technical View file cards display the file's AI summary
- `getSummaryModel()` is a reusable function for other short-summary needs
</success_criteria>

<output>
After completion, create `.planning/phases/06-technical-view-comments-mentions/06-03-SUMMARY.md`
</output>
