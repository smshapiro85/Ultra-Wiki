---
phase: 06-technical-view-comments-mentions
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/lib/wiki/queries.ts
  - src/app/api/articles/[id]/comments/route.ts
  - src/app/api/articles/[id]/comments/[commentId]/resolve/route.ts
  - src/app/api/users/search/route.ts
  - src/components/wiki/comments-section.tsx
  - src/components/wiki/comment-thread.tsx
  - src/components/wiki/comment-card.tsx
  - src/components/wiki/comment-input.tsx
  - src/app/(wiki)/wiki/[articleSlug]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can post threaded comments on any article with Markdown rendering"
    - "Each comment shows user avatar, display name, and timestamp"
    - "User can resolve and unresolve comments"
    - "@mention autocomplete triggers when typing @ and creates mention records in the mentions table"
  artifacts:
    - path: "src/lib/wiki/queries.ts"
      provides: "getArticleComments tree-building query and searchUsers query"
      exports: ["getArticleComments", "searchUsers"]
    - path: "src/app/api/articles/[id]/comments/route.ts"
      provides: "GET (list comments tree) and POST (create comment with mention extraction)"
      exports: ["GET", "POST"]
    - path: "src/app/api/articles/[id]/comments/[commentId]/resolve/route.ts"
      provides: "POST toggle resolve/unresolve on a comment"
      exports: ["POST"]
    - path: "src/app/api/users/search/route.ts"
      provides: "GET user search for @mention autocomplete"
      exports: ["GET"]
    - path: "src/components/wiki/comments-section.tsx"
      provides: "Client component orchestrating comment list, input, and real-time updates"
      min_lines: 40
    - path: "src/components/wiki/comment-thread.tsx"
      provides: "Recursive comment rendering with reply indentation (max 1 level)"
      min_lines: 20
    - path: "src/components/wiki/comment-card.tsx"
      provides: "Single comment card with avatar, name, timestamp, Markdown body, resolve button, reply button"
      min_lines: 40
    - path: "src/components/wiki/comment-input.tsx"
      provides: "Comment textarea with react-mentions-ts @mention autocomplete"
      min_lines: 30
  key_links:
    - from: "src/components/wiki/comments-section.tsx"
      to: "/api/articles/[id]/comments"
      via: "fetch for loading and posting comments"
      pattern: "fetch.*api/articles.*comments"
    - from: "src/components/wiki/comment-input.tsx"
      to: "/api/users/search"
      via: "fetch for @mention autocomplete suggestions"
      pattern: "fetch.*api/users/search"
    - from: "src/app/api/articles/[id]/comments/route.ts"
      to: "src/lib/db/schema.ts"
      via: "INSERT into comments and mentions tables"
      pattern: "comments|mentions"
    - from: "src/app/(wiki)/wiki/[articleSlug]/page.tsx"
      to: "src/components/wiki/comments-section.tsx"
      via: "renders CommentsSection in ArticleTabs commentsContent prop"
      pattern: "CommentsSection"
---

<objective>
Build the threaded comment system with Markdown rendering, resolve/unresolve, and @mention autocomplete for the Comments tab.

Purpose: Users need to discuss article content directly on the wiki. Threaded comments with @mentions enable team collaboration without leaving the platform. Mention records are created for Phase 7 notification hooks.

Output: Fully functional Comments tab with threaded comments (one level of replies), Markdown rendering in comment bodies, user avatars and timestamps, resolve/unresolve toggle, and @mention autocomplete using react-mentions-ts that stores mention records in the database.
</objective>

<execution_context>
@/Users/michael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-technical-view-comments-mentions/06-RESEARCH.md
@.planning/phases/06-technical-view-comments-mentions/06-01-SUMMARY.md

@src/lib/db/schema.ts
@src/lib/wiki/queries.ts
@src/components/wiki/article-tabs.tsx
@src/components/wiki/article-content.tsx
@src/app/(wiki)/wiki/[articleSlug]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Comment API routes, user search API, and query functions</name>
  <files>
    src/lib/wiki/queries.ts
    src/app/api/articles/[id]/comments/route.ts
    src/app/api/articles/[id]/comments/[commentId]/resolve/route.ts
    src/app/api/users/search/route.ts
  </files>
  <action>
**0. Install react-mentions-ts:**

Run `npm install react-mentions-ts` before starting implementation.

**1. Add query functions to `src/lib/wiki/queries.ts`:**

Add `getArticleComments(articleId: string)` that:
- Queries `comments` table JOIN `users` to get userId, userName (users.name), userImage (users.image), userAvatarUrl (users.avatarUrl), contentMarkdown, isResolved, resolvedBy, resolvedAt, parentCommentId, createdAt, updatedAt
- Fetches ALL comments for the article ordered by createdAt DESC
- Builds a tree server-side: create a Map of id -> comment-with-replies, then iterate to assign children to parents. Root comments have null parentCommentId. Sort replies oldest-first within each thread (ascending createdAt).
- Returns array of root comments, each with a `replies` array
- Follow the pattern from research doc (Map-based tree building)

Add `searchUsers(query: string, limit?: number)` that:
- Queries `users` table for name or email ILIKE `%query%`
- Returns id, name, email, image, avatarUrl
- Default limit 10
- Use `sql` template for the ILIKE condition or Drizzle `ilike` from drizzle-orm

Import `comments`, `mentions` from schema as needed.

**2. Create `src/app/api/articles/[id]/comments/route.ts`:**

**GET handler:**
- Authenticate via `auth()` -- return 401 if no session
- Extract `id` (articleId) from route params
- Call `getArticleComments(id)`
- Return the tree as JSON

**POST handler:**
- Authenticate via `auth()` -- return 401 if no session
- Extract `id` (articleId) from route params
- Read JSON body: `{ contentMarkdown: string, parentCommentId?: string }`
- Validate: contentMarkdown must be non-empty and <= 10000 chars
- Insert into `comments` table: articleId, userId (from session), contentMarkdown, parentCommentId (null if not provided)
- Parse mention markup from contentMarkdown using regex `/@\[([^\]]+)\]\(([^)]+)\)/g` to extract mentioned user IDs
- For each unique mentioned user ID, INSERT into `mentions` table: commentId (the new comment ID), mentionedUserId. Use `onConflictDoNothing()` for the unique constraint.
- Return 201 with the created comment (include id, createdAt)

**3. Create `src/app/api/articles/[id]/comments/[commentId]/resolve/route.ts`:**

**POST handler:**
- Authenticate via `auth()` -- return 401 if no session
- Extract `commentId` from route params
- Fetch current comment to get isResolved state
- Toggle: if currently resolved, set isResolved=false, resolvedBy=null, resolvedAt=null. If not resolved, set isResolved=true, resolvedBy=session.user.id, resolvedAt=new Date().
- Update the comment record
- Return 200 with updated `{ isResolved, resolvedBy, resolvedAt }`

**4. Create `src/app/api/users/search/route.ts`:**

**GET handler:**
- Authenticate via `auth()` -- return 401 if no session
- Read `q` query param -- return empty array if missing or empty
- Call `searchUsers(q)`
- Return JSON array of `{ id, display }` where display = `user.name || user.email` (this format matches react-mentions-ts expectations)
  </action>
  <verify>
Run `npx tsc --noEmit` and confirm no type errors. Verify all four route files exist and export the correct handlers. Verify react-mentions-ts is in package.json dependencies.
  </verify>
  <done>
Comment CRUD API routes handle creating comments with mention extraction, listing comments as a tree, and toggling resolve/unresolve. User search API returns results in react-mentions-ts format. Query functions build comment trees server-side with user data joined.
  </done>
</task>

<task type="auto">
  <name>Task 2: Comment UI components, mention input, and article page wiring</name>
  <files>
    src/components/wiki/comment-card.tsx
    src/components/wiki/comment-thread.tsx
    src/components/wiki/comment-input.tsx
    src/components/wiki/comments-section.tsx
    src/app/(wiki)/wiki/[articleSlug]/page.tsx
  </files>
  <action>
**1. Create `src/components/wiki/comment-card.tsx` (client component):**

"use client" component. Props: `comment` object (id, userId, userName, userImage, userAvatarUrl, contentMarkdown, isResolved, resolvedBy, resolvedAt, createdAt), `currentUserId: string`, `onReply: (commentId: string) => void`, `onResolveToggle: (commentId: string) => void`, `isResolving: boolean`. Renders:
- Avatar using `userAvatarUrl || userImage` with fallback to initials (first letter of name), using shadcn Avatar component
- Display name (userName) in semibold, timestamp as relative time (e.g., "2 hours ago") using a simple helper or `toLocaleDateString`
- Comment body: process mention markup before rendering. Convert `@[display](id)` to `**@display**` using regex replacement, then render with `react-markdown` (MarkdownAsync from react-markdown) and `remark-gfm` for GFM support. Use a smaller prose class for comment text.
- Action buttons row: "Reply" button (calls onReply), "Resolve"/"Unresolve" toggle button (calls onResolveToggle, shows spinner when isResolving). If isResolved, show a green "Resolved" badge with resolvedAt timestamp.
- Resolved comments get a subtle green-tinted left border and slightly muted styling.

**2. Create `src/components/wiki/comment-thread.tsx` (client component):**

"use client" component. Props: `comment` (with replies array), `currentUserId: string`, `onReply`, `onResolveToggle`, `resolvingCommentId: string | null`. Renders:
- The root `CommentCard` for the parent comment
- If the comment has replies, render each reply as a `CommentCard` with `ml-8 border-l-2 border-muted pl-4` indentation (one level only -- no recursive nesting for replies-to-replies)
- Replies do NOT show the Reply button (enforcing one level of threading)

**3. Create `src/components/wiki/comment-input.tsx` (client component):**

"use client" component. Props: `articleId: string`, `parentCommentId?: string`, `onSubmit: (content: string) => Promise<void>`, `onCancel?: () => void`, `placeholder?: string`. Renders:
- Import `MentionsInput` and `Mention` from `react-mentions-ts`
- Controlled textarea with `value` state
- `MentionsInput` with:
  - `value` and `onChange` handler (react-mentions-ts onChange provides the markup-encoded value)
  - Styling: apply basic Tailwind classes. The MentionsInput needs custom style objects for the textarea and suggestions dropdown. Use a style object that gives the textarea standard input styling (border, rounded, padding, min-height 80px) and the suggestions list a dropdown appearance (bg-white, border, shadow, rounded)
  - `Mention` child with `trigger="@"` and `data` callback function that fetches `/api/users/search?q={query}` and maps to `{ id, display }` format
  - Suggestion item styling: show user display name in the dropdown
- Submit button ("Post Comment" or "Reply" based on parentCommentId presence)
- Cancel button if `onCancel` provided (for inline reply forms)
- Disable submit when value is empty or whitespace-only
- Clear input after successful submit
- If parentCommentId is set, show a smaller, more compact version

**4. Create `src/components/wiki/comments-section.tsx` (client component):**

"use client" component. Props: `articleId: string`, `currentUserId: string`. This is the main orchestrator. State: `comments` array (tree), `loading`, `replyingTo: string | null` (which comment is being replied to), `resolvingCommentId: string | null`.

On mount, fetch comments: `GET /api/articles/${articleId}/comments`, set state.

Render:
- Section header: "Comments" with count badge showing total comment count (flatten tree to count)
- Top-level `CommentInput` for new root comments (no parentCommentId)
- List of `CommentThread` components for each root comment
- When `replyingTo` is set, show an inline `CommentInput` below the parent comment's card (inside CommentThread, via callback)
- Empty state: "No comments yet. Start the discussion!" with an encouraging message

Event handlers:
- `handlePostComment(content: string, parentCommentId?: string)`: POST to `/api/articles/${articleId}/comments` with body `{ contentMarkdown: content, parentCommentId }`. On success, re-fetch the full comment list to update the tree. Clear replyingTo state.
- `handleResolveToggle(commentId: string)`: POST to `/api/articles/${articleId}/comments/${commentId}/resolve`. Set resolvingCommentId during request. On success, re-fetch comments.
- `handleReply(commentId: string)`: Set replyingTo to commentId (or toggle off if already set)

**5. Update `src/app/(wiki)/wiki/[articleSlug]/page.tsx`:**

Import `CommentsSection` from `@/components/wiki/comments-section`. Replace the placeholder `commentsContent` prop (from Plan 01) with:
```tsx
commentsContent={
  session?.user?.id ? (
    <CommentsSection articleId={article.id} currentUserId={session.user.id} />
  ) : (
    <p className="py-8 text-center text-muted-foreground">
      Sign in to view and post comments.
    </p>
  )
}
```

Note: Comments require authentication to view and post. This is consistent with the app being internal/private.
  </action>
  <verify>
Run `npx tsc --noEmit` and confirm no type errors. Run `npm run build` to verify the build succeeds. Navigate to an article page in the browser and verify: (1) Comments tab shows the comment input, (2) posting a comment works and appears in the list, (3) replying to a comment nests it under the parent, (4) resolve/unresolve toggle works, (5) typing @ shows user autocomplete suggestions.
  </verify>
  <done>
Comments tab is fully functional: users can post threaded comments with Markdown rendering, see avatars and timestamps, resolve/unresolve comments, and use @mention autocomplete. Mention records are created in the mentions table when a comment contains @mentions. One level of reply threading is enforced.
  </done>
</task>

</tasks>

<verification>
1. Comments tab shows threaded comments for articles that have them
2. Posting a new comment creates it and it appears immediately in the list
3. Replying to a comment creates a nested reply with indentation
4. Typing @ in the comment input shows a user autocomplete dropdown
5. Submitting a comment with @mentions creates records in the mentions table
6. Resolve/unresolve toggle works and shows visual state change
7. Comment bodies render Markdown (bold, code, links, lists)
8. Each comment shows the user's avatar, display name, and relative timestamp
9. Build passes without errors (`npm run build`)
</verification>

<success_criteria>
- Threaded comments with one level of replies fully functional
- Markdown rendering in comment bodies with GFM support
- @mention autocomplete via react-mentions-ts working with user search
- Mention records stored in mentions table on comment creation
- Resolve/unresolve toggle with visual feedback
- User avatar, display name, and timestamp on every comment
- No TypeScript errors, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/06-technical-view-comments-mentions/06-02-SUMMARY.md`
</output>
