---
phase: 06-technical-view-comments-mentions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/wiki/queries.ts
  - src/lib/github/language.ts
  - src/app/api/github/file-content/route.ts
  - src/components/wiki/technical-view.tsx
  - src/components/wiki/file-link-card.tsx
  - src/components/wiki/code-viewer-dialog.tsx
  - src/components/wiki/db-table-card.tsx
  - src/components/wiki/article-tabs.tsx
  - src/app/(wiki)/wiki/[articleSlug]/page.tsx
  - src/app/(wiki)/wiki/[articleSlug]/edit/page.tsx
  - src/app/api/articles/[id]/save/route.ts
autonomous: true

must_haves:
  truths:
    - "Technical View tab shows related source files with AI-generated relevance explanations and clickable GitHub deep links"
    - "User can click any linked source file to view its code inline in a syntax-highlighted code viewer without leaving the wiki"
    - "Technical View tab shows related DB tables with column details and relevance notes"
    - "Technical view content is editable using the same Markdown editor as articles"
  artifacts:
    - path: "src/lib/wiki/queries.ts"
      provides: "getArticleFileLinks and getArticleDbTables query functions"
      exports: ["getArticleFileLinks", "getArticleDbTables"]
    - path: "src/lib/github/language.ts"
      provides: "inferLanguage helper mapping file extensions to shiki language IDs"
      exports: ["inferLanguage"]
    - path: "src/app/api/github/file-content/route.ts"
      provides: "GET endpoint fetching file from GitHub and returning syntax-highlighted HTML via shiki"
      exports: ["GET"]
    - path: "src/components/wiki/technical-view.tsx"
      provides: "Server component rendering file links and DB tables sections with edit button"
      min_lines: 40
    - path: "src/components/wiki/file-link-card.tsx"
      provides: "Card for each linked file with GitHub deep link and View Code button"
      min_lines: 20
    - path: "src/components/wiki/code-viewer-dialog.tsx"
      provides: "Client component dialog displaying syntax-highlighted file content"
      min_lines: 30
    - path: "src/components/wiki/db-table-card.tsx"
      provides: "Card for each related DB table with column details"
      min_lines: 20
    - path: "src/components/wiki/article-tabs.tsx"
      provides: "Updated tab system with commentsContent prop and enabled Comments tab"
  key_links:
    - from: "src/components/wiki/file-link-card.tsx"
      to: "/api/github/file-content"
      via: "fetch on View Code click"
      pattern: "fetch.*api/github/file-content"
    - from: "src/components/wiki/technical-view.tsx"
      to: "src/lib/wiki/queries.ts"
      via: "getArticleFileLinks and getArticleDbTables calls"
      pattern: "getArticleFileLinks|getArticleDbTables"
    - from: "src/app/(wiki)/wiki/[articleSlug]/page.tsx"
      to: "src/components/wiki/technical-view.tsx"
      via: "renders TechnicalView component in ArticleTabs"
      pattern: "TechnicalView"
    - from: "src/app/api/github/file-content/route.ts"
      to: "src/lib/github/client.ts"
      via: "getOctokit and getRepoConfig for GitHub API"
      pattern: "getOctokit|getRepoConfig"
---

<objective>
Build the Technical View tab with structured file links, inline code viewer, DB table display, GitHub deep links, and editing support.

Purpose: Users need to see how articles relate to source code and database tables. The AI pipeline already populates `article_file_links` and `article_db_tables` during sync -- this plan surfaces that data in a structured UI with interactive code viewing.

Output: Fully functional Technical View tab showing file links (with View Code dialog and GitHub deep links), DB tables (with column details), and an Edit button for technical view content. The article-tabs component is also updated to accept comments content (preparing for Plan 02).
</objective>

<execution_context>
@/Users/michael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-technical-view-comments-mentions/06-RESEARCH.md

@src/lib/db/schema.ts
@src/lib/wiki/queries.ts
@src/lib/wiki/actions.ts
@src/lib/github/client.ts
@src/components/wiki/article-tabs.tsx
@src/components/wiki/article-content.tsx
@src/app/(wiki)/wiki/[articleSlug]/page.tsx
@src/app/(wiki)/wiki/[articleSlug]/edit/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Data queries, language helper, and GitHub file content API route</name>
  <files>
    src/lib/wiki/queries.ts
    src/lib/github/language.ts
    src/app/api/github/file-content/route.ts
  </files>
  <action>
**1. Add query functions to `src/lib/wiki/queries.ts`:**

Add `getArticleFileLinks(articleId: string)` -- query `article_file_links` JOIN `github_files` to get filePath, relevanceExplanation, githubFileId for a given article. Return array of objects.

Add `getArticleDbTables(articleId: string)` -- query `article_db_tables` for tableName, columns (jsonb), relevanceExplanation for a given article. Return array of objects.

Import `articleFileLinks`, `articleDbTables`, `githubFiles` from schema. Follow the existing query patterns in queries.ts (getDb(), .select().from().where() with Drizzle).

**2. Create `src/lib/github/language.ts`:**

Export `inferLanguage(filePath: string): string` function that maps file extensions to shiki language identifiers. Handle common extensions: ts, tsx, js, jsx, py, rb, rs, go, java, css, scss, html, json, yaml, yml, toml, md, sql, sh, dockerfile, xml, svg, env, prisma, etc. Also handle exact filename matches: Dockerfile, Makefile, .env, .gitignore. Default to "text" for unknown extensions. Use the EXT_MAP and FILENAME_MAP pattern from the research doc.

**3. Create `src/app/api/github/file-content/route.ts`:**

GET endpoint that:
- Authenticates via `auth()` -- return 401 if no session
- Reads `path` query param -- return 400 if missing
- Uses `getOctokit()` and `getRepoConfig()` from `@/lib/github/client`
- Uses `withRetry()` from `@/lib/github/retry` to fetch file via `octokit.repos.getContent()`
- Validates response is a file (not array/directory) -- return 400 if not
- Decodes base64 content via `Buffer.from(data.content, "base64").toString("utf-8")`
- Enforces file size limit: if decoded content > 500KB, return JSON `{ tooLarge: true, path }` with 200 status (not error -- client handles gracefully)
- Uses `inferLanguage()` to determine the shiki language
- Calls `codeToHtml(content, { lang, themes: { light: "github-light", dark: "github-dark" }, defaultColor: false })` from shiki
- Returns JSON: `{ html, content, lang, path: filePath }`
- Wraps in try/catch, returns 500 on errors with `{ error: message }`

Note: Use `import { codeToHtml } from "shiki"` (shiki is already installed). Use `import { auth } from "@/lib/auth"`.
  </action>
  <verify>
Run `npx tsc --noEmit` and confirm no type errors in the three modified/created files. Verify the API route file exists and exports GET.
  </verify>
  <done>
getArticleFileLinks and getArticleDbTables return data from the existing populated tables. The file content API route fetches a file from GitHub, highlights with shiki, and returns HTML. inferLanguage correctly maps common file extensions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Technical View UI components, tabs update, and article page wiring</name>
  <files>
    src/components/wiki/file-link-card.tsx
    src/components/wiki/code-viewer-dialog.tsx
    src/components/wiki/db-table-card.tsx
    src/components/wiki/technical-view.tsx
    src/components/wiki/article-tabs.tsx
    src/app/(wiki)/wiki/[articleSlug]/page.tsx
    src/app/(wiki)/wiki/[articleSlug]/edit/page.tsx
  </files>
  <action>
**1. Create `src/components/wiki/file-link-card.tsx` (client component):**

"use client" component. Props: `filePath: string`, `relevanceExplanation: string | null`, `githubUrl: string`. Renders a Card (from shadcn) with:
- File path displayed with `FileCode` icon from lucide-react
- Relevance explanation as muted text
- Two action buttons: "View Code" (triggers code viewer dialog) and "Open on GitHub" (external link with `ExternalLink` icon, opens in new tab)
- The "View Code" button manages local state for opening the `CodeViewerDialog`

**2. Create `src/components/wiki/code-viewer-dialog.tsx` (client component):**

"use client" component. Props: `filePath: string`, `open: boolean`, `onOpenChange: (open: boolean) => void`. Renders a shadcn Dialog/Sheet with:
- Title showing the file path
- On open, fetches `/api/github/file-content?path={filePath}`
- Shows a loading skeleton while fetching
- If response has `tooLarge: true`, shows message "File too large for inline view" with a "View on GitHub" fallback link
- If successful, renders the returned HTML via `dangerouslySetInnerHTML` in a div with `overflow-auto max-h-[70vh]` and the existing shiki CSS class support
- Error state with retry button
- Dialog should be large: `max-w-4xl` or use Sheet (side panel) for better code reading

**3. Create `src/components/wiki/db-table-card.tsx` (server-compatible component):**

Props: `tableName: string`, `columns: Array<{ name: string; description: string }> | null`, `relevanceExplanation: string | null`. Renders a Card with:
- Table name with `Database` icon from lucide-react
- Relevance explanation as muted text
- If columns exist, render them in a small table or list with column name (monospace) and description
- Handle null/empty columns gracefully

**4. Create `src/components/wiki/technical-view.tsx` (async server component):**

Import `getArticleFileLinks`, `getArticleDbTables` from queries.ts. Import `getRepoConfig` from `@/lib/github/client`. Props: `articleId: string`, `articleSlug: string`, `technicalViewMarkdown: string | null`. Renders:
- If `technicalViewMarkdown` exists, render it via `ArticleContent` component (reuse existing markdown renderer) at the top
- "Edit Technical View" button (Link to `/wiki/{articleSlug}/edit?mode=technical`) visible to all authenticated users
- **Source Files** section: heading "Related Source Files" with count badge, then map over file links rendering `FileLinkCard` for each. Build GitHub deep link as `https://github.com/{owner}/{repo}/blob/{branch}/{filePath}` using `getRepoConfig()`. Empty state: "No source files linked to this article."
- **DB Tables** section: heading "Related Database Tables" with count badge, then map over DB tables rendering `DbTableCard` for each. Empty state: "No database tables linked to this article."

**5. Update `src/components/wiki/article-tabs.tsx`:**

Add `commentsContent: React.ReactNode` to the props interface. Enable the Comments tab (remove `disabled` from the TabsTrigger). Replace the placeholder content in the `TabsContent value="comments"` with `{commentsContent}`. Keep all other tabs as-is.

**6. Update `src/app/(wiki)/wiki/[articleSlug]/page.tsx`:**

Import `TechnicalView` from `@/components/wiki/technical-view`. Replace the current `technicalView` prop in `ArticleTabs` with `<TechnicalView articleId={article.id} articleSlug={article.slug} technicalViewMarkdown={article.technicalViewMarkdown} />`. Add `commentsContent` prop passing a placeholder for now: `<p className="py-8 text-center text-muted-foreground">Comments coming soon.</p>`.

**7. Update `src/app/(wiki)/wiki/[articleSlug]/edit/page.tsx`:**

Read the `mode` search param from the URL (`searchParams`). If `mode=technical`, load the article's `technicalViewMarkdown` instead of content markdown/json. Pass to `EditorLoader` with appropriate props. On save, the editor should save to `technicalViewMarkdown` field. Add a `mode` prop to EditorLoader or handle via a query param that the save API route reads. The simplest approach: add a `saveMode` prop to EditorLoader ("article" | "technical") that tells the save API to update `technicalViewMarkdown` instead of `contentMarkdown`. Update the save API route `src/app/api/articles/[id]/save/route.ts` to accept an optional `mode: "technical"` in the request body -- when present, update `technicalViewMarkdown` and skip contentJson/version tracking (technical view edits are simpler).

Also update the save route to handle mode=technical:
- Read `mode` from request body (default "article")
- If mode is "technical": update only `articles.technicalViewMarkdown` and `articles.updatedAt`. Create a version record with changeSummary "Technical view edited" and changeSource "human_edited". Skip optimistic locking for technical view (simpler).
- If mode is "article": existing behavior unchanged.
  </action>
  <verify>
Run `npx tsc --noEmit` and confirm no type errors. Run `npm run build` to verify the build succeeds. Navigate to an article page in the browser and verify: (1) Technical View tab shows file links and DB tables, (2) Comments tab is enabled (shows placeholder), (3) History tab still works.
  </verify>
  <done>
Technical View tab renders structured file link cards with GitHub deep links and View Code dialog, DB table cards with column details, existing technicalViewMarkdown rendered as formatted text, and an Edit button. Comments tab is enabled and accepts content (placeholder for Plan 02). The code viewer dialog fetches and displays syntax-highlighted file content on demand.
  </done>
</task>

</tasks>

<verification>
1. Technical View tab shows file links with relevance explanations and GitHub deep links for articles that have linked source files
2. Clicking "View Code" on a file link opens a dialog with syntax-highlighted code fetched from GitHub
3. DB tables section shows table names, column details, and relevance notes
4. "Edit Technical View" button navigates to the edit page in technical mode
5. Comments tab is enabled (no longer disabled) and shows placeholder content
6. Build passes without errors (`npm run build`)
</verification>

<success_criteria>
- Technical View tab fully functional with file links, code viewer, DB tables, and GitHub deep links
- Code viewer dialog loads file content on-demand with shiki highlighting
- Technical view is editable via the existing BlockNote editor
- Comments tab enabled and ready for Plan 02 content
- No TypeScript errors, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/06-technical-view-comments-mentions/06-01-SUMMARY.md`
</output>
