---
phase: 09-documentation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/application-guide.md
  - docs/ai-pipeline.md
  - docs/ultrawiki-spec.md
autonomous: false
gap_closure: false

must_haves:
  truths:
    - "A comprehensive docs/application-guide.md exists that explains every major feature of the application"
    - "The documentation covers all 8 phases of built functionality: auth, admin/sync, AI pipeline, wiki viewer, editing/versioning, technical view/comments, Ask AI/notifications, prompt refinement"
    - "Each section in the documentation is verified against the actual codebase — it describes what was actually built, not just what was planned"
    - "The document includes architecture overview (tech stack, project structure, route groups, key directories)"
    - "The document includes a getting started section (prerequisites, environment variables, Docker setup, first-time configuration flow)"
    - "The document covers the AI pipeline end-to-end: sync → analysis → generation → merge → article storage"
    - "The document covers admin configuration: settings, GitHub repo setup, API keys, AI prompts, sync scheduling"
    - "The document covers user-facing features: wiki navigation, article viewing, editing, version history, search, bookmarks, comments, Ask AI"
    - "The document is written for someone new to the project — a developer or team member who needs to understand how the app works"
    - "All existing docs (docs/ai-pipeline.md, docs/ultrawiki-spec.md) have been reviewed against the codebase and updated to reflect the current state — no stale or inaccurate information remains"
  artifacts:
    - path: "docs/application-guide.md"
      provides: "Comprehensive application documentation covering architecture, setup, all features, and admin configuration"
    - path: "docs/ai-pipeline.md"
      provides: "Reviewed and updated AI pipeline deep-dive documentation"
    - path: "docs/ultrawiki-spec.md"
      provides: "Reviewed and updated original product specification"
---

<objective>
Create comprehensive application documentation that serves as the single reference for understanding how Ultra Wiki works. The application is feature-complete across 8 phases (32 plans). This plan produces a thorough `docs/application-guide.md` that:

1. **Verifies** that what was planned in each phase actually matches the built code
2. **Documents** every major feature, user flow, and configuration option
3. **Explains** the architecture and project structure for new developers

The documentation should be written for a developer or team member who has never seen the codebase — they should be able to read this document and understand what the application does, how it's structured, how to set it up, and how every feature works.
</objective>

## Task 1: Audit codebase against all phases (MANUAL — read-only verification)

**What:** Walk through every phase's plans and summaries. For each phase, verify the key features and files exist in the codebase. Note any gaps between what was planned and what was actually built (deferred features, changed approaches, extra features added).

**Audit checklist by phase:**

- **Phase 1** — Foundation & Authentication
  - Drizzle schema with all tables in `src/lib/db/schema.ts`
  - NextAuth v5 config with Google OIDC
  - Login page, user management, profile editing
  - Docker infrastructure (Dockerfile, docker-compose)

- **Phase 2** — Admin Settings & GitHub Sync
  - Admin settings dashboard with tabbed UI
  - site_settings key-value storage
  - GitHub file tree with inclusion checkboxes
  - Incremental sync engine with concurrency lock
  - Cron-triggered sync scheduling

- **Phase 3** — AI Processing Pipeline
  - AI client (Vercel AI SDK + OpenRouter)
  - Zod schemas for structured AI output
  - Code analysis and article generation
  - Three-way merge with conflict detection
  - Pipeline orchestrator wiring

- **Phase 4** — Wiki Viewer
  - Category/article sidebar navigation
  - Article rendering with syntax highlighting
  - Table of contents from headings
  - Tab system (Article, Technical, Comments, History)
  - Full-text search with tsvector
  - Home dashboard with recent updates and bookmarks

- **Phase 5** — Article Editing & Version History
  - BlockNote WYSIWYG editor
  - Image upload/paste with compression
  - Version history with diff viewer and rollback
  - AI review annotations
  - Admin review queue
  - Draft-as-version (server-side auto-save)
  - Version preview slide-out
  - Light/dark mode theme toggle

- **Phase 6** — Technical View, Comments & Mentions
  - Technical view tab (source files, DB tables, inline code viewer)
  - Technical view editing
  - Threaded comments with resolve/unresolve
  - @mention autocomplete
  - AI file summaries (summary model)

- **Phase 7** — Ask AI & Notifications
  - Global Ask AI chat panel
  - Page-level Ask AI with article context
  - Conversation persistence
  - Slack DM and SendGrid email notifications
  - Notification preference configuration

- **Phase 8** — AI Prompt Refinement
  - Deterministic category strategy rules
  - No-title-duplication in prompts
  - Heading hierarchy (H1 sections, reduced CSS)
  - Default prompt text in settings UI
  - Live sync log via SSE
  - File tree expand/collapse/search

**Output:** Notes on any discrepancies (used internally, not published). These inform what the documentation says vs. what was originally planned.

## Task 2: Review and update existing documentation

**What:** Review every existing file in `docs/` against the actual codebase. Update any stale, inaccurate, or incomplete information so all documentation reflects the current state of the application.

**Files to review:**

### `docs/ultrawiki-spec.md`
The original product specification (v0.2.2-draft, dated 2026-02-13). This was written before most of the implementation. Review for:
- **Implementation checklist accuracy** — mark items as complete or note where the implementation diverged from the spec
- **Schema changes** — any tables, columns, or relationships added/removed during implementation that aren't reflected
- **Feature descriptions** — anywhere the spec describes behavior differently from how it was actually built (e.g., content storage lifecycle changed to dual-format, pgboss replaced with cron, etc.)
- **Tech stack updates** — any libraries added or removed during development not listed in the spec
- **Version bump** — update version number and "Last Updated" date to reflect current state

### `docs/ai-pipeline.md`
A deep-dive on the AI article generation pipeline. Review for:
- **Pipeline stages** — verify the described multi-stage flow (summarize → plan → analyze → generate) matches the actual code in `src/lib/ai/pipeline.ts`
- **Thresholds** — verify the fast-path threshold (25 files / 50K chars) and other constants match what's in code
- **Directory compression logic** — verify the merge/split rules (3-file minimum, 30-file split) match implementation
- **Configuration section** — verify the admin prompts listed match what's actually configurable
- **Scaling characteristics table** — verify these numbers are still reasonable based on the implementation
- **Category strategy** — the Phase 8 prompt refinement added deterministic category rules that may not be reflected here
- **Merge strategy** — verify the post-analysis section accurately describes create vs. update vs. merge behavior

**For each file:** Fix any inaccuracies in-place. Add missing information. Remove anything that describes features or behavior that doesn't exist. Update dates and version numbers.

## Task 3: Write `docs/application-guide.md`

**What:** Create the comprehensive documentation file. Structure:

### Document Outline

1. **Overview**
   - What Ultra Wiki is and the problem it solves
   - Key principles (AI + human coexistence, open-source first, single-tenant)

2. **Architecture**
   - Tech stack (Next.js 15, Drizzle ORM, Neon Postgres, BlockNote, Vercel AI SDK, OpenRouter)
   - Project structure (`src/app/`, `src/components/`, `src/lib/`)
   - Route groups: `(wiki)`, `(admin)`, `(auth)`, `api/`
   - Key directories and what they contain
   - Content storage lifecycle (dual-format: Markdown for AI, BlockNote JSON for editing)

3. **Getting Started**
   - Prerequisites (Node.js, Docker, Neon Postgres database, Google OAuth credentials, OpenRouter API key)
   - Environment variables reference (DATABASE_URL, NEXTAUTH_SECRET, GOOGLE_CLIENT_ID/SECRET, CRON_SECRET, etc.)
   - Docker setup (`docker-compose up`)
   - First-time configuration flow (first user → admin, configure settings)

4. **Authentication & Users**
   - Google OIDC login flow
   - Role system (admin/user), first-user-is-admin
   - User profile (display name, avatar, theme preference)
   - User management (admin promotes/demotes)

5. **Admin Configuration**
   - Settings dashboard (General, API Keys, AI Prompts tabs)
   - GitHub repository configuration (URL, branch, PAT)
   - OpenRouter API key and model selection (primary + summary model)
   - AI prompts (analysis, article style, file summary)
   - Notification configuration (Slack bot token, SendGrid API key)

6. **GitHub Sync**
   - How sync works (incremental SHA comparison)
   - Manual sync with live log (SSE streaming)
   - Scheduled sync (cron-triggered API route)
   - File tree management (include/exclude, expand/collapse, search)
   - New files review workflow
   - Sync history and job status

7. **AI Pipeline**
   - Overview of the pipeline flow (sync → analysis → generation → merge → storage)
   - Fast path vs. multi-stage pipeline (threshold: 25 files / 50K chars)
   - Stage 1: File summarization
   - Stage 2: Planning (directory compression, group creation)
   - Stage 3: Group analysis (structured output with Zod schemas)
   - Article generation with category strategy
   - Reference to `docs/ai-pipeline.md` for deep technical detail

8. **Content Merge Strategy**
   - AI-only articles (direct overwrite)
   - Human-edited articles (three-way merge via node-diff3)
   - Conflict detection and review banner
   - AI review annotations (post-merge semantic review)

9. **Wiki Navigation & Search**
   - Collapsible sidebar with category/article tree
   - Category pages
   - Breadcrumb navigation
   - Full-text search (tsvector, debounced, highlighted results)
   - Home dashboard (recent updates, bookmarks)

10. **Article Viewing**
    - Markdown rendering with syntax highlighting (shiki dual-theme)
    - Table of contents (auto-generated from headings)
    - Metadata sidebar (last updated, editor, AI/human badge, category)
    - Tab system (Article, Technical View, Comments, History)
    - Bookmark toggle

11. **Article Editing**
    - BlockNote WYSIWYG editor (headings, bold, italic, code, links, tables, lists, images)
    - Image upload/paste with auto-compression (sharp: max 1200x1200, JPEG quality 80)
    - Auto-save drafts (server-side, 3s debounce, one draft per user per article)
    - Optimistic locking (timestamp comparison prevents stale saves)
    - Admin regenerate article (re-fetch source, re-run AI)

12. **Version History**
    - Version tracking (every save, AI update, merge, draft)
    - Change source filtering (AI, human, merged, draft)
    - Diff viewer (inline and side-by-side)
    - Version preview slide-out (view rendered content without restoring)
    - Rollback to any previous version

13. **Technical View**
    - Related source files with AI-generated relevance explanations
    - Clickable GitHub deep links
    - Inline syntax-highlighted code viewer (server-side shiki)
    - Related database tables with column details
    - AI file summaries on file cards
    - Technical view editing (same BlockNote editor)

14. **Comments & Mentions**
    - Threaded comments with Markdown rendering
    - Resolve/unresolve comments
    - @mention autocomplete (react-mentions-ts)
    - Mention records for notification triggers

15. **Ask AI**
    - Global Ask AI panel (wiki-wide context)
    - Page-level Ask AI (article + technical view + source files as context)
    - Streaming Markdown responses
    - Conversation persistence (continue, new, delete)

16. **Notifications**
    - Slack DM notifications
    - SendGrid email notifications
    - Trigger events: @mentions, new comments, AI sync updates, conflict flags
    - User preference configuration

17. **Database Schema**
    - Table overview (purpose of each table)
    - Key relationships (articles ↔ categories, articles ↔ file_links, articles ↔ versions, etc.)

18. **API Routes Reference**
    - List of all API routes with method, path, and purpose

**Style guidelines:**
- Write for a developer audience — technical but accessible
- Use code blocks for file paths, environment variables, and commands
- Include the actual route paths (e.g., `/admin/settings`, `/wiki/[articleSlug]`)
- Cross-reference `docs/ai-pipeline.md` for deep AI pipeline details rather than duplicating
- Cross-reference `docs/ultrawiki-spec.md` as the original spec

## Verification

After writing, verify:
- [ ] Every feature from all 8 phases is represented in the application guide
- [ ] File paths and route paths mentioned in the docs actually exist in the codebase
- [ ] Environment variable names match what the code actually reads
- [ ] The getting started flow is accurate (Docker, env vars, first-time setup)
- [ ] No features are described that don't actually exist in the code
- [ ] `docs/ai-pipeline.md` accurately reflects the current pipeline implementation (stages, thresholds, category strategy)
- [ ] `docs/ultrawiki-spec.md` reflects the as-built state (schema, features, tech stack, implementation checklist)
- [ ] All three docs files are internally consistent — no contradictions between them
- [ ] Cross-references between docs are valid (application-guide links to ai-pipeline.md and ultrawiki-spec.md)
